{% sw_extends '@Storefront/storefront/component/product/card/box-standard.html.twig' %}

{% block component_product_box %}
<style>
.raven-card {
    background: white;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}
.raven-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    border-color: #D4A847;
}
.raven-card:hover .raven-card-image img {
    transform: scale(1.08);
}
.raven-card:hover .raven-cart-btn {
    background: linear-gradient(135deg, #F2B90D 0%, #D4A847 100%);
    color: #1f2937;
    transform: scale(1.1);
}
.raven-card-image {
    height: 320px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
    padding: 24px;
}
.raven-card-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.raven-card-body {
    padding: 1.25rem 1.5rem;
    background: white;
}
.raven-price {
    color: #E53935;
    font-weight: 700;
    font-size: 1.25rem;
    font-family: 'Inter', sans-serif;
}
.raven-manufacturer {
    color: #374151;
    font-size: 0.8125rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}
.raven-product-name {
    color: #374151;
    font-size: 0.9375rem;
    font-weight: 500;
    text-decoration: none;
    display: block;
    transition: color 0.2s;
}
.raven-product-name:hover {
    color: #D4A847;
}
.raven-cart-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: #f3f4f6;
    border: none;
    color: #6b7280;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}
.raven-availability {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.raven-availability.available {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
}
.raven-availability.unavailable {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}
</style>

<div class="card product-box box-{{ layout }} raven-card">
    {% block component_product_box_content %}
    {# Image Section #}
    {% block component_product_box_image %}
    <a href="{{ seoUrl('frontend.detail.page', {'productId': product.id}) }}" class="raven-card-image" title="{{ product.translated.name }}">
        {% if product.cover.media %}
            {% sw_thumbnails 'product-image-thumbnails' with {
                media: product.cover.media,
                sizes: { 'default': '300px' },
                attributes: {
                    'alt': product.cover.media.translated.alt ?: product.translated.name,
                    'title': product.cover.media.translated.title ?: product.translated.name
                }
            } %}
        {% else %}
            <div style="color: #d1d5db;">
                {% sw_icon 'placeholder' style { 'size': 'lg' } %}
            </div>
        {% endif %}
    </a>
    {% endblock %}

    {# Content Section #}
    {% block component_product_box_info %}
    <div class="raven-card-body">
        {# Price - Swiss Format: CHF 3'150 #}
        {% block component_product_box_price %}
        <div class="raven-price" style="margin-bottom: 0.5rem;">
            {% if product.calculatedPrice %}
                {% set priceValue = product.calculatedPrice.unitPrice %}
                {% set cents = ((priceValue * 100) % 100)|round %}
                CHF {% if cents == 0 %}{{ priceValue|number_format(0, '.', "'") }}{% else %}{{ priceValue|number_format(2, '.', "'") }}{% endif %}
            {% endif %}
        </div>
        {% endblock %}

        {# Star Ratings - Use ratingAverage which is available in listings #}
        {% if product.ratingAverage and product.ratingAverage > 0 %}
            {% set rating = product.ratingAverage|round %}
            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 0.5rem;">
                <div style="display: flex; gap: 2px;">
                    {% for i in 1..5 %}
                        {% if rating >= i %}
                            <svg style="width: 14px; height: 14px; color: #D4A847;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        {% else %}
                            <svg style="width: 14px; height: 14px; color: #D1D5DB;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        {% endif %}
                    {% endfor %}
                </div>
                <span style="font-size: 0.75rem; color: #6b7280;">({{ product.ratingAverage|number_format(1) }})</span>
            </div>
        {% endif %}

        {# Product Name & Actions Row #}
        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
            {# Product Name #}
            <div style="flex: 1; min-width: 0;">
                {% block component_product_box_name %}
                {% if product.manufacturer and product.manufacturer.translated.name %}
                {% set manufacturerName = product.manufacturer.translated.name %}
                {# Slugify: lowercase, spaces to hyphens, remove special chars #}
                {% set manufacturerSlug = manufacturerName|lower|replace({' ': '-', '_': '-', '.': '', ',': '', '&': '', '(': '', ')': '', '/': '', '\\': '', "'": '', '"': '', 'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}) %}
                <a href="/{{ manufacturerSlug }}" class="raven-manufacturer" style="font-weight: 700; color: #374151; text-decoration: none; display: block;">{{ manufacturerName }}</a>
                {% endif %}
                <a href="{{ seoUrl('frontend.detail.page', {'productId': product.id}) }}" class="raven-product-name">
                    {{ product.translated.name }}
                </a>
                {% endblock %}
            </div>

            {# Actions: Availability + Cart stacked vertically #}
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                {# Availability #}
                {% block component_product_box_availability %}
                <span class="raven-availability {% if product.availableStock > 0 or product.isCloseout == false %}available{% else %}unavailable{% endif %}" title="{% if product.availableStock > 0 or product.isCloseout == false %}Verfügbar{% else %}Nicht verfügbar{% endif %}">
                    <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;">
                        {% if product.availableStock > 0 or product.isCloseout == false %}
                        <path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        {% else %}
                        <path d="M6 18L18 6M6 6l12 12" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        {% endif %}
                    </svg>
                </span>
                {% endblock %}

                {# Cart Button #}
                {% block component_product_box_action %}
                <form action="{{ path('frontend.checkout.line-item.add') }}" method="post" data-add-to-cart="true">
                    <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1"/>
                    <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1"/>
                    <button type="submit" class="raven-cart-btn" title="In den Warenkorb" aria-label="In den Warenkorb">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" style="width: 20px; height: 20px;"><path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/></svg>
                    </button>
                </form>
                {% endblock %}
            </div>
        </div>
    </div>
    {% endblock %}
    {% endblock %}
</div>
{% endblock %}
