{% sw_extends '@Storefront/storefront/component/product/card/box-standard.html.twig' %}

{% block component_product_box %}
<div class="card product-box box-{{ layout }} raven-product-card group" style="background: white;">
    {% block component_product_box_content %}
    <div class="card-body">
        {% block component_product_box_image %}
        <div class="product-image-wrapper" style="height: 220px; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            <a href="{{ seoUrl('frontend.detail.page', {'productId': product.id}) }}"
               title="{{ product.translated.name }}"
               style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
                {% if product.cover.media %}
                    {% sw_thumbnails 'product-image-thumbnails' with {
                        media: product.cover.media,
                        sizes: {
                            'default': '300px'
                        },
                        attributes: {
                            'style': 'max-width: 100%; max-height: 100%; object-fit: contain; padding: 1rem; transition: transform 0.3s ease;',
                            'alt': product.cover.media.translated.alt ?: product.translated.name,
                            'title': product.cover.media.translated.title ?: product.translated.name
                        }
                    } %}
                {% else %}
                    {% sw_icon 'placeholder' style { 'size': 'fluid' } %}
                {% endif %}
            </a>
        </div>
        {% endblock %}

        {% block component_product_box_info %}
        <div class="product-info" style="padding: 1rem;">
            {# Category Label #}
            {% block component_product_box_category %}
            <p style="font-size: 0.75rem; color: #6B7280; margin: 0 0 0.25rem 0;">
                Waffe
            </p>
            {% endblock %}

            {# Price #}
            {% block component_product_box_price %}
            <div style="color: #E53935; font-weight: 600; font-size: 1.125rem; margin-bottom: 0.5rem;">
                {% if product.calculatedPrice %}
                    {% set price = product.calculatedPrice %}
                    {% if price.unitPrice %}
                        {% set priceValue = price.unitPrice %}
                        {% set cents = ((priceValue * 100) % 100)|round %}
                        {% if cents == 0 %}
                            {{ priceValue|number_format(0, '.', '') }}.–
                        {% else %}
                            {{ priceValue|number_format(2, '.', '') }}
                        {% endif %}
                    {% endif %}
                {% endif %}
            </div>
            {% endblock %}

            {# Product Name and Cart/Availability Section #}
            <div style="display: flex; align-items: flex-end; justify-content: space-between; gap: 0.5rem;">
                {# Product Name with Manufacturer #}
                <div style="flex: 1; min-width: 0;">
                    {% block component_product_box_name %}
                    {% set productName = product.translated.name %}
                    {% set manufacturerName = product.manufacturer.translated.name|default('') %}
                    <a href="{{ seoUrl('frontend.detail.page', {'productId': product.id}) }}"
                       style="display: block; color: #374151; text-decoration: none; font-size: 0.875rem;"
                       title="{{ manufacturerName ? manufacturerName ~ ' ' ~ productName : productName }}">
                        {% if manufacturerName %}<strong>{{ manufacturerName }}</strong> {% endif %}{{ productName }}
                    </a>
                    {% endblock %}
                </div>

                {# Availability + Cart Button (stacked, center aligned) #}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem;">
                    {# Availability Indicator - Dynamic based on stock #}
                    {% block component_product_box_availability %}
                    {% if product.availableStock > 0 or product.isCloseout == false %}
                    <span style="width: 20px; height: 20px; border-radius: 50%; background: #22C55E; display: flex; align-items: center; justify-content: center;" title="Verfügbar">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;" aria-hidden="true">
                            <path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    {% else %}
                    <span style="width: 20px; height: 20px; border-radius: 50%; background: #EF4444; display: flex; align-items: center; justify-content: center;" title="Nicht verfügbar">
                        <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;" aria-hidden="true">
                            <path d="M6 18L18 6M6 6l12 12" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </span>
                    {% endif %}
                    {% endblock %}

                    {# Cart Button #}
                    {% block component_product_box_action %}
                    <form action="{{ path('frontend.checkout.line-item.add') }}"
                          method="post"
                          class="buy-widget"
                          data-add-to-cart="true">
                        <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1"/>
                        <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1"/>

                        <button type="submit"
                                style="width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 0.375rem; background: transparent; border: none; color: #374151; cursor: pointer;"
                                title="In den Warenkorb"
                                aria-label="In den Warenkorb">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" style="width: 22px; height: 22px;" aria-hidden="true">
                                <path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/>
                            </svg>
                        </button>
                    </form>
                    {% endblock %}
                </div>
            </div>
        </div>
        {% endblock %}
    </div>
    {% endblock %}
</div>
{% endblock %}
