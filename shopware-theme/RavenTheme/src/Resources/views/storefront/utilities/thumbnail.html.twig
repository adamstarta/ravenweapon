{% sw_extends "@Storefront/storefront/utilities/thumbnail.html.twig" %}

{% block thumbnail_utility_img %}
    {# Fix HTTP to HTTPS for srcset URLs - required because Cloudflare proxy terminates SSL #}
    {% if srcsetValues is defined %}
        {% set fixedSrcsetValues = [] %}
        {% for srcsetValue in srcsetValues %}
            {% set fixedSrcsetValues = fixedSrcsetValues|merge([srcsetValue|replace({"http://ravenweapon.ch": "https://ravenweapon.ch", "http://developing.ravenweapon.ch": "https://developing.ravenweapon.ch"})]) %}
        {% endfor %}
        {% set srcsetValues = fixedSrcsetValues %}
    {% endif %}

    {# PageSpeed Optimization: Add lazy loading for all product images #}
    {# This reduces initial page load by deferring off-screen images #}
    {% if attributes is defined %}
        {% set optimizedAttrs = attributes %}

        {# Add lazy loading if not already set #}
        {% if optimizedAttrs.loading is not defined %}
            {% set optimizedAttrs = optimizedAttrs|merge({ 'loading': 'lazy' }) %}
        {% endif %}

        {# Add decoding async for all images #}
        {% if optimizedAttrs.decoding is not defined %}
            {% set optimizedAttrs = optimizedAttrs|merge({ 'decoding': 'async' }) %}
        {% endif %}

        {% set attributes = optimizedAttrs %}
    {% endif %}

    {{ parent() }}
{% endblock %}
