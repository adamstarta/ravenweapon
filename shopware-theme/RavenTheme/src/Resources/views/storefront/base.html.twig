{% sw_extends '@Storefront/storefront/base.html.twig' %}

{% block base_head_title %}
    <title>Raven Weapon AG</title>
{% endblock %}

{% block base_head %}
    {{ parent() }}
    <script>document.title = 'Raven Weapon AG';</script>
    <style>
        /* Hide manufacturer name in product cards */
        .product-info a strong,
        .card-body a strong,
        .cms-element-product-listing a strong {
            display: none !important;
        }
        /* Hide flash messages */
        .alert-content,
        .alert.alert-info,
        .alert.alert-success {
            display: none !important;
        }
        /* Hide dark CMS "coming soon" blocks - we use clean version */
        .raven-hide-dark-cms {
            display: none !important;
        }
    </style>
    <script>
    /* Hide dark "SOON" CMS blocks globally */
    (function() {
        function hideDarkSoonBlocks() {
            // Target cms-element-text with dark backgrounds containing "Bald verfügbar"
            document.querySelectorAll('.cms-element-text').forEach(function(el) {
                var text = el.textContent || '';
                if (text.indexOf('Bald verfügbar') !== -1) {
                    // Look for dark background inline styles (#1a1a1a, #2xxx, #3xxx, etc)
                    var darkDiv = el.querySelector('[style*="background:#1"]') ||
                                  el.querySelector('[style*="background: #1"]') ||
                                  el.querySelector('[style*="background:#2"]') ||
                                  el.querySelector('[style*="background: #2"]');
                    if (darkDiv) {
                        el.style.display = 'none';
                    }
                }
            });
            // Also target parent cms-block if it contains dark coming soon
            document.querySelectorAll('.cms-block-text').forEach(function(el) {
                var darkDiv = el.querySelector('[style*="background:#1a"]');
                if (darkDiv && el.textContent.indexOf('Bald verfügbar') !== -1) {
                    el.style.display = 'none';
                }
            });
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', hideDarkSoonBlocks);
        } else {
            hideDarkSoonBlocks();
        }
        setTimeout(hideDarkSoonBlocks, 50);
        setTimeout(hideDarkSoonBlocks, 200);
    })();
    </script>
{% endblock %}

{% block base_body_script %}
    {# Hide manufacturer names in product cards #}
    <style>
        .product-info a strong,
        .card-body a strong,
        .cms-element-product-listing a strong {
            display: none !important;
        }
        .alert-content,
        .alert.alert-info,
        .alert.alert-success {
            display: none !important;
        }
        /* Hide dark CMS "coming soon" blocks via CSS */
        .cms-element-text > div[style*="background:#1a"],
        .cms-element-text > div[style*="background: #1a"],
        .cms-element-text > div[style*="background:#2"],
        .cms-element-text > div[style*="background: #2"] {
            display: none !important;
        }
        /* Also hide parent text block if it has dark child */
        .cms-block-text:has(div[style*="background:#1a"]) {
            display: none !important;
        }
    </style>

    {# Hide dark CMS blocks - inject CSS via JS since direct CSS isn't loading #}
    <script>
    (function() {
        var css = '.cms-element-text > div[style*="background:#1a"],' +
                  '.cms-element-text > div[style*="background: #1a"],' +
                  '.cms-block-text:has(div[style*="background:#1a"]) { display: none !important; }';
        var style = document.createElement('style');
        style.textContent = css;
        document.head.appendChild(style);
    })();
    </script>

    {# Raven Cart AJAX handler - MUST load BEFORE Shopware's scripts #}
    <script>
    (function() {
        'use strict';

        function refreshOffcanvasCart() {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                var offcanvas = document.querySelector('.offcanvas.show .offcanvas-body');
                if (offcanvas) {
                    offcanvas.innerHTML = html;
                }
            });
        }

        function submitCartFormAjax(form) {
            var formData = new FormData(form);
            var action = form.getAttribute('action');
            fetch(action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function() { refreshOffcanvasCart(); })
            .catch(function() { refreshOffcanvasCart(); });
        }

        // Intercept ALL form submissions using capture phase
        document.addEventListener('submit', function(e) {
            var form = e.target;
            var action = form.getAttribute('action');
            if (!action) return;

            if (action.indexOf('checkout/line-item/delete') !== -1 ||
                action.indexOf('checkout/line-item/change-quantity') !== -1) {
                e.preventDefault();
                e.stopImmediatePropagation();
                submitCartFormAjax(form);
                return false;
            }

            if (action.indexOf('checkout/line-item/add') !== -1) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var formData = new FormData(form);
                fetch(action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                }).then(function() {
                    var cartBtn = document.querySelector('[data-offcanvas-cart]');
                    if (cartBtn) cartBtn.click();
                });
                return false;
            }
        }, true);

        // Handle quantity and delete button clicks
        document.addEventListener('click', function(e) {
            var minusBtn = e.target.closest('.js-btn-minus');
            if (minusBtn) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var form = minusBtn.closest('form');
                var input = form ? form.querySelector('input[name="quantity"]') : null;
                if (input) {
                    var current = parseInt(input.value) || 1;
                    if (current > 1) {
                        input.value = current - 1;
                        submitCartFormAjax(form);
                    }
                }
                return;
            }

            var plusBtn = e.target.closest('.js-btn-plus');
            if (plusBtn) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var form = plusBtn.closest('form');
                var input = form ? form.querySelector('input[name="quantity"]') : null;
                if (input) {
                    var current = parseInt(input.value) || 1;
                    input.value = current + 1;
                    submitCartFormAjax(form);
                }
                return;
            }

            var removeBtn = e.target.closest('.raven-item-remove');
            if (removeBtn) {
                e.preventDefault();
                e.stopImmediatePropagation();
                var form = removeBtn.closest('form');
                if (form) submitCartFormAjax(form);
                return;
            }
        }, true);

        window.ravenRefreshCart = refreshOffcanvasCart;
        console.log('Raven Cart AJAX handler loaded FIRST');
    })();
    </script>

    {# Organization Schema.org JSON-LD for Google Rich Snippets #}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Raven Weapon AG",
        "url": "https://ravenweapon.ch",
        "logo": "https://ravenweapon.ch/bundles/raventheme/assets/raven-logo.png",
        "description": "Schweizer Waffenhändler - Waffen, Munition, Optik & Zubehör online kaufen",
        "address": {
            "@type": "PostalAddress",
            "addressCountry": "CH",
            "addressRegion": "Schweiz"
        },
        "contactPoint": {
            "@type": "ContactPoint",
            "email": "info@ravenweapon.ch",
            "contactType": "customer service"
        }
    }
    </script>

    {{ parent() }}
{% endblock %}

{% block base_head_DISABLED %}
    {{ parent() }}

    <script>
    // Raven Theme - Off-Canvas Cart Handler
    (function() {
        function ravenOpenCart() {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                var offcanvas = document.getElementById('raven-offcanvas-cart');
                if (!offcanvas) {
                    offcanvas = document.createElement('div');
                    offcanvas.id = 'raven-offcanvas-cart';
                    offcanvas.className = 'offcanvas offcanvas-end';
                    offcanvas.style.cssText = 'position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100vw;z-index:1050;background:#fff;transform:translateX(100%);transition:transform 0.3s ease;';
                    document.body.appendChild(offcanvas);
                }
                offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';

                // Show offcanvas
                offcanvas.style.transform = 'translateX(0)';
                offcanvas.classList.add('show');

                // Create backdrop
                var backdrop = document.getElementById('raven-offcanvas-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'raven-offcanvas-backdrop';
                    backdrop.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1040;opacity:0;transition:opacity 0.15s;';
                    backdrop.onclick = ravenCloseCart;
                    document.body.appendChild(backdrop);
                }
                setTimeout(function() { backdrop.style.opacity = '1'; }, 10);
                document.body.style.overflow = 'hidden';

                // Attach close handlers
                offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(function(btn) {
                    btn.onclick = ravenCloseCart;
                });

                // Initialize Shopware plugins
                if (window.PluginManager) {
                    window.PluginManager.initializePlugins();
                }
            });
        }

        function ravenCloseCart() {
            var offcanvas = document.getElementById('raven-offcanvas-cart');
            var backdrop = document.getElementById('raven-offcanvas-backdrop');
            if (offcanvas) {
                offcanvas.style.transform = 'translateX(100%)';
                offcanvas.classList.remove('show');
            }
            if (backdrop) {
                backdrop.style.opacity = '0';
                setTimeout(function() { backdrop.remove(); }, 150);
            }
            document.body.style.overflow = '';
        }

        // Expose to global scope
        window.ravenOpenCart = ravenOpenCart;
        window.ravenCloseCart = ravenCloseCart;

        // Also listen for add-to-cart events
        document.addEventListener('DOMContentLoaded', function() {
            // Handle cart button clicks
            document.querySelectorAll('[data-offcanvas-cart]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    ravenOpenCart();
                });
            });
        });
    })();
    </script>
{% endblock %}
