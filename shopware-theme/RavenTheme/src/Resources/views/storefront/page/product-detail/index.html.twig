{% sw_extends '@Storefront/storefront/page/product-detail/index.html.twig' %}

{% block base_main_inner %}
<div class="raven-product-detail container py-4 md:py-6">
    {# Breadcrumb #}
    <nav class="text-sm text-gray-500 mb-3" aria-label="Breadcrumb">
        <a href="{{ path('frontend.home.page') }}" class="hover:text-gray-700">Home</a>
        <span class="mx-2">/</span>
        <a href="{{ path('frontend.navigation.page', { navigationId: page.header.navigation.active.id }) }}" class="hover:text-gray-700">Shop</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">
            {% if page.product.categories|first %}{{ page.product.categories|first.translated.name }}{% else %}Produkt{% endif %}
        </span>
    </nav>

    {# Product Grid: Image Left, Info Right #}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">

        {# LEFT: Product Image Gallery #}
        <div class="product-image-section">
            {# Main Image with Zoom #}
            <div class="product-main-image bg-white rounded-xl p-8 shadow-sm mb-4" id="image-zoom-container">
                {% if page.product.cover.media %}
                <img id="product-main-image"
                     src="{{ page.product.cover.media.url }}"
                     alt="{{ page.product.translated.name }}"
                     class="w-full h-auto object-contain zoom-image"
                     style="max-height: 500px;">
                {# Zoom Lens (hidden by default) #}
                <div id="zoom-lens" class="zoom-lens"></div>
                {# Zoomed Result Box #}
                <div id="zoom-result" class="zoom-result">
                    <img id="zoom-result-img" src="{{ page.product.cover.media.url }}" alt="Zoomed">
                </div>
                {% else %}
                <img src="{{ asset('bundles/raventheme/assets/placeholder.png') }}"
                     alt="{{ page.product.translated.name }}"
                     class="w-full h-auto object-contain">
                {% endif %}
            </div>
        </div>

        {# RIGHT: Product Info #}
        <div class="product-info-section">
            {# Manufacturer Name #}
            <p class="cat-label text-sm text-gray-500 mb-2">
                {% if page.product.manufacturer.translated.name %}
                    {{ page.product.manufacturer.translated.name }}
                {% else %}
                    Produkt
                {% endif %}
            </p>

            {# Product Name - strip manufacturer name from title #}
            {% set productName = page.product.translated.name %}
            {% set manufacturerName = page.product.manufacturer.translated.name|default('') %}
            {% if manufacturerName and productName starts with manufacturerName %}
                {% set productName = productName|slice(manufacturerName|length)|trim %}
            {% endif %}
            <h1 class="prod-title text-3xl md:text-4xl text-gray-900 mb-4" style="font-family: 'Chakra Petch', sans-serif; font-weight: 700;">
                {{ productName }}
            </h1>

            {# Price - Swiss Format: CHF 3'150 #}
            <div class="raven-product-price mb-2" style="font-family: 'Inter', sans-serif; color: #E53935; font-weight: 600; font-size: 24px; line-height: 1.2; font-variant-numeric: tabular-nums;">
                {% set detailPrice = page.product.calculatedPrice.unitPrice %}
                {% set detailCents = ((detailPrice * 100) % 100)|round %}
                CHF {% if detailCents == 0 %}{{ detailPrice|number_format(0, '.', "'") }}{% else %}{{ detailPrice|number_format(2, '.', "'") }}{% endif %}
            </div>

            {# VAT included text #}
            <p class="text-sm text-gray-500 mb-1" style="font-family: 'Inter', sans-serif;">
                inkl. MwSt.
            </p>

            {# Category #}
            {% if page.product.categories|length > 0 %}
            <p class="text-sm text-gray-500 mb-6" style="font-family: 'Inter', sans-serif;">
                Kategorie:
                {% for category in page.product.categories %}
                    <a href="{{ seoUrl('frontend.navigation.page', { navigationId: category.id }) }}" class="text-gray-700 hover:text-amber-600" style="text-decoration: none;">{{ category.translated.name }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
            {% endif %}

            {# Availability Status #}
            <div class="flex items-center gap-2 mb-6">
                {% if page.product.availableStock > 0 %}
                <span class="raven-avail-dot" style="width: 20px; height: 20px; border-radius: 9999px; background: #77C15A; display: inline-flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;">
                        <path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span class="text-green-600 font-medium">Verfügbar</span>
                {% else %}
                <span class="w-5 h-5 rounded-full bg-red-500"></span>
                <span class="text-red-600 font-medium">Nicht verfügbar</span>
                {% endif %}
            </div>

            {# Color Variants - using product media images #}
            {% if page.product.media|length > 1 %}
            <div class="mb-6">
                <p class="text-base text-gray-600 mb-3" style="font-family: 'Inter', sans-serif;">
                    Farbe : <span id="selected-color-name" class="font-bold text-gray-900">Graphite Black</span>
                </p>
                <div class="flex flex-wrap gap-2">
                    {% set colorNames = ['Graphite Black', 'Flat Dark Earth', 'Northern Lights', 'Olive Drab Green', 'Sniper Grey'] %}
                    {% for media in page.product.media %}
                    {% set colorIndex = loop.index0 %}
                    {% set colorName = colorNames[colorIndex]|default('Standard') %}
                    <button class="color-image-swatch {% if loop.first %}selected{% endif %}"
                            data-color-name="{{ colorName }}"
                            title="{{ colorName }}"
                            onclick="document.getElementById('product-main-image').src='{{ media.media.url }}';
                                     document.getElementById('selected-color-name').textContent='{{ colorName }}';
                                     document.querySelectorAll('.color-image-swatch').forEach(el => el.classList.remove('selected'));
                                     this.classList.add('selected');">
                        <img src="{{ media.media.url }}" alt="{{ colorName }}" class="w-full h-full object-contain">
                        <span class="swatch-check">
                            <svg viewBox="0 0 24 24" fill="none" class="w-4 h-4">
                                <path d="M5 13l4 4L19 7" stroke="#374151" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Add to Cart Form - data-add-to-cart triggers off-canvas cart #}
            <form action="{{ path('frontend.checkout.line-item.add') }}"
                  method="post"
                  class="mb-8"
                  data-add-to-cart="true"
                  data-form-csrf-handler="true">
                {{ sw_csrf('frontend.checkout.line-item.add') }}
                <input type="hidden" name="lineItems[{{ page.product.id }}][id]" value="{{ page.product.id }}">
                <input type="hidden" name="lineItems[{{ page.product.id }}][type]" value="product">
                <input type="hidden" name="lineItems[{{ page.product.id }}][referencedId]" value="{{ page.product.id }}">
                <input type="hidden" name="lineItems[{{ page.product.id }}][stackable]" value="1">
                <input type="hidden" name="lineItems[{{ page.product.id }}][removable]" value="1">

                {# Quantity Selector #}
                <div class="mb-6">
                    <div class="flex items-center gap-3">
                        <button type="button"
                                id="qty-decrease"
                                class="quantity-btn"
                                style="width: 40px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; background: white; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                onclick="let qtyInput = document.getElementById('quantity'); if(qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;">
                            −
                        </button>
                        <input type="number"
                               id="quantity"
                               name="lineItems[{{ page.product.id }}][quantity]"
                               value="1"
                               min="1"
                               max="{{ page.product.availableStock }}"
                               class="quantity-input"
                               style="width: 60px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; text-align: center; font-weight: 600; font-family: 'Inter', sans-serif; line-height: 40px; padding: 0; -moz-appearance: textfield;"
                               readonly>
                        <button type="button"
                                id="qty-increase"
                                class="quantity-btn"
                                style="width: 40px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; background: white; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                onclick="let qtyInput = document.getElementById('quantity'); if(qtyInput.value < {{ page.product.availableStock }}) qtyInput.value = parseInt(qtyInput.value) + 1;">
                            +
                        </button>
                    </div>
                </div>

                {# Add to Cart Button #}
                <button type="submit"
                        class="add-to-cart-btn raven-btn-primary w-full py-4 rounded-lg text-gray-900 font-bold text-base flex items-center justify-center gap-2"
                        style="background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); border: 1px solid #C59A0F; box-shadow: 0 2px 6px rgba(0,0,0,0.25); position: relative; overflow: hidden; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-5 h-5" fill="currentColor">
                        <path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/>
                    </svg>
                    In den Warenkorb
                    <span class="btn-gloss" style="position: absolute; inset: 0; border-radius: 0.5rem; background: linear-gradient(180deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.25) 35%, rgba(255,255,255,0.00) 60%); pointer-events: none;"></span>
                </button>
            </form>

            {# Product Description with See More #}
            {% if page.product.translated.description %}
            <div class="border-t border-gray-200 pt-6">
                <h2 class="prod-title text-xl text-gray-900 mb-3" style="font-family: 'Chakra Petch', sans-serif; font-weight: 700;">
                    Beschreibung
                </h2>
                <div class="description-wrapper" id="description-wrapper">
                    <div class="description-content text-gray-700 leading-relaxed" id="description-content" style="font-family: 'Inter', sans-serif;">
                        {{ page.product.translated.description|raw }}
                    </div>
                    <div class="description-fade" id="description-fade"></div>
                </div>
                <button type="button" class="see-more-btn" id="see-more-btn" style="display: none;">
                    <span id="see-more-text">Mehr anzeigen</span>
                    <svg id="see-more-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
            {% endif %}

            {# Manufacturer section removed per request #}

            {# Product Number #}
            {% if page.product.productNumber %}
            <div class="mt-4">
                <p class="text-sm text-gray-500" style="font-family: 'Inter', sans-serif;">
                    Artikelnummer: <span class="font-medium text-gray-700">{{ page.product.productNumber }}</span>
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Reviews Section - Below main product grid #}
    <div class="product-reviews-section mt-12 bg-white rounded-xl p-6 shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-900" style="font-family: 'Chakra Petch', sans-serif;">
                Kundenbewertungen
            </h3>
            <button type="button" onclick="openReviewModal()" class="text-sm text-amber-600 hover:text-amber-700 font-medium flex items-center gap-1" style="background: none; border: none; cursor: pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Bewertung schreiben
            </button>
        </div>

        {% set reviewCount = page.product.productReviews|length %}
        {% set avgRating = page.product.ratingAverage|default(0) %}

        {% if reviewCount > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {# Left: Rating Summary #}
            <div>
                <div class="flex items-center gap-4 mb-4">
                    <div class="flex items-center gap-1" id="star-rating-display">
                        {% for i in 1..5 %}
                            {% if avgRating >= i %}
                                <svg class="star-icon filled" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            {% elseif avgRating >= (i - 0.5) %}
                                <svg class="star-icon half" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            {% else %}
                                <svg class="star-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <span class="text-2xl font-bold text-gray-900" id="avg-rating">{{ avgRating|number_format(1) }}</span>
                    <span class="text-sm text-gray-500">({{ reviewCount }} Bewertung{% if reviewCount != 1 %}en{% endif %})</span>
                </div>

                {# Rating Breakdown #}
                {% set star5 = 0 %}{% set star4 = 0 %}{% set star3 = 0 %}{% set star2 = 0 %}{% set star1 = 0 %}
                {% for review in page.product.productReviews %}
                    {% if review.points == 5 %}{% set star5 = star5 + 1 %}
                    {% elseif review.points == 4 %}{% set star4 = star4 + 1 %}
                    {% elseif review.points == 3 %}{% set star3 = star3 + 1 %}
                    {% elseif review.points == 2 %}{% set star2 = star2 + 1 %}
                    {% elseif review.points == 1 %}{% set star1 = star1 + 1 %}{% endif %}
                {% endfor %}
                <div class="rating-breakdown">
                    <div class="rating-bar-row"><span class="rating-label">5 Sterne</span><div class="rating-bar-bg"><div class="rating-bar-fill" style="width: {{ reviewCount > 0 ? (star5 / reviewCount * 100) : 0 }}%;"></div></div><span class="rating-count">{{ star5 }}</span></div>
                    <div class="rating-bar-row"><span class="rating-label">4 Sterne</span><div class="rating-bar-bg"><div class="rating-bar-fill" style="width: {{ reviewCount > 0 ? (star4 / reviewCount * 100) : 0 }}%;"></div></div><span class="rating-count">{{ star4 }}</span></div>
                    <div class="rating-bar-row"><span class="rating-label">3 Sterne</span><div class="rating-bar-bg"><div class="rating-bar-fill" style="width: {{ reviewCount > 0 ? (star3 / reviewCount * 100) : 0 }}%;"></div></div><span class="rating-count">{{ star3 }}</span></div>
                    <div class="rating-bar-row"><span class="rating-label">2 Sterne</span><div class="rating-bar-bg"><div class="rating-bar-fill" style="width: {{ reviewCount > 0 ? (star2 / reviewCount * 100) : 0 }}%;"></div></div><span class="rating-count">{{ star2 }}</span></div>
                    <div class="rating-bar-row"><span class="rating-label">1 Stern</span><div class="rating-bar-bg"><div class="rating-bar-fill" style="width: {{ reviewCount > 0 ? (star1 / reviewCount * 100) : 0 }}%;"></div></div><span class="rating-count">{{ star1 }}</span></div>
                </div>
            </div>

            {# Right: Reviews List #}
            <div class="reviews-list" id="reviews-list">
                {% for review in page.product.productReviews %}
                <div class="review-item">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="flex">
                            {% for i in 1..5 %}
                                {% if review.points >= i %}
                                    <svg class="star-icon filled small" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                {% else %}
                                    <svg class="star-icon small" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ review.externalUser|default('Kunde') }}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-900 mb-1">{{ review.title }}</p>
                    <p class="text-sm text-gray-600">{{ review.content }}</p>
                    <span class="text-xs text-gray-400">{{ review.createdAt|date('d.m.Y') }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-6">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem;">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <p class="text-gray-500 mb-1">Noch keine Bewertungen</p>
            <p class="text-sm text-gray-400">Sei der Erste, der dieses Produkt bewertet!</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Hide manufacturer link from CMS */
    .product-detail-manufacturer-link,
    a[href=""][class*="manufacturer"],
    .cms-element-product-description-reviews .product-detail-manufacturer-link {
        display: none !important;
    }

    .quantity-btn:hover {
        background: #F3F4F6;
        border-color: #9CA3AF;
    }

    .color-image-swatch {
        width: 72px;
        height: 72px;
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        padding: 6px;
        background: #FAFAFA;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .color-image-swatch:hover {
        border-color: #9CA3AF;
    }

    .color-image-swatch.selected {
        border-color: #374151;
        border-width: 2px;
    }

    .color-image-swatch .swatch-check {
        display: none;
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: white;
        border-radius: 4px;
        padding: 2px;
    }

    .color-image-swatch.selected .swatch-check {
        display: flex;
    }

    .add-to-cart-btn:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .product-main-image {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: visible;
    }

    /* ========== IMAGE ZOOM STYLES ========== */
    #image-zoom-container {
        position: relative;
        cursor: crosshair;
    }

    .zoom-image {
        transition: opacity 0.2s ease;
    }

    .zoom-lens {
        position: absolute;
        width: 150px;
        height: 150px;
        border: 3px solid #D4A847;
        border-radius: 50%;
        background: rgba(212, 168, 71, 0.15);
        pointer-events: none;
        display: none;
        z-index: 10;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }

    .zoom-result {
        position: absolute;
        top: 0;
        left: calc(100% + 20px);
        width: 400px;
        height: 400px;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        background: white;
        overflow: hidden;
        display: none;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .zoom-result img {
        position: absolute;
        width: auto;
        height: auto;
        max-width: none;
    }

    @media (max-width: 1200px) {
        .zoom-result {
            display: none !important;
        }
    }

    /* ========== SEE MORE DESCRIPTION STYLES ========== */
    .description-wrapper {
        position: relative;
        max-height: 150px;
        overflow: hidden;
        transition: max-height 0.4s ease;
    }

    .description-wrapper.expanded {
        max-height: 2000px;
    }

    .description-fade {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .description-wrapper.expanded .description-fade {
        opacity: 0;
    }

    .see-more-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid #D4A847;
        border-radius: 6px;
        color: #D4A847;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .see-more-btn:hover {
        background: #D4A847;
        color: #1f2937;
    }

    .see-more-btn svg {
        transition: transform 0.3s ease;
    }

    .see-more-btn.expanded svg {
        transform: rotate(180deg);
    }

    /* ========== RATINGS & REVIEWS STYLES ========== */
    .product-reviews-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .star-icon {
        width: 24px;
        height: 24px;
        fill: #E5E7EB;
    }

    .star-icon.filled {
        fill: #F59E0B;
    }

    .star-icon.half {
        fill: url(#half-star-gradient);
    }

    .star-icon.small {
        width: 14px;
        height: 14px;
    }

    .rating-breakdown {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .rating-bar-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.75rem;
        color: #6B7280;
    }

    .rating-label {
        width: 60px;
        flex-shrink: 0;
    }

    .rating-bar-bg {
        flex: 1;
        height: 8px;
        background: #E5E7EB;
        border-radius: 4px;
        overflow: hidden;
    }

    .rating-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #F59E0B, #D4A847);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .rating-count {
        width: 24px;
        text-align: right;
        flex-shrink: 0;
    }

    .reviews-list {
        border-top: 1px solid #E5E7EB;
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .review-item {
        padding: 1rem 0;
        border-bottom: 1px solid #F3F4F6;
    }

    .review-item:last-child {
        border-bottom: none;
    }

    /* SVG Gradient for half stars */
    svg defs {
        display: block;
    }
</style>

{# SVG Gradient Definition for Half Stars #}
<svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
    <defs>
        <linearGradient id="half-star-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="50%" style="stop-color:#F59E0B;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#E5E7EB;stop-opacity:1" />
        </linearGradient>
    </defs>
</svg>

<script>
    // ========== IMAGE ZOOM FUNCTIONALITY ==========
    (function() {
        function initImageZoom() {
            const container = document.getElementById('image-zoom-container');
            const mainImage = document.getElementById('product-main-image');
            const lens = document.getElementById('zoom-lens');
            const result = document.getElementById('zoom-result');
            const resultImg = document.getElementById('zoom-result-img');

            if (!container || !mainImage || !lens || !result || !resultImg) return;

            const zoomLevel = 2.5; // How much to zoom
            let isActive = false;

            function moveLens(e) {
                if (!isActive) return;

                e.preventDefault();

                const rect = mainImage.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                // Calculate cursor position relative to the image
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;

                // Keep lens within image bounds
                const lensHalfW = lens.offsetWidth / 2;
                const lensHalfH = lens.offsetHeight / 2;

                x = Math.max(lensHalfW, Math.min(x, rect.width - lensHalfW));
                y = Math.max(lensHalfH, Math.min(y, rect.height - lensHalfH));

                // Position lens centered on cursor
                lens.style.left = (x - lensHalfW + (rect.left - containerRect.left)) + 'px';
                lens.style.top = (y - lensHalfH + (rect.top - containerRect.top)) + 'px';

                // Calculate the zoomed area
                const bgX = -(x * zoomLevel - result.offsetWidth / 2);
                const bgY = -(y * zoomLevel - result.offsetHeight / 2);

                // Set the zoomed image size and position
                resultImg.style.width = (rect.width * zoomLevel) + 'px';
                resultImg.style.height = (rect.height * zoomLevel) + 'px';
                resultImg.style.left = bgX + 'px';
                resultImg.style.top = bgY + 'px';
            }

            function showZoom() {
                // Only show on larger screens
                if (window.innerWidth < 1200) return;
                isActive = true;
                lens.style.display = 'block';
                result.style.display = 'block';
            }

            function hideZoom() {
                isActive = false;
                lens.style.display = 'none';
                result.style.display = 'none';
            }

            // Event listeners
            container.addEventListener('mouseenter', showZoom);
            container.addEventListener('mouseleave', hideZoom);
            container.addEventListener('mousemove', moveLens);

            // Update zoom image when main image changes (color variants)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                        resultImg.src = mainImage.src;
                    }
                });
            });
            observer.observe(mainImage, { attributes: true });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initImageZoom);
        } else {
            initImageZoom();
        }
    })();

    // ========== SEE MORE / LESS FUNCTIONALITY ==========
    (function() {
        function initSeeMore() {
            const wrapper = document.getElementById('description-wrapper');
            const content = document.getElementById('description-content');
            const fade = document.getElementById('description-fade');
            const btn = document.getElementById('see-more-btn');
            const btnText = document.getElementById('see-more-text');
            const btnIcon = document.getElementById('see-more-icon');

            if (!wrapper || !content || !btn) return;

            // Check if content overflows the max-height
            const maxHeight = 150; // Same as CSS max-height
            const contentHeight = content.scrollHeight;

            if (contentHeight > maxHeight + 20) {
                // Content is longer, show the button
                btn.style.display = 'inline-flex';

                btn.addEventListener('click', function() {
                    const isExpanded = wrapper.classList.contains('expanded');

                    if (isExpanded) {
                        // Collapse
                        wrapper.classList.remove('expanded');
                        btn.classList.remove('expanded');
                        btnText.textContent = 'Mehr anzeigen';

                        // Scroll back to description if needed
                        wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        // Expand
                        wrapper.classList.add('expanded');
                        btn.classList.add('expanded');
                        btnText.textContent = 'Weniger anzeigen';
                    }
                });
            } else {
                // Content fits, hide button and fade
                btn.style.display = 'none';
                if (fade) fade.style.display = 'none';
                wrapper.style.maxHeight = 'none';
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSeeMore);
        } else {
            initSeeMore();
        }
    })();

    // ========== CUSTOM ADD TO CART HANDLER ==========
    (function() {
        function showOffcanvasCart() {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                let offcanvas = document.getElementById('raven-offcanvas-cart');
                if (!offcanvas) {
                    offcanvas = document.createElement('div');
                    offcanvas.id = 'raven-offcanvas-cart';
                    offcanvas.className = 'offcanvas offcanvas-end';
                    offcanvas.style.cssText = 'width: 420px; max-width: 100vw; z-index: 1050;';
                    offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
                    document.body.appendChild(offcanvas);
                } else {
                    offcanvas.querySelector('.offcanvas-body').innerHTML = html;
                }

                offcanvas.classList.add('show');
                offcanvas.style.visibility = 'visible';
                offcanvas.style.transform = 'translateX(0)';

                let backdrop = document.getElementById('raven-offcanvas-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'raven-offcanvas-backdrop';
                    backdrop.className = 'offcanvas-backdrop fade';
                    backdrop.style.zIndex = '1040';
                    backdrop.onclick = closeOffcanvasCart;
                    document.body.appendChild(backdrop);
                }
                setTimeout(() => backdrop.classList.add('show'), 10);
                document.body.style.overflow = 'hidden';

                offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(btn => {
                    btn.onclick = closeOffcanvasCart;
                });
            });
        }

        function closeOffcanvasCart() {
            const offcanvas = document.getElementById('raven-offcanvas-cart');
            const backdrop = document.getElementById('raven-offcanvas-backdrop');
            if (offcanvas) {
                offcanvas.classList.remove('show');
                offcanvas.style.transform = 'translateX(100%)';
            }
            if (backdrop) {
                backdrop.classList.remove('show');
                setTimeout(() => backdrop.remove(), 150);
            }
            document.body.style.overflow = '';
        }

        function initAddToCart() {
            const form = document.querySelector('form[data-add-to-cart]');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:0.5rem;"><svg class="animate-spin" style="width:20px;height:20px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg> Wird hinzugefuegt...</span>';

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showOffcanvasCart();
                })
                .catch(err => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    console.error('Add to cart failed:', err);
                });
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAddToCart);
        } else {
            initAddToCart();
        }
    })();

    // ========== REVIEW MODAL FUNCTIONALITY ==========
    function openReviewModal() {
        const modal = document.getElementById('review-modal');
        const backdrop = document.getElementById('review-modal-backdrop');
        if (modal && backdrop) {
            modal.style.display = 'flex';
            backdrop.style.display = 'block';
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                modal.classList.add('show');
                backdrop.classList.add('show');
            }, 10);
        }
    }

    function closeReviewModal() {
        const modal = document.getElementById('review-modal');
        const backdrop = document.getElementById('review-modal-backdrop');
        if (modal && backdrop) {
            modal.classList.remove('show');
            backdrop.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                backdrop.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }
    }

    function setReviewRating(rating) {
        document.getElementById('review-rating-input').value = rating;
        const stars = document.querySelectorAll('.review-star-btn');
        stars.forEach((star, index) => {
            const svg = star.querySelector('svg');
            if (index < rating) {
                svg.classList.add('filled');
            } else {
                svg.classList.remove('filled');
            }
        });
    }

    function submitReview(event) {
        event.preventDefault();

        const form = document.getElementById('review-form');
        const submitBtn = document.getElementById('review-submit-btn');
        const rating = document.getElementById('review-rating-input').value;
        const title = document.getElementById('review-title').value.trim();
        const content = document.getElementById('review-content').value.trim();
        const name = document.getElementById('review-name').value.trim();
        const email = document.getElementById('review-email').value.trim();
        const productId = document.getElementById('review-product-id').value;

        // Validation
        if (!rating || rating < 1) {
            alert('Bitte geben Sie eine Bewertung ab (1-5 Sterne)');
            return false;
        }
        if (!title) {
            alert('Bitte geben Sie einen Titel ein');
            return false;
        }
        if (!content) {
            alert('Bitte schreiben Sie eine Bewertung');
            return false;
        }
        if (!name) {
            alert('Bitte geben Sie Ihren Namen ein');
            return false;
        }
        if (!email || !email.includes('@')) {
            alert('Bitte geben Sie eine gueltige E-Mail-Adresse ein');
            return false;
        }

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:0.5rem;"><svg class="animate-spin" style="width:18px;height:18px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg> Wird gesendet...</span>';

        // Submit to Shopware storefront route
        const formData = new FormData();
        formData.append('parentId', productId);
        formData.append('points', rating);
        formData.append('title', title);
        formData.append('content', content);
        formData.append('name', name);
        formData.append('email', email);

        // Get CSRF token from meta tag or cookie
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content ||
                          document.querySelector('input[name="_csrf_token"]')?.value || '';
        if (csrfToken) {
            formData.append('_csrf_token', csrfToken);
        }

        fetch('/detail/' + productId + '/rating', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Show success message
                form.innerHTML = '<div style="text-align: center; padding: 2rem;"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#77C15A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><h3 style="font-family: Chakra Petch, sans-serif; font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Vielen Dank!</h3><p style="color: #6b7280;">Ihre Bewertung wurde erfolgreich eingereicht und wird nach Pruefung veroeffentlicht.</p></div>';
                setTimeout(closeReviewModal, 3000);
            } else {
                throw new Error('Review submission failed');
            }
        })
        .catch(error => {
            console.error('Review error:', error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Bewertung absenden';
            alert('Fehler beim Senden der Bewertung. Bitte versuchen Sie es erneut.');
        });

        return false;
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeReviewModal();
        }
    });
</script>

{# Review Modal #}
<div id="review-modal-backdrop" class="review-modal-backdrop" onclick="closeReviewModal()"></div>
<div id="review-modal" class="review-modal" role="dialog" aria-modal="true" aria-labelledby="review-modal-title">
    <div class="review-modal-content">
        <div class="review-modal-header">
            <h2 id="review-modal-title" style="font-family: 'Chakra Petch', sans-serif; font-size: 1.5rem; font-weight: 700; color: #111827; margin: 0;">Bewertung schreiben</h2>
            <button type="button" onclick="closeReviewModal()" class="review-modal-close" aria-label="Schliessen">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <form id="review-form" onsubmit="return submitReview(event)">
            <input type="hidden" id="review-product-id" value="{{ page.product.id }}">
            <input type="hidden" id="review-rating-input" value="0">

            {# Product Info #}
            <div class="review-product-info">
                {% if page.product.cover.media %}
                <img src="{{ page.product.cover.media.url }}" alt="{{ page.product.translated.name }}" class="review-product-image">
                {% endif %}
                <div>
                    <p style="font-weight: 600; color: #111827; margin: 0;">{{ page.product.translated.name }}</p>
                    <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0;">{{ page.product.productNumber }}</p>
                </div>
            </div>

            {# Star Rating #}
            <div class="review-field">
                <label class="review-label">Ihre Bewertung <span style="color: #ef4444;">*</span></label>
                <div class="review-stars">
                    {% for i in 1..5 %}
                    <button type="button" class="review-star-btn" onclick="setReviewRating({{ i }})" aria-label="{{ i }} Stern{% if i > 1 %}e{% endif %}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </button>
                    {% endfor %}
                </div>
            </div>

            {# Title #}
            <div class="review-field">
                <label for="review-title" class="review-label">Titel <span style="color: #ef4444;">*</span></label>
                <input type="text" id="review-title" class="review-input" placeholder="Fassen Sie Ihre Erfahrung zusammen" required maxlength="100">
            </div>

            {# Review Content #}
            <div class="review-field">
                <label for="review-content" class="review-label">Ihre Bewertung <span style="color: #ef4444;">*</span></label>
                <textarea id="review-content" class="review-textarea" rows="4" placeholder="Teilen Sie Ihre Erfahrung mit diesem Produkt..." required maxlength="2000"></textarea>
            </div>

            {# Name & Email Row #}
            <div class="review-row">
                <div class="review-field">
                    <label for="review-name" class="review-label">Name <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="review-name" class="review-input" placeholder="Ihr Name" required maxlength="100">
                </div>
                <div class="review-field">
                    <label for="review-email" class="review-label">E-Mail <span style="color: #ef4444;">*</span></label>
                    <input type="email" id="review-email" class="review-input" placeholder="ihre.email@beispiel.ch" required>
                    <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">Wird nicht veroeffentlicht, nur zur Verifizierung</p>
                </div>
            </div>

            {# Submit Button #}
            <button type="submit" id="review-submit-btn" class="review-submit-btn">
                Bewertung absenden
            </button>
        </form>
    </div>
</div>

<style>
    /* Review Modal Styles */
    .review-modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .review-modal-backdrop.show { opacity: 1; }

    .review-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1050;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .review-modal.show { opacity: 1; transform: scale(1); }

    .review-modal-content {
        background: white;
        border-radius: 16px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .review-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .review-modal-close {
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        color: #6b7280;
        border-radius: 8px;
        transition: all 0.2s;
    }
    .review-modal-close:hover { background: #f3f4f6; color: #111827; }

    .review-product-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
    }

    .review-product-image {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 8px;
        background: white;
        padding: 4px;
    }

    #review-form {
        padding: 0;
    }

    .review-field {
        padding: 0 1.5rem;
        margin-bottom: 1rem;
    }
    .review-field:first-of-type { padding-top: 1.5rem; }

    .review-label {
        display: block;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .review-input, .review-textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 0.9375rem;
        color: #111827;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
    }
    .review-input:focus, .review-textarea:focus {
        outline: none;
        border-color: #D4A847;
        box-shadow: 0 0 0 3px rgba(212, 168, 71, 0.15);
    }
    .review-textarea { resize: vertical; min-height: 100px; }

    .review-stars {
        display: flex;
        gap: 0.25rem;
    }

    .review-star-btn {
        background: none;
        border: none;
        padding: 0.25rem;
        cursor: pointer;
        transition: transform 0.15s;
    }
    .review-star-btn:hover { transform: scale(1.15); }
    .review-star-btn svg {
        width: 32px;
        height: 32px;
        fill: #e5e7eb;
        stroke: #d1d5db;
        transition: fill 0.15s, stroke 0.15s;
    }
    .review-star-btn svg.filled {
        fill: #F59E0B;
        stroke: #F59E0B;
    }
    .review-star-btn:hover svg { stroke: #F59E0B; }

    .review-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        padding: 0 1.5rem;
        margin-bottom: 1rem;
    }
    .review-row .review-field { padding: 0; margin-bottom: 0; }

    @media (max-width: 500px) {
        .review-row { grid-template-columns: 1fr; }
    }

    .review-submit-btn {
        display: block;
        width: calc(100% - 3rem);
        margin: 1.5rem;
        padding: 0.875rem 1.5rem;
        background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%);
        border: 1px solid #C59A0F;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .review-submit-btn:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
    .review-submit-btn:disabled { opacity: 0.7; cursor: not-allowed; }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }
</style>
{% endblock %}
