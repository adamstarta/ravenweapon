{% sw_extends '@Storefront/storefront/page/product-detail/index.html.twig' %}

{% block base_main_inner %}
<div class="raven-product-detail container py-8 md:py-12">
    {# Breadcrumb #}
    <nav class="text-sm text-gray-500 mb-6" aria-label="Breadcrumb">
        <a href="{{ path('frontend.home.page') }}" class="hover:text-gray-700">Home</a>
        <span class="mx-2">/</span>
        <a href="{{ path('frontend.navigation.page', { navigationId: page.header.navigation.active.id }) }}" class="hover:text-gray-700">Shop</a>
        <span class="mx-2">/</span>
        <span class="text-gray-900">
            {% if page.product.categories|first %}{{ page.product.categories|first.translated.name }}{% else %}Produkt{% endif %}
        </span>
    </nav>

    {# Product Grid: Image Left, Info Right #}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">

        {# LEFT: Product Image Gallery #}
        <div class="product-image-section">
            <div class="product-main-image bg-white rounded-xl p-8 shadow-sm mb-4">
                {% if page.product.cover.media %}
                <img id="product-main-image"
                     src="{{ page.product.cover.media.url }}"
                     alt="{{ page.product.translated.name }}"
                     class="w-full h-auto object-contain"
                     style="max-height: 500px;">
                {% else %}
                <img src="{{ asset('bundles/raventheme/assets/placeholder.png') }}"
                     alt="{{ page.product.translated.name }}"
                     class="w-full h-auto object-contain">
                {% endif %}
            </div>

        </div>

        {# RIGHT: Product Info #}
        <div class="product-info-section">
            {# Category #}
            <p class="cat-label text-sm text-gray-500 mb-2">
                {% if page.product.categories|first %}
                    {{ page.product.categories|first.translated.name }}
                {% else %}
                    Produkt
                {% endif %}
            </p>

            {# Product Name - strip manufacturer name from title #}
            {% set productName = page.product.translated.name %}
            {% set manufacturerName = page.product.manufacturer.translated.name|default('') %}
            {% if manufacturerName and productName starts with manufacturerName %}
                {% set productName = productName|slice(manufacturerName|length)|trim %}
            {% endif %}
            <h1 class="prod-title text-3xl md:text-4xl text-gray-900 mb-4" style="font-family: 'Chakra Petch', sans-serif; font-weight: 700;">
                {{ productName }}
            </h1>

            {# Price - Swiss Format #}
            <div class="raven-product-price mb-6" style="font-family: 'Inter', sans-serif; color: #E53935; font-weight: 600; font-size: 24px; line-height: 1.2; font-variant-numeric: tabular-nums;">
                {% set detailPrice = page.product.calculatedPrice.unitPrice %}
                {% set detailCents = ((detailPrice * 100) % 100)|round %}
                {% if detailCents == 0 %}{{ detailPrice|number_format(0, '.', '') }}.–{% else %}{{ detailPrice|number_format(2, '.', '') }}{% endif %}
            </div>

            {# Availability Status #}
            <div class="flex items-center gap-2 mb-6">
                {% if page.product.availableStock > 0 %}
                <span class="raven-avail-dot" style="width: 20px; height: 20px; border-radius: 9999px; background: #77C15A; display: inline-flex; align-items: center; justify-content: center;">
                    <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;">
                        <path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                <span class="text-green-600 font-medium">Verfügbar</span>
                {% else %}
                <span class="w-5 h-5 rounded-full bg-red-500"></span>
                <span class="text-red-600 font-medium">Nicht verfügbar</span>
                {% endif %}
            </div>

            {# Color Variants - using product media images #}
            {% if page.product.media|length > 1 %}
            <div class="mb-6">
                <p class="text-base text-gray-600 mb-3" style="font-family: 'Inter', sans-serif;">
                    Farbe : <span id="selected-color-name" class="font-bold text-gray-900">Graphite Black</span>
                </p>
                <div class="flex flex-wrap gap-2">
                    {% set colorNames = ['Graphite Black', 'Flat Dark Earth', 'Northern Lights', 'Olive Drab Green', 'Sniper Grey'] %}
                    {% for media in page.product.media %}
                    {% set colorIndex = loop.index0 %}
                    {% set colorName = colorNames[colorIndex]|default('Standard') %}
                    <button class="color-image-swatch {% if loop.first %}selected{% endif %}"
                            data-color-name="{{ colorName }}"
                            title="{{ colorName }}"
                            onclick="document.getElementById('product-main-image').src='{{ media.media.url }}';
                                     document.getElementById('selected-color-name').textContent='{{ colorName }}';
                                     document.querySelectorAll('.color-image-swatch').forEach(el => el.classList.remove('selected'));
                                     this.classList.add('selected');">
                        <img src="{{ media.media.url }}" alt="{{ colorName }}" class="w-full h-full object-contain">
                        <span class="swatch-check">
                            <svg viewBox="0 0 24 24" fill="none" class="w-4 h-4">
                                <path d="M5 13l4 4L19 7" stroke="#374151" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Add to Cart Form - data-add-to-cart triggers off-canvas cart #}
            <form action="{{ path('frontend.checkout.line-item.add') }}"
                  method="post"
                  class="mb-8"
                  data-add-to-cart="true"
                  data-form-csrf-handler="true">
                {{ sw_csrf('frontend.checkout.line-item.add') }}
                <input type="hidden" name="lineItems[{{ page.product.id }}][id]" value="{{ page.product.id }}">
                <input type="hidden" name="lineItems[{{ page.product.id }}][type]" value="product">
                <input type="hidden" name="lineItems[{{ page.product.id }}][referencedId]" value="{{ page.product.id }}">
                <input type="hidden" name="lineItems[{{ page.product.id }}][stackable]" value="1">
                <input type="hidden" name="lineItems[{{ page.product.id }}][removable]" value="1">

                {# Quantity Selector #}
                <div class="mb-6">
                    <div class="flex items-center gap-3">
                        <button type="button"
                                id="qty-decrease"
                                class="quantity-btn"
                                style="width: 40px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; background: white; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                onclick="let qtyInput = document.getElementById('quantity'); if(qtyInput.value > 1) qtyInput.value = parseInt(qtyInput.value) - 1;">
                            −
                        </button>
                        <input type="number"
                               id="quantity"
                               name="lineItems[{{ page.product.id }}][quantity]"
                               value="1"
                               min="1"
                               max="{{ page.product.availableStock }}"
                               class="quantity-input"
                               style="width: 60px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; text-align: center; font-weight: 600; font-family: 'Inter', sans-serif;"
                               readonly>
                        <button type="button"
                                id="qty-increase"
                                class="quantity-btn"
                                style="width: 40px; height: 40px; border: 1px solid #D1D5DB; border-radius: 6px; background: white; font-weight: 600; cursor: pointer; transition: all 0.2s;"
                                onclick="let qtyInput = document.getElementById('quantity'); if(qtyInput.value < {{ page.product.availableStock }}) qtyInput.value = parseInt(qtyInput.value) + 1;">
                            +
                        </button>
                    </div>
                </div>

                {# Add to Cart Button #}
                <button type="submit"
                        class="add-to-cart-btn raven-btn-primary w-full py-4 rounded-lg text-gray-900 font-bold text-base flex items-center justify-center gap-2"
                        style="background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); border: 1px solid #C59A0F; box-shadow: 0 2px 6px rgba(0,0,0,0.25); position: relative; overflow: hidden; transition: all 0.2s;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="w-5 h-5" fill="currentColor">
                        <path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/>
                    </svg>
                    In den Warenkorb
                    <span class="btn-gloss" style="position: absolute; inset: 0; border-radius: 0.5rem; background: linear-gradient(180deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.25) 35%, rgba(255,255,255,0.00) 60%); pointer-events: none;"></span>
                </button>
            </form>

            {# Product Description #}
            {% if page.product.translated.description %}
            <div class="border-t border-gray-200 pt-6">
                <h2 class="prod-title text-xl text-gray-900 mb-3" style="font-family: 'Chakra Petch', sans-serif; font-weight: 700;">
                    Beschreibung
                </h2>
                <div class="text-gray-700 leading-relaxed" style="font-family: 'Inter', sans-serif;">
                    {{ page.product.translated.description|raw }}
                </div>
            </div>
            {% endif %}

            {# Manufacturer section removed per request #}

            {# Product Number #}
            {% if page.product.productNumber %}
            <div class="mt-4">
                <p class="text-sm text-gray-500" style="font-family: 'Inter', sans-serif;">
                    Artikelnummer: <span class="font-medium text-gray-700">{{ page.product.productNumber }}</span>
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Hide manufacturer link from CMS */
    .product-detail-manufacturer-link,
    a[href=""][class*="manufacturer"],
    .cms-element-product-description-reviews .product-detail-manufacturer-link {
        display: none !important;
    }

    .quantity-btn:hover {
        background: #F3F4F6;
        border-color: #9CA3AF;
    }

    .color-image-swatch {
        width: 72px;
        height: 72px;
        border: 2px solid #E5E7EB;
        border-radius: 8px;
        padding: 6px;
        background: #FAFAFA;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .color-image-swatch:hover {
        border-color: #9CA3AF;
    }

    .color-image-swatch.selected {
        border-color: #374151;
        border-width: 2px;
    }

    .color-image-swatch .swatch-check {
        display: none;
        position: absolute;
        bottom: 4px;
        left: 4px;
        background: white;
        border-radius: 4px;
        padding: 2px;
    }

    .color-image-swatch.selected .swatch-check {
        display: flex;
    }

    .add-to-cart-btn:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .product-main-image {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
</style>

<script>
    // Custom Add to Cart Handler for Raven Theme
    (function() {
        function showOffcanvasCart() {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                let offcanvas = document.getElementById('raven-offcanvas-cart');
                if (!offcanvas) {
                    offcanvas = document.createElement('div');
                    offcanvas.id = 'raven-offcanvas-cart';
                    offcanvas.className = 'offcanvas offcanvas-end';
                    offcanvas.style.cssText = 'width: 420px; max-width: 100vw; z-index: 1050;';
                    offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
                    document.body.appendChild(offcanvas);
                } else {
                    offcanvas.querySelector('.offcanvas-body').innerHTML = html;
                }

                offcanvas.classList.add('show');
                offcanvas.style.visibility = 'visible';
                offcanvas.style.transform = 'translateX(0)';

                let backdrop = document.getElementById('raven-offcanvas-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'raven-offcanvas-backdrop';
                    backdrop.className = 'offcanvas-backdrop fade';
                    backdrop.style.zIndex = '1040';
                    backdrop.onclick = closeOffcanvasCart;
                    document.body.appendChild(backdrop);
                }
                setTimeout(() => backdrop.classList.add('show'), 10);
                document.body.style.overflow = 'hidden';

                offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(btn => {
                    btn.onclick = closeOffcanvasCart;
                });
            });
        }

        function closeOffcanvasCart() {
            const offcanvas = document.getElementById('raven-offcanvas-cart');
            const backdrop = document.getElementById('raven-offcanvas-backdrop');
            if (offcanvas) {
                offcanvas.classList.remove('show');
                offcanvas.style.transform = 'translateX(100%)';
            }
            if (backdrop) {
                backdrop.classList.remove('show');
                setTimeout(() => backdrop.remove(), 150);
            }
            document.body.style.overflow = '';
        }

        function initAddToCart() {
            const form = document.querySelector('form[data-add-to-cart]');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;

                btn.disabled = true;
                btn.innerHTML = '<span style="display:inline-flex;align-items:center;gap:0.5rem;"><svg class="animate-spin" style="width:20px;height:20px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4" stroke-dashoffset="10"/></svg> Wird hinzugefuegt...</span>';

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    showOffcanvasCart();
                })
                .catch(err => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    console.error('Add to cart failed:', err);
                });
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAddToCart);
        } else {
            initAddToCart();
        }
    })();
</script>
{% endblock %}
