{% sw_extends '@Storefront/storefront/page/account/register/index.html.twig' %}

{# Hide header/navbar on auth pages #}
{% block base_header %}{% endblock %}

{# Hide footer on auth pages #}
{% block base_footer %}{% endblock %}

{# Block default flash messages - we show toasts instead #}
{% block base_flashbags %}{% endblock %}

{% block base_content %}
{% set isRegisterPage = app.request.attributes.get('_route') == 'frontend.account.register.page' %}
{# Get redirectTo from URL parameter - if coming from checkout, redirect back there after registration #}
{% set registerRedirectTo = app.request.query.get('redirectTo') | default('frontend.account.home.page') %}

<div class="raven-auth-page fullscreen">
    {# Back to Homepage Button #}
    <a href="{{ path('frontend.home.page') }}" class="back-home-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5"></path>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        Zur Startseite
    </a>

    <div class="auth-wrapper{% if isRegisterPage %} register-mode{% endif %}">
        {# Logo Section #}
        <div class="auth-logo">
            <a href="{{ path('frontend.home.page') }}">
                <div class="logo-image" style="background-image:url('{{ asset('bundles/raventheme/assets/logo.svg') }}');background-size:100% 455%;background-position:center;background-repeat:no-repeat;height:50px;width:220px;"></div>
            </a>
        </div>

        {% if isRegisterPage %}
        {# ========== REGISTER CARD ========== #}
        <div class="auth-card">
            <div class="card-header">
                <h1>Konto erstellen</h1>
                <p>Registrieren Sie sich für ein exklusives Einkaufserlebnis</p>
            </div>

            <form action="{{ path('frontend.account.register.save') }}"
                  method="post"
                  class="auth-form register-form"
                  data-form-handler="true">

                {# Use redirectTo from URL if present (e.g., from checkout flow) #}
                <input type="hidden" name="redirectTo" value="{{ registerRedirectTo }}">
                <input type="hidden" name="redirectParameters" value="">
                <input type="hidden" name="errorRoute" value="frontend.account.register.page">
                {# Preserve redirectTo in error case so user can try again and still go to checkout #}
                <input type="hidden" name="errorParameters" value="{% if registerRedirectTo != 'frontend.account.home.page' %}redirectTo={{ registerRedirectTo }}{% endif %}">
                {# CRITICAL: This tells Shopware to create a REAL customer account, not a guest! #}
                <input type="hidden" name="createCustomerAccount" value="1">

                {# Salutation #}
                <div class="form-group">
                    <label for="salutationId">Anrede</label>
                    <select name="salutationId" id="salutationId" required class="form-select">
                        {% for salutation in page.salutations %}
                            <option value="{{ salutation.id }}"{% if salutation.salutationKey == 'mr' %} selected{% endif %}>
                                {{ salutation.translated.displayName }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Name Row #}
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName">Vorname</label>
                        <input type="text"
                               name="firstName"
                               id="firstName"
                               placeholder="Max"
                               autocomplete="given-name"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="lastName">Nachname</label>
                        <input type="text"
                               name="lastName"
                               id="lastName"
                               placeholder="Mustermann"
                               autocomplete="family-name"
                               required>
                    </div>
                </div>

                {# Email #}
                <div class="form-group">
                    <label for="email">E-Mail-Adresse</label>
                    <input type="email"
                           name="email"
                           id="email"
                           placeholder="ihre@email.de"
                           autocomplete="email"
                           required>
                </div>

                {# Password #}
                <div class="form-group">
                    <label for="personalPassword">Passwort</label>
                    <input type="password"
                           name="password"
                           id="personalPassword"
                           placeholder="Mindestens 8 Zeichen"
                           autocomplete="new-password"
                           minlength="8"
                           required>
                </div>

                {# Confirm Password #}
                <div class="form-group">
                    <label for="personalPasswordConfirmation">Passwort bestätigen</label>
                    <input type="password"
                           name="passwordConfirmation"
                           id="personalPasswordConfirmation"
                           placeholder="Passwort wiederholen"
                           autocomplete="new-password"
                           minlength="8"
                           required>
                </div>

                {# Billing Address Section #}
                <div class="address-section">
                    <p class="section-title">Rechnungsadresse</p>

                    <div class="form-group">
                        <label for="street">Strasse und Hausnummer</label>
                        <input type="text"
                               name="billingAddress[street]"
                               id="street"
                               placeholder="Musterstrasse 123"
                               autocomplete="street-address"
                               required>
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 35%;">
                            <label for="zipcode">PLZ</label>
                            <input type="text"
                                   name="billingAddress[zipcode]"
                                   id="zipcode"
                                   placeholder="8000"
                                   autocomplete="postal-code"
                                   required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="city">Stadt</label>
                            <input type="text"
                                   name="billingAddress[city]"
                                   id="city"
                                   placeholder="Zürich"
                                   autocomplete="address-level2"
                                   required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="countryId">Land</label>
                        <select name="billingAddress[countryId]" id="countryId" required class="form-select">
                            {% for country in page.countries %}
                                <option value="{{ country.id }}"{% if country.iso == 'CH' %} selected{% endif %}>
                                    {{ country.translated.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                {# Terms Checkbox #}
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="acceptedDataProtection" value="1" required>
                        <span>Ich habe die <a href="/datenschutz" target="_blank">Datenschutzerklärung</a> gelesen und akzeptiere die <a href="/agb" target="_blank">Allgemeinen Geschäftsbedingungen</a>.</span>
                    </label>
                </div>

                {# Cloudflare Turnstile Widget #}
                <div class="form-group turnstile-container">
                    <div class="cf-turnstile"
                         data-sitekey="0x4AAAAAACLCpKO4Tgee88q5"
                         data-theme="light"
                         data-size="normal">
                    </div>
                </div>

                <button type="submit" class="auth-btn primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Konto erstellen
                </button>
            </form>

            {# Register Benefits #}
            <div class="auth-benefits">
                <p class="benefits-title">Ihre Vorteile:</p>
                <ul>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Exklusive Angebote und Rabatte
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Schnellerer Checkout-Prozess
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Bestellhistorie und Tracking
                    </li>
                </ul>
            </div>

            {# Login Link #}
            <div class="auth-switch">
                <p>Bereits ein Konto?</p>
                <a href="{{ path('frontend.account.login.page') }}" class="auth-btn secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Anmelden
                </a>
            </div>
        </div>
        {% else %}
        {# ========== LOGIN CARD ========== #}
        <div class="auth-card">
            <div class="card-header">
                <h1>Willkommen zurück</h1>
                <p>Melden Sie sich bei Ihrem Konto an</p>
            </div>

            <form action="{{ path('frontend.account.login') }}"
                  method="post"
                  class="auth-form"
                  data-form-csrf-handler="true">

                <input type="hidden" name="redirectTo" value="{{ redirectTo }}">
                {% for key, value in redirectParameters %}
                    <input type="hidden" name="redirectParameters[{{ key }}]" value="{{ value }}">
                {% endfor %}

                <div class="form-group">
                    <label for="loginMail">E-Mail-Adresse</label>
                    <input type="email"
                           name="email"
                           id="loginMail"
                           placeholder="ihre@email.de"
                           autocomplete="email"
                           required>
                </div>

                <div class="form-group">
                    <label for="loginPassword">Passwort</label>
                    <input type="password"
                           name="password"
                           id="loginPassword"
                           placeholder="Ihr Passwort"
                           autocomplete="current-password"
                           required>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" name="remember" value="1">
                        <span>Angemeldet bleiben</span>
                    </label>
                    <a href="{{ path('frontend.account.recover.page') }}" class="forgot-link">
                        Passwort vergessen?
                    </a>
                </div>

                {# Cloudflare Turnstile Widget #}
                <div class="form-group turnstile-container">
                    <div class="cf-turnstile"
                         data-sitekey="0x4AAAAAACLCpKO4Tgee88q5"
                         data-theme="light"
                         data-size="normal">
                    </div>
                </div>

                <button type="submit" class="auth-btn primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Anmelden
                </button>
            </form>

            {# Login Benefits #}
            <div class="auth-benefits">
                <p class="benefits-title">Vorteile für Kunden:</p>
                <ul>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Express-Kauf ohne Dateneingabe
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Bestellübersicht und Tracking
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        Persönliche Einstellungen speichern
                    </li>
                </ul>
            </div>

            {# Register Link #}
            <div class="auth-switch">
                <p>Noch kein Konto?</p>
                <a href="{{ path('frontend.account.register.page') }}" class="auth-btn secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Konto erstellen
                </a>
            </div>
        </div>
        {% endif %}

        {# Trust Badges #}
        <div class="trust-badges">
            <div class="trust-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                SSL-verschlüsselt
            </div>
            <div class="trust-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                Sicher & Geschützt
            </div>
            <div class="trust-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Sichere Bezahlung
            </div>
        </div>

    </div>
</div>

{# Cloudflare Turnstile Script #}
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ============================================
   RAVEN LUXURY AUTH PAGES - Premium Design
   ============================================ */

:root {
    --raven-gold: #D4A847;
    --raven-gold-light: #E8C76B;
    --raven-gold-dark: #B8922E;
    --raven-charcoal: #1A1A1A;
    --raven-dark: #111111;
    --raven-gray-900: #1f2937;
    --raven-gray-700: #374151;
    --raven-gray-500: #6b7280;
    --raven-gray-300: #d1d5db;
    --raven-gray-100: #f3f4f6;
    --raven-cream: #FDFCF9;
    --raven-white: #ffffff;
}

/* ============ PAGE CONTAINER ============ */
.raven-auth-page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem 1.5rem;
    background: linear-gradient(180deg, var(--raven-cream) 0%, #F5F3EE 100%);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    position: relative;
}

/* Fullscreen mode - covers entire viewport */
.raven-auth-page.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    overflow-y: auto;
    z-index: 9999;
    padding-top: 5rem;
    padding-bottom: 2rem;
    align-items: flex-start;
}

/* Back to Homepage Button */
.back-home-btn {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.08);
    border-radius: 12px;
    color: var(--raven-gray-700);
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.back-home-btn:hover {
    background: var(--raven-white);
    color: var(--raven-gold-dark);
    border-color: var(--raven-gold);
    transform: translateX(-4px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.back-home-btn svg {
    transition: transform 0.3s ease;
}

.back-home-btn:hover svg {
    transform: translateX(-4px);
}

/* Subtle pattern overlay */
.raven-auth-page::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.03) 1px, transparent 0);
    background-size: 32px 32px;
    pointer-events: none;
}

.auth-wrapper {
    width: 100%;
    max-width: 480px;
    position: relative;
    z-index: 1;
}

/* ============ LOGO ============ */
.auth-logo {
    text-align: center;
    margin-bottom: 2.5rem;
}

.auth-logo a {
    display: inline-flex;
    justify-content: center;
    transition: transform 0.3s ease;
}

.auth-logo a:hover {
    transform: scale(1.02);
}

.logo-image {
    margin: 0 auto;
}

/* ============ AUTH CARD ============ */
.auth-card {
    background: var(--raven-white);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.04);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.auth-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 28px 80px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.04);
}

@media (min-width: 640px) {
    .auth-card {
        padding: 3rem;
    }
}

/* ============ CARD HEADER ============ */
.card-header {
    margin-bottom: 2rem;
    text-align: center;
}

.card-header h1 {
    font-family: 'Chakra Petch', sans-serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--raven-charcoal);
    margin: 0 0 0.5rem 0;
    letter-spacing: 0.02em;
    text-transform: uppercase;
}

.card-header p {
    font-size: 0.9375rem;
    color: var(--raven-gray-500);
    margin: 0;
    line-height: 1.5;
}

/* ============ FORM STYLES ============ */
.auth-form .form-group {
    margin-bottom: 1.5rem;
}

.auth-form label {
    display: block;
    font-weight: 600;
    color: var(--raven-charcoal);
    font-size: 0.8125rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.auth-form input[type="email"],
.auth-form input[type="password"],
.auth-form input[type="text"] {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    border: 2px solid var(--raven-gray-300);
    border-radius: 14px;
    background: var(--raven-white);
    color: var(--raven-charcoal);
    transition: all 0.25s ease;
    font-family: inherit;
    box-sizing: border-box;
}

.auth-form input:hover {
    border-color: var(--raven-gray-500);
}

.auth-form input:focus {
    outline: none;
    border-color: var(--raven-gold);
    box-shadow: 0 0 0 4px rgba(212, 168, 71, 0.15);
}

.auth-form input::placeholder {
    color: var(--raven-gray-500);
}

/* ============ FORM OPTIONS ============ */
.form-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.75rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.remember-me {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--raven-gray-700);
}

.remember-me input[type="checkbox"] {
    width: 18px;
    height: 18px;
    border-radius: 5px;
    accent-color: var(--raven-gold);
    cursor: pointer;
}

.forgot-link {
    font-size: 0.875rem;
    color: var(--raven-gold-dark);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease;
}

.forgot-link:hover {
    color: var(--raven-gold);
    text-decoration: underline;
}

/* ============ AUTH BUTTONS ============ */
.auth-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.625rem;
    width: 100%;
    padding: 1rem 1.5rem;
    border-radius: 14px;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.025em;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
}

.auth-btn.primary {
    background: linear-gradient(135deg, var(--raven-gold) 0%, var(--raven-gold-light) 50%, var(--raven-gold) 100%);
    background-size: 200% 100%;
    border: 2px solid var(--raven-gold-dark);
    color: var(--raven-charcoal);
    box-shadow: 0 6px 20px rgba(212, 168, 71, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.auth-btn.primary:hover {
    background-position: 100% 0;
    transform: translateY(-2px);
    box-shadow: 0 10px 28px rgba(212, 168, 71, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.3);
}

.auth-btn.secondary {
    background: transparent;
    border: 2px solid var(--raven-gray-300);
    color: var(--raven-gray-700);
}

.auth-btn.secondary:hover {
    border-color: var(--raven-gold);
    color: var(--raven-gold-dark);
    background: rgba(212, 168, 71, 0.05);
}

/* ============ AUTH BENEFITS ============ */
.auth-benefits {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--raven-gray-100);
}

.benefits-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--raven-gray-500);
    margin: 0 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.auth-benefits ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.auth-benefits li {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    color: var(--raven-gray-700);
    margin-bottom: 0.5rem;
}

.auth-benefits li svg {
    color: var(--raven-gold);
    flex-shrink: 0;
}

/* ============ AUTH SWITCH ============ */
.auth-switch {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--raven-gray-100);
    text-align: center;
}

.auth-switch p {
    font-size: 0.875rem;
    color: var(--raven-gray-500);
    margin: 0 0 1rem 0;
}

/* ============ REGISTER FORM STYLES ============ */
.auth-wrapper.register-mode {
    max-width: 520px;
}

.form-select {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    border: 2px solid var(--raven-gray-300);
    border-radius: 14px;
    background: var(--raven-white);
    color: var(--raven-charcoal);
    transition: all 0.25s ease;
    font-family: inherit;
    box-sizing: border-box;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
}

.form-select:hover {
    border-color: var(--raven-gray-500);
}

.form-select:focus {
    outline: none;
    border-color: var(--raven-gold);
    box-shadow: 0 0 0 4px rgba(212, 168, 71, 0.15);
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

.address-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--raven-gray-100);
}

.section-title {
    font-size: 0.8125rem;
    font-weight: 700;
    color: var(--raven-charcoal);
    margin: 0 0 1.25rem 0;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.checkbox-group {
    margin-top: 1.5rem;
    margin-bottom: 1.75rem;
}

.checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--raven-gray-700);
    line-height: 1.5;
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    min-width: 20px;
    border-radius: 5px;
    accent-color: var(--raven-gold);
    cursor: pointer;
    margin-top: 2px;
}

.checkbox-label a {
    color: var(--raven-gold-dark);
    font-weight: 600;
    text-decoration: none;
}

.checkbox-label a:hover {
    color: var(--raven-gold);
    text-decoration: underline;
}

/* ============ TRUST BADGES ============ */
.trust-badges {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-top: 2.5rem;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 16px;
    border: 1px solid rgba(0, 0, 0, 0.04);
}

.trust-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--raven-gray-700);
}

.trust-item svg {
    color: var(--raven-gold);
}

/* ============ TURNSTILE WIDGET ============ */
.turnstile-container {
    display: flex;
    justify-content: center;
    margin: 1.5rem 0;
}

.turnstile-container .cf-turnstile {
    transform-origin: center;
}

/* ============ HIDE DEFAULT ELEMENTS ============ */
.account-login-page,
.account-content,
.account-register {
    display: none !important;
}

/* ============ RESPONSIVE ============ */
@media (max-width: 640px) {
    .auth-wrapper {
        max-width: 100%;
    }

    .auth-card {
        padding: 2rem;
        border-radius: 20px;
    }

    .card-header h1 {
        font-size: 1.625rem;
    }

    .form-row {
        flex-direction: column;
        gap: 0;
    }

    .form-row .form-group {
        flex: none !important;
    }

    .trust-badges {
        gap: 1rem;
        padding: 1rem;
    }

    .trust-item {
        font-size: 0.75rem;
    }
}

/* Toast notification styles (inline for register page) */
#raven-toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    gap: 12px;
    pointer-events: none;
    max-width: calc(100vw - 48px);
}

.raven-toast {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-left-width: 4px;
    border-radius: 14px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12);
    pointer-events: auto;
    cursor: pointer;
    min-width: 320px;
    max-width: 420px;
    opacity: 0;
    transform: translateX(100%);
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.raven-toast--visible {
    opacity: 1;
    transform: translateX(0);
}

.raven-toast--hiding {
    opacity: 0;
    transform: translateX(100%);
}

.raven-toast--error { border-left-color: #dc2626; }
.raven-toast--error .raven-toast__icon { color: #dc2626; }
.raven-toast--success { border-left-color: #D4A847; }
.raven-toast--success .raven-toast__icon { color: #D4A847; }
.raven-toast--warning { border-left-color: #f59e0b; }
.raven-toast--warning .raven-toast__icon { color: #f59e0b; }
.raven-toast--info { border-left-color: #3b82f6; }
.raven-toast--info .raven-toast__icon { color: #3b82f6; }

.raven-toast__icon {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.raven-toast__content {
    flex: 1;
    min-width: 0;
}

.raven-toast__message {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    font-size: 15px;
    font-weight: 500;
    line-height: 1.5;
    color: #1f2937;
    word-wrap: break-word;
}

.raven-toast__close {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    margin: -4px -4px -4px 0;
    padding: 0;
    background: transparent;
    border: none;
    border-radius: 6px;
    color: #9ca3af;
    cursor: pointer;
    transition: color 0.15s ease, background-color 0.15s ease;
}

.raven-toast__close:hover {
    color: #374151;
    background-color: rgba(0, 0, 0, 0.05);
}

@media (max-width: 480px) {
    #raven-toast-container {
        top: 16px;
        right: 16px;
        left: 16px;
        max-width: none;
    }
    .raven-toast {
        min-width: auto;
        max-width: none;
        width: 100%;
        transform: translateY(-100%);
    }
    .raven-toast--visible { transform: translateY(0); }
    .raven-toast--hiding { transform: translateY(-100%); }
}
</style>

<script>
// Raven Toast - Inline for login/register pages
(function() {
    // ========== CART-BASED REDIRECT ==========
    // If user has items in cart, redirect to checkout after registration
    (async function() {
        try {
            var accessKeyMeta = document.querySelector('meta[name="sw-access-key"]');
            var accessKey = accessKeyMeta ? accessKeyMeta.content : '';

            // Get context token from cookie (identifies the guest cart session)
            var contextToken = '';
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.indexOf('sw-context-token=') === 0) {
                    contextToken = cookie.substring('sw-context-token='.length);
                    break;
                }
            }

            var headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'sw-access-key': accessKey
            };

            if (contextToken) {
                headers['sw-context-token'] = contextToken;
            }

            var response = await fetch('/store-api/checkout/cart', {
                method: 'GET',
                headers: headers
            });

            if (!response.ok) {
                console.log('Cart API error:', response.status);
                return;
            }

            var cart = await response.json();

            if (Array.isArray(cart.lineItems) && cart.lineItems.length > 0) {
                var redirectInput = document.querySelector('input[name="redirectTo"]');
                if (redirectInput && redirectInput.value === 'frontend.account.home.page') {
                    redirectInput.value = 'frontend.checkout.confirm.page';
                }
            }
        } catch (e) {
            console.log('Cart check failed, using default redirect');
        }
    })();

    const icons = {
        error: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
        success: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="9 12 12 15 16 10"></polyline></svg>',
        warning: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
        info: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
    };

    const durations = { error: 5000, success: 3000, warning: 4000, info: 4000 };

    function getContainer() {
        let container = document.getElementById('raven-toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'raven-toast-container';
            document.body.appendChild(container);
        }
        return container;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function removeToast(toast) {
        if (toast._removing) return;
        toast._removing = true;
        clearTimeout(toast._timeoutId);
        toast.classList.remove('raven-toast--visible');
        toast.classList.add('raven-toast--hiding');
        setTimeout(() => {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 300);
    }

    window.ravenToast = function(type, message, duration) {
        const container = getContainer();
        const toast = document.createElement('div');
        toast.className = 'raven-toast raven-toast--' + type;
        toast.setAttribute('role', 'alert');

        toast.innerHTML =
            '<div class="raven-toast__icon">' + (icons[type] || icons.info) + '</div>' +
            '<div class="raven-toast__content"><span class="raven-toast__message">' + escapeHtml(message) + '</span></div>' +
            '<button class="raven-toast__close" type="button"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>';

        container.appendChild(toast);

        requestAnimationFrame(function() {
            toast.classList.add('raven-toast--visible');
        });

        const closeBtn = toast.querySelector('.raven-toast__close');
        closeBtn.addEventListener('click', function() { removeToast(toast); });
        toast.addEventListener('click', function(e) {
            if (e.target === toast || e.target.closest('.raven-toast__content')) {
                removeToast(toast);
            }
        });

        const dismissTime = duration || durations[type] || 4000;
        toast._timeoutId = setTimeout(function() { removeToast(toast); }, dismissTime);

        toast.addEventListener('mouseenter', function() { clearTimeout(toast._timeoutId); });
        toast.addEventListener('mouseleave', function() {
            toast._timeoutId = setTimeout(function() { removeToast(toast); }, 1000);
        });
    };

    console.log('Raven Toast initialized on auth page');

    // ========== GERMAN TRANSLATIONS FOR SHOPWARE VALIDATION MESSAGES ==========
    // Define translations FIRST so they can be used by Twig-generated code
    const germanTranslations = {
        // Email validation
        'This value is already used.': 'Diese E-Mail-Adresse wird bereits verwendet.',
        'This email address is already registered.': 'Diese E-Mail-Adresse ist bereits registriert.',
        'The email address is already in use.': 'Diese E-Mail-Adresse wird bereits verwendet.',
        'This value is not a valid email address.': 'Bitte geben Sie eine gültige E-Mail-Adresse ein.',
        'Please enter a valid email address.': 'Bitte geben Sie eine gültige E-Mail-Adresse ein.',

        // Password validation
        'The password is too short.': 'Das Passwort ist zu kurz.',
        'The password must be at least 8 characters.': 'Das Passwort muss mindestens 8 Zeichen lang sein.',
        'The passwords do not match.': 'Die Passwörter stimmen nicht überein.',
        'The password confirmation does not match.': 'Die Passwortbestätigung stimmt nicht überein.',
        'Password must be at least {{ limit }} characters long.': 'Das Passwort muss mindestens 8 Zeichen lang sein.',

        // Required fields
        'This field is required.': 'Dieses Feld ist erforderlich.',
        'This value should not be blank.': 'Dieses Feld darf nicht leer sein.',
        'Please fill out this field.': 'Bitte füllen Sie dieses Feld aus.',

        // Name validation
        'First name is required.': 'Vorname ist erforderlich.',
        'Last name is required.': 'Nachname ist erforderlich.',

        // Address validation
        'Street is required.': 'Strasse ist erforderlich.',
        'City is required.': 'Stadt ist erforderlich.',
        'Postal code is required.': 'PLZ ist erforderlich.',
        'Country is required.': 'Land ist erforderlich.',
        'Please select a country.': 'Bitte wählen Sie ein Land aus.',

        // General validation
        'An error occurred.': 'Ein Fehler ist aufgetreten.',
        'Please check your input.': 'Bitte überprüfen Sie Ihre Eingaben.',
        'The form contains errors.': 'Das Formular enthält Fehler.',
        'Registration failed.': 'Registrierung fehlgeschlagen.',
        'Please accept the terms and conditions.': 'Bitte akzeptieren Sie die Allgemeinen Geschäftsbedingungen.',
        'Please accept the data protection guidelines.': 'Bitte akzeptieren Sie die Datenschutzerklärung.',
        'You must accept the privacy policy.': 'Sie müssen die Datenschutzerklärung akzeptieren.',
        'You must accept the terms and conditions.': 'Sie müssen die AGB akzeptieren.',

        // Account exists
        'A customer with the email address': 'Ein Kunde mit dieser E-Mail-Adresse existiert bereits.',
        'already exists': 'existiert bereits.',

        // Payment/Shipping change messages (cart validation)
        'payment is not available': 'Die Zahlungsart wurde automatisch angepasst.',
        'shipping is not available': 'Die Versandart wurde automatisch angepasst.',
        'was changed to': 'wurde geändert zu'
    };

    function translateToGerman(message) {
        // Direct match
        if (germanTranslations[message]) {
            return germanTranslations[message];
        }

        // Cart validation: Payment method changed
        if (message.toLowerCase().includes('payment') && message.toLowerCase().includes('not available')) {
            return 'Die Zahlungsart wurde automatisch angepasst.';
        }

        // Cart validation: Shipping method changed
        if (message.toLowerCase().includes('shipping') && message.toLowerCase().includes('not available')) {
            return 'Die Versandart wurde automatisch angepasst.';
        }

        // Partial match for messages containing dynamic values
        for (const [englishKey, germanValue] of Object.entries(germanTranslations)) {
            if (message.toLowerCase().includes(englishKey.toLowerCase())) {
                return germanValue;
            }
        }

        // Check for email already exists pattern
        if (message.toLowerCase().includes('already') && message.toLowerCase().includes('email')) {
            return 'Diese E-Mail-Adresse wird bereits verwendet.';
        }
        if (message.toLowerCase().includes('already') && message.toLowerCase().includes('customer')) {
            return 'Ein Kunde mit dieser E-Mail-Adresse existiert bereits.';
        }

        // Return original if no translation found
        return message;
    }

    // ========== DYNAMIC ERROR/SUCCESS HANDLING ==========

    // 1. Login errors (Twig-based)
    {% if loginError %}
    window.ravenToast('error', translateToGerman('{{ errorSnippet|default('Die Anmeldedaten sind nicht korrekt.')|trans|e('js') }}'));
    {% endif %}

    // 2. Registration form violations (Shopware 6 passes these via formViolations)
    {% if formViolations is defined and formViolations is not empty %}
        {% for violation in formViolations %}
    window.ravenToast('error', translateToGerman('{{ violation.message|e('js') }}'));
        {% endfor %}
    {% endif %}

    // 3. Flash messages from Shopware (success, danger, warning, info)
    {% for type, messages in app.flashes() %}
        {% for message in messages %}
            {% if type == 'success' %}
    window.ravenToast('success', translateToGerman('{{ message|trans|e('js') }}'));
            {% elseif type == 'danger' or type == 'error' %}
    window.ravenToast('error', translateToGerman('{{ message|trans|e('js') }}'));
            {% elseif type == 'warning' %}
    window.ravenToast('warning', translateToGerman('{{ message|trans|e('js') }}'));
            {% else %}
    window.ravenToast('info', translateToGerman('{{ message|trans|e('js') }}'));
            {% endif %}
        {% endfor %}
    {% endfor %}

    // JavaScript fallback for URL params and DOM-based errors
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        // ========== SET FLAG FOR WELCOME TOAST ON CHECKOUT ==========
        // When register form is submitted, set flag so checkout page can show welcome toast
        const registerForm = document.querySelector('.register-form');
        if (registerForm) {
            registerForm.addEventListener('submit', function() {
                // Check if redirecting to checkout (not to account home)
                const redirectInput = registerForm.querySelector('input[name="redirectTo"]');
                if (redirectInput && redirectInput.value.includes('checkout')) {
                    sessionStorage.setItem('ravenJustRegistered', 'true');
                }
            });
        }

        // Login error via URL
        if (urlParams.get('loginError') === '1' || urlParams.has('loginError')) {
            window.ravenToast('error', 'Die Anmeldedaten sind nicht korrekt.');
        }

        // Registration error via URL
        if (urlParams.has('registrationError') || urlParams.has('registerError')) {
            window.ravenToast('error', 'Bei der Registrierung ist ein Fehler aufgetreten. Bitte überprüfen Sie Ihre Eingaben.');
        }

        // Success via URL (after redirect)
        if (urlParams.has('registrationSuccess') || urlParams.has('success')) {
            window.ravenToast('success', 'Ihr Konto wurde erfolgreich erstellt!');
        }

        // Detect any .alert elements that Shopware might inject
        const alerts = document.querySelectorAll('.alert, .alert-danger, .alert-warning, .alert-success, .alert-info');
        alerts.forEach(function(alert) {
            let message = alert.textContent.trim();
            if (!message) return;

            // Translate English messages to German
            message = translateToGerman(message);

            let type = 'info';
            if (alert.classList.contains('alert-danger') || alert.classList.contains('alert-error')) {
                type = 'error';
            } else if (alert.classList.contains('alert-success')) {
                type = 'success';
            } else if (alert.classList.contains('alert-warning')) {
                type = 'warning';
            }

            window.ravenToast(type, message);
            alert.style.display = 'none'; // Hide original alert
        });

        // Detect Shopware form violation elements
        const violations = document.querySelectorAll('.invalid-feedback, .form-error, [data-form-violations]');
        violations.forEach(function(violation) {
            let message = violation.textContent.trim();
            if (message) {
                // Translate English messages to German
                message = translateToGerman(message);
                window.ravenToast('error', message);
            }
        });
    });
})();
</script>
{% endblock %}
