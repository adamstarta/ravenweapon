{% sw_extends '@Storefront/storefront/page/search/index.html.twig' %}

{% block base_main_inner %}
<main class="raven-all-products-page">
    {# Hero Banner #}
    <section class="all-products-hero" style="background: #1a1a1a; padding: 3rem 0 4rem; position: relative; overflow: hidden;">

        <div class="max-w-7xl mx-auto px-6 lg:px-24 relative z-10">
            {# Breadcrumb #}
            <nav class="breadcrumb" style="margin-bottom: 1.5rem;" aria-label="Breadcrumb">
                <div style="display: flex; align-items: center; gap: 0.5rem; font-family: 'Inter', sans-serif; font-size: 0.875rem;">
                    <a href="{{ path('frontend.home.page') }}" style="color: rgba(255,255,255,0.6); text-decoration: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                    </a>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                    <span style="color: #F2B90D; font-weight: 500;">{% if page.searchTerm %}{{ page.searchTerm }}{% else %}Alle Produkte{% endif %}</span>
                </div>
            </nav>

            {# Title #}
            <h1 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 700; color: white; line-height: 1.1; margin: 0;">
                {% if page.searchTerm %}
                    {{ page.searchTerm }}
                {% else %}
                    Alle Produkte
                {% endif %}
            </h1>

            {% if page.listing.total is defined %}
            <p style="font-family: 'Inter', sans-serif; font-size: 1.125rem; color: rgba(255,255,255,0.7); margin-top: 1rem;">
                <span style="color: #F2B90D; font-weight: 600;">{{ page.listing.total }}</span> {% if page.listing.total == 1 %}Produkt{% else %}Produkte{% endif %} gefunden
            </p>
            {% endif %}
        </div>
    </section>

    {# Filter Bar - Matching Category Page Style #}
    <section class="filter-bar" style="background: white; border-bottom: 1px solid #e5e7eb;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">
            <div class="raven-filter-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; gap: 0.75rem; flex-wrap: wrap;">
                {# Left side: Filter buttons - Same as category pages #}
                <div class="raven-filters-left" style="display: flex; flex-wrap: wrap; gap: 0.625rem;">
                    {# Preis (Price) Filter #}
                    <div class="raven-filter-group" style="position: relative;">
                        <button type="button" class="raven-filter-btn" data-filter-toggle="price" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.125rem; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 9999px; font-size: 0.9375rem; font-weight: 500; color: #333; cursor: pointer; font-family: 'Inter', sans-serif; white-space: nowrap;">
                            Preis
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.7;"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <div class="raven-filter-dropdown" data-filter-panel="price" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; min-width: 260px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" id="raven-price-min" placeholder="Min" min="0" style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; width: 100px;">
                                <span style="color: #999;">–</span>
                                <input type="number" id="raven-price-max" placeholder="Max" min="0" style="flex: 1; padding: 0.5rem 0.75rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; width: 100px;">
                                <span style="color: #666; font-size: 0.875rem;">CHF</span>
                            </div>
                            <button type="button" class="raven-filter-apply" data-apply-filter="price" style="width: 100%; margin-top: 1rem; padding: 0.625rem 1rem; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">Anwenden</button>
                        </div>
                    </div>

                    {# Hersteller (Manufacturer) Filter #}
                    <div class="raven-filter-group" style="position: relative;">
                        <button type="button" class="raven-filter-btn" data-filter-toggle="manufacturer" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.125rem; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 9999px; font-size: 0.9375rem; font-weight: 500; color: #333; cursor: pointer; font-family: 'Inter', sans-serif; white-space: nowrap;">
                            Hersteller
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.7;"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <div class="raven-filter-dropdown" data-filter-panel="manufacturer" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; min-width: 260px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; padding: 1rem; max-height: 300px; overflow-y: auto;">
                            {# All manufacturers - listed from products in the system #}
                                <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                    <input type="checkbox" id="mfr-acheron" value="Acheron" data-filter-manufacturer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                    <label for="mfr-acheron" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Acheron</label>
                                </div>
                                <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                    <input type="checkbox" id="mfr-aimpact" value="Aimpact" data-filter-manufacturer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                    <label for="mfr-aimpact" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Aimpact</label>
                                </div>
                                <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                    <input type="checkbox" id="mfr-lockhart" value="Lockhart Tactical" data-filter-manufacturer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                    <label for="mfr-lockhart" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Lockhart Tactical</label>
                                </div>
                                <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                    <input type="checkbox" id="mfr-magpul" value="Magpul" data-filter-manufacturer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                    <label for="mfr-magpul" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Magpul</label>
                                </div>
                                <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                    <input type="checkbox" id="mfr-zerotolerance" value="Zero Tolerance" data-filter-manufacturer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                    <label for="mfr-zerotolerance" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Zero Tolerance</label>
                                </div>
                            <button type="button" class="raven-filter-apply" data-apply-filter="manufacturer" style="width: 100%; margin-top: 1rem; padding: 0.625rem 1rem; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">Anwenden</button>
                        </div>
                    </div>

                    {# Im Angebot (On Offer) Filter #}
                    <div class="raven-filter-group" style="position: relative;">
                        <button type="button" class="raven-filter-btn" data-filter-toggle="offer" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.125rem; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 9999px; font-size: 0.9375rem; font-weight: 500; color: #333; cursor: pointer; font-family: 'Inter', sans-serif; white-space: nowrap;">
                            Im Angebot
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.7;"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <div class="raven-filter-dropdown" data-filter-panel="offer" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; min-width: 260px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; padding: 1rem;">
                            <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                <input type="checkbox" id="offer-yes" value="1" data-filter-offer style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                <label for="offer-yes" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Nur Angebote anzeigen</label>
                            </div>
                            <button type="button" class="raven-filter-apply" data-apply-filter="offer" style="width: 100%; margin-top: 1rem; padding: 0.625rem 1rem; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">Anwenden</button>
                        </div>
                    </div>

                    {# Lagerstatus (Stock Status) Filter #}
                    <div class="raven-filter-group" style="position: relative;">
                        <button type="button" class="raven-filter-btn" data-filter-toggle="stock" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1.125rem; background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 9999px; font-size: 0.9375rem; font-weight: 500; color: #333; cursor: pointer; font-family: 'Inter', sans-serif; white-space: nowrap;">
                            Lagerstatus
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.7;"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <div class="raven-filter-dropdown" data-filter-panel="stock" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; min-width: 260px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; padding: 1rem;">
                            <div class="raven-filter-option" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; cursor: pointer;">
                                <input type="checkbox" id="stock-available" value="1" data-filter-stock style="width: 18px; height: 18px; accent-color: #D4A847; cursor: pointer;">
                                <label for="stock-available" style="font-size: 0.875rem; color: #374151; cursor: pointer; flex: 1;">Nur verfügbare Artikel</label>
                            </div>
                            <button type="button" class="raven-filter-apply" data-apply-filter="stock" style="width: 100%; margin-top: 1rem; padding: 0.625rem 1rem; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer;">Anwenden</button>
                        </div>
                    </div>
                </div>

                {# Right side: Sorting only #}
                <div class="raven-right-controls" style="display: flex; align-items: center; gap: 0.75rem;">
                    <div class="raven-sort-wrapper" style="position: relative;">
                        <button type="button" class="raven-sort-btn" data-sort-toggle style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: transparent; border: none; font-size: 0.9375rem; font-weight: 500; color: #333; cursor: pointer; font-family: 'Inter', sans-serif;">
                            <span data-sort-label>Neueste</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: #D4A847;"><polyline points="6 9 12 15 18 9"/></svg>
                        </button>
                        <div class="raven-sort-menu" data-sort-menu style="display: none; position: absolute; top: 100%; right: 0; margin-top: 4px; min-width: 180px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 100; overflow: hidden;">
                            <a href="#" data-sort-value="name-asc" style="display: block; padding: 0.75rem 1rem; font-size: 0.875rem; color: #374151; text-decoration: none;">Name A-Z</a>
                            <a href="#" data-sort-value="name-desc" style="display: block; padding: 0.75rem 1rem; font-size: 0.875rem; color: #374151; text-decoration: none;">Name Z-A</a>
                            <a href="#" data-sort-value="price-asc" style="display: block; padding: 0.75rem 1rem; font-size: 0.875rem; color: #374151; text-decoration: none;">Preis aufsteigend</a>
                            <a href="#" data-sort-value="price-desc" style="display: block; padding: 0.75rem 1rem; font-size: 0.875rem; color: #374151; text-decoration: none;">Preis absteigend</a>
                        </div>
                    </div>
                </div>
            </div>

            {# Pagination Row - Below Filter Bar #}
            {% set totalProducts = page.listing.total|default(0) %}
            {% set perPage = 24 %}
            {% set currentPage = app.request.get('p')|default(1) %}
            {% set totalPages = ((totalProducts / perPage)|round(0, 'ceil'))|default(1) %}

            {% if totalPages > 1 %}
            <div class="raven-pagination-row" style="display: flex; justify-content: flex-end; align-items: center; padding: 0.5rem 0; margin-bottom: 0.5rem;">
                <nav class="pagination-nav" aria-label="Pagination" style="display: flex; align-items: center; gap: 0.25rem;">
                    {# Previous Page #}
                    {% if currentPage > 1 %}
                    <a href="?search={{ page.searchTerm|default('') }}&p={{ currentPage - 1 }}" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; color: #374151; text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </a>
                    {% endif %}

                    {# Page Numbers #}
                    {% for i in 1..totalPages %}
                        {% if i == currentPage %}
                        <span style="display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; padding: 0 8px; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; border-radius: 6px; font-size: 0.875rem; font-weight: 600; border: 1px solid #C59A0F;">{{ i }}</span>
                        {% elseif i <= 5 or i > totalPages - 2 or (i >= currentPage - 1 and i <= currentPage + 1) %}
                        <a href="?search={{ page.searchTerm|default('') }}&p={{ i }}" style="display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; padding: 0 8px; color: #374151; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500;">{{ i }}</a>
                        {% elseif i == 6 or i == totalPages - 2 %}
                        <span style="padding: 0 4px; color: #9ca3af;">...</span>
                        {% endif %}
                    {% endfor %}

                    {# Next Page #}
                    {% if currentPage < totalPages %}
                    <a href="?search={{ page.searchTerm|default('') }}&p={{ currentPage + 1 }}" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; color: #374151; text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}
        </div>
    </section>

    {# Filter Sidebar - Hidden by default #}
    <div id="filter-sidebar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
        <div id="filter-backdrop" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);"></div>
        <div id="filter-panel" style="position: absolute; top: 0; left: 0; width: 320px; max-width: 90vw; height: 100%; background: white; box-shadow: 4px 0 20px rgba(0,0,0,0.15); overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s ease;">
            <div style="padding: 1.5rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3 style="font-family: 'Chakra Petch', sans-serif; font-size: 1.25rem; font-weight: 600; color: #111827; margin: 0;">Filter</h3>
                    <button id="filter-close-btn" style="width: 32px; height: 32px; border: none; background: #f3f4f6; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                {# Price Range Filter #}
                <div class="filter-group" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 600; color: #374151; margin: 0 0 1rem 0;">Preis</h4>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Min (CHF)</label>
                            <input type="number" id="price-min" placeholder="0" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                        </div>
                        <span style="color: #9ca3af; margin-top: 1rem;">–</span>
                        <div style="flex: 1;">
                            <label style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 0.25rem;">Max (CHF)</label>
                            <input type="number" id="price-max" placeholder="10000" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem;">
                        </div>
                    </div>
                </div>

                {# Category Filter #}
                <div class="filter-group" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 600; color: #374151; margin: 0 0 1rem 0;">Kategorie</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        {% for treeItem in page.header.navigation.tree %}
                            {% set category = treeItem.category %}
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" class="category-filter" value="{{ category.id }}" style="width: 16px; height: 16px; accent-color: #D4A847;">
                                <span style="font-size: 0.875rem; color: #374151;">{{ category.translated.name }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

                {# Manufacturer Filter #}
                {% if page.listing.aggregations.manufacturer is defined and page.listing.aggregations.manufacturer.entities|length > 0 %}
                <div class="filter-group" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h4 style="font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 600; color: #374151; margin: 0 0 1rem 0;">Hersteller</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        {% for manufacturer in page.listing.aggregations.manufacturer.entities %}
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" class="manufacturer-filter" value="{{ manufacturer.id }}" style="width: 16px; height: 16px; accent-color: #D4A847;">
                                <span style="font-size: 0.875rem; color: #374151;">{{ manufacturer.translated.name }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {# Availability Filter #}
                <div class="filter-group" style="margin-bottom: 1.5rem;">
                    <h4 style="font-family: 'Inter', sans-serif; font-size: 0.875rem; font-weight: 600; color: #374151; margin: 0 0 1rem 0;">Verfügbarkeit</h4>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='transparent'">
                        <input type="checkbox" id="in-stock-filter" style="width: 16px; height: 16px; accent-color: #D4A847;">
                        <span style="font-size: 0.875rem; color: #374151;">Nur verfügbare Produkte</span>
                    </label>
                </div>

                {# Apply Filters Button #}
                <button id="apply-filters-btn" style="width: 100%; padding: 0.875rem; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; font-weight: 600; border: 1px solid #C59A0F; border-radius: 8px; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.9375rem;">
                    Filter anwenden
                </button>
                <button id="reset-filters-btn" style="width: 100%; padding: 0.75rem; background: transparent; color: #6b7280; font-weight: 500; border: none; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 0.875rem; margin-top: 0.5rem;">
                    Filter zurücksetzen
                </button>
            </div>
        </div>
    </div>

    {# Products Section #}
    <section class="products-section" style="background: #f9fafb; padding: 3rem 0 5rem;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">

            {% if page.listing.elements|length > 0 %}
            {# Product Grid #}
            <div class="product-grid" style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 1.5rem;">
                {% for product in page.listing.elements %}
                <article class="raven-product-card" style="background: white; cursor: pointer;">
                    <a href="{{ seoUrl('frontend.detail.page', { productId: product.id }) }}" style="text-decoration: none; color: inherit; display: block;">
                        <div style="height: 18rem; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                            {% if product.cover.media %}
                                <img class="product-img" src="{{ product.cover.media.url }}" alt="{{ product.translated.name }}" style="max-width: 100%; max-height: 100%; object-fit: contain; padding: 0.75rem;">
                            {% else %}
                                <div style="color: #d1d5db;">
                                    {% sw_icon 'placeholder' style { 'size': 'lg' } %}
                                </div>
                            {% endif %}
                        </div>
                    </a>
                    <div style="padding: 0.75rem 1.5rem 1rem;">
                        <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
                            <div style="flex: 1;">
                                <div style="color: #E53935; font-weight: 600; font-size: 16px; line-height: 1.2;">
                                    {% if product.calculatedPrice %}
                                        CHF {{ product.calculatedPrice.unitPrice|number_format(2, '.', "'") }}
                                    {% endif %}
                                </div>
                                {# Star Ratings - Use ratingAverage which is available in listings #}
                                {% if product.ratingAverage and product.ratingAverage > 0 %}
                                    {% set rating = product.ratingAverage|round %}
                                    <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                        <div style="display: flex; gap: 2px;">
                                            {% for i in 1..5 %}
                                                {% if rating >= i %}
                                                    <svg style="width: 14px; height: 14px; color: #D4A847;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                                {% else %}
                                                    <svg style="width: 14px; height: 14px; color: #D1D5DB;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <span style="font-size: 0.75rem; color: #6b7280;">({{ product.ratingAverage|number_format(1) }})</span>
                                    </div>
                                {% endif %}
                                <div style="color: #374151; font-size: 1rem; margin-top: 0.25rem;">
                                    <div style="font-weight: 700;">{{ product.manufacturer.translated.name|default('') }}</div>
                                    <a href="{{ seoUrl('frontend.detail.page', { productId: product.id }) }}" style="color: inherit; text-decoration: none;">{{ product.translated.name }}</a>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-top: -0.5rem;">
                                <span style="width: 20px; height: 20px; border-radius: 50%; background: {% if product.availableStock > 0 or product.isCloseout == false %}linear-gradient(135deg, #22c55e 0%, #16a34a 100%){% else %}linear-gradient(135deg, #ef4444 0%, #dc2626 100%){% endif %}; display: inline-flex; align-items: center; justify-content: center;" title="{% if product.availableStock > 0 or product.isCloseout == false %}Verfügbar{% else %}Nicht verfügbar{% endif %}">
                                    <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;">{% if product.availableStock > 0 or product.isCloseout == false %}<path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>{% else %}<path d="M6 18L18 6M6 6l12 12" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>{% endif %}</svg>
                                </span>
                                <form action="{{ path('frontend.checkout.line-item.add') }}" method="post" data-form-csrf-handler="true">
                                    <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas">
                                    <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                                    <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1">
                                    <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                                    <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}">
                                    <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1">
                                    <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1">
                                    <button type="submit" style="width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 0.375rem; background: transparent; border: none; color: #374151; cursor: pointer;" title="In den Warenkorb">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" style="width: 24px; height: 24px;"><path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/></svg>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </div>

            {# Bottom Pagination #}
            {% if totalPages > 1 %}
            <div class="pagination-wrapper" style="margin-top: 3rem; display: flex; justify-content: center;">
                <nav class="pagination-nav" aria-label="Pagination" style="display: flex; align-items: center; gap: 0.25rem; background: white; padding: 0.5rem 1rem; border-radius: 12px; border: 1px solid #e5e7eb;">
                    {# Previous Page #}
                    {% if currentPage > 1 %}
                    <a href="?search={{ page.searchTerm|default('') }}&p={{ currentPage - 1 }}" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; color: #374151; text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </a>
                    {% endif %}

                    {# Page Numbers #}
                    {% for i in 1..totalPages %}
                        {% if i == currentPage %}
                        <span style="display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; padding: 0 8px; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; border-radius: 6px; font-size: 0.875rem; font-weight: 600; border: 1px solid #C59A0F;">{{ i }}</span>
                        {% elseif i <= 5 or i > totalPages - 2 or (i >= currentPage - 1 and i <= currentPage + 1) %}
                        <a href="?search={{ page.searchTerm|default('') }}&p={{ i }}" style="display: flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; padding: 0 8px; color: #374151; text-decoration: none; border-radius: 6px; font-size: 0.875rem; font-weight: 500;">{{ i }}</a>
                        {% elseif i == 6 or i == totalPages - 2 %}
                        <span style="padding: 0 4px; color: #9ca3af;">...</span>
                        {% endif %}
                    {% endfor %}

                    {# Next Page #}
                    {% if currentPage < totalPages %}
                    <a href="?search={{ page.searchTerm|default('') }}&p={{ currentPage + 1 }}" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; color: #374151; text-decoration: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </a>
                    {% endif %}
                </nav>
            </div>
            {% endif %}

            {% else %}
            {# Empty State #}
            <div class="empty-state" style="text-align: center; padding: 5rem 2rem; background: white; border-radius: 20px; border: 1px solid #e5e7eb;">
                <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <h3 style="font-family: 'Chakra Petch', sans-serif; font-size: 1.5rem; font-weight: 600; color: #111827; margin-bottom: 0.5rem;">Keine Produkte gefunden</h3>
                <p style="font-family: 'Inter', sans-serif; color: #6b7280; margin-bottom: 2rem;">Versuchen Sie es mit anderen Suchbegriffen.</p>
                <a href="{{ path('frontend.home.page') }}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.5rem; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; font-weight: 600; border-radius: 0.5rem; text-decoration: none; border: 1px solid #C59A0F;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Zur Startseite
                </a>
            </div>
            {% endif %}
        </div>
    </section>
</main>


<style>
@media (min-width: 640px) { .product-grid { grid-template-columns: repeat(2, 1fr) !important; } }
@media (min-width: 768px) { .product-grid { grid-template-columns: repeat(4, 1fr) !important; } }

.raven-product-card {
    transition: all 0.3s ease;
    position: relative;
    background: white !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    overflow: visible !important;
}
.raven-product-card:hover .product-img { transform: scale(1.05); }
.product-img { transition: transform 0.3s ease; }
</style>

<script>
(function() {
    'use strict';

    // Filter dropdown toggle
    document.querySelectorAll('[data-filter-toggle]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            var type = btn.getAttribute('data-filter-toggle');
            var panel = document.querySelector('[data-filter-panel="' + type + '"]');
            // Close other dropdowns
            document.querySelectorAll('.raven-filter-dropdown').forEach(function(p) {
                if (p !== panel) p.style.display = 'none';
            });
            var sortMenu = document.querySelector('[data-sort-menu]');
            if (sortMenu) sortMenu.style.display = 'none';
            // Toggle this dropdown
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        });
    });

    // Sort toggle
    var sortBtn = document.querySelector('[data-sort-toggle]');
    var sortMenu = document.querySelector('[data-sort-menu]');
    if (sortBtn && sortMenu) {
        sortBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            document.querySelectorAll('.raven-filter-dropdown').forEach(function(p) {
                p.style.display = 'none';
            });
            sortMenu.style.display = sortMenu.style.display === 'block' ? 'none' : 'block';
        });

        sortMenu.querySelectorAll('a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector('[data-sort-label]').textContent = link.textContent;
                sortMenu.style.display = 'none';
                var url = new URL(window.location);
                url.searchParams.set('order', link.getAttribute('data-sort-value'));
                window.location.href = url.toString();
            });
        });
    }

    // Close on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.raven-filter-group') && !e.target.closest('.raven-sort-wrapper')) {
            document.querySelectorAll('.raven-filter-dropdown').forEach(function(p) {
                p.style.display = 'none';
            });
            if (sortMenu) sortMenu.style.display = 'none';
        }
    });

    // Apply price filter
    document.querySelectorAll('[data-apply-filter="price"]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var currentUrl = new URL(window.location.href);
            var priceMin = document.getElementById('raven-price-min').value;
            var priceMax = document.getElementById('raven-price-max').value;
            if (priceMin) currentUrl.searchParams.set('min-price', priceMin);
            else currentUrl.searchParams.delete('min-price');
            if (priceMax) currentUrl.searchParams.set('max-price', priceMax);
            else currentUrl.searchParams.delete('max-price');
            window.location.href = currentUrl.toString();
        });
    });

    // Apply manufacturer filter
    document.querySelectorAll('[data-apply-filter="manufacturer"]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var currentUrl = new URL(window.location.href);
            var manufacturerFilters = document.querySelectorAll('[data-filter-manufacturer]:checked');
            var manufacturers = Array.from(manufacturerFilters).map(function(cb) { return cb.value; });
            if (manufacturers.length > 0) {
                currentUrl.searchParams.set('manufacturer', manufacturers.join('|'));
            } else {
                currentUrl.searchParams.delete('manufacturer');
            }
            window.location.href = currentUrl.toString();
        });
    });

    // Apply stock filter
    document.querySelectorAll('[data-apply-filter="stock"]').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var currentUrl = new URL(window.location.href);
            var stockFilter = document.querySelector('[data-filter-stock]:checked');
            if (stockFilter) {
                currentUrl.searchParams.set('stock', '1');
            } else {
                currentUrl.searchParams.delete('stock');
            }
            window.location.href = currentUrl.toString();
        });
    });

    // Restore filter state from URL
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('min-price') && document.getElementById('raven-price-min')) {
        document.getElementById('raven-price-min').value = urlParams.get('min-price');
    }
    if (urlParams.get('max-price') && document.getElementById('raven-price-max')) {
        document.getElementById('raven-price-max').value = urlParams.get('max-price');
    }
    if (urlParams.get('stock') && document.getElementById('stock-available')) {
        document.getElementById('stock-available').checked = true;
    }

    console.log('Raven search filters initialized');
})();
</script>
{% endblock %}
