{% sw_extends '@Storefront/storefront/page/content/index.html.twig' %}

{% block base_main_inner %}
{# Only show custom homepage for the actual homepage (entry point category, not child categories) #}
{# Check if we're on the root entry point by verifying the category has no parent in the visible navigation #}
{% set isHomepage = (page.cmsPage.type == 'landingpage' and page.header.navigation.active.parentId is null) or (page.header.navigation.active.id == page.header.navigation.active.path|first and page.header.navigation.active.path|length == 1) %}
{% if isHomepage %}

{# Hide Shopware flash messages - we use cart sidebar instead #}
<style>
    .alert[role="alert"],
    .flashbags,
    .alert-content,
    .alert.alert-info,
    .alert.alert-success,
    .alert.alert-warning {
        display: none !important;
    }
</style>

<main class="raven-homepage">

    {# ========================================== #}
    {# HERO SECTION #}
    {# ========================================== #}
    <section class="raven-hero relative w-full overflow-hidden" style="min-height: 520px; padding: 6rem 0 4rem; margin-top: -20px;">
        <div class="absolute bg-cover bg-no-repeat" style="background-image: url('{{ asset('bundles/raventheme/assets/hero-background.jpg') }}'); top: -40px; left: 0; right: 0; bottom: -40px; background-position: center center;"></div>
        <div class="absolute inset-0" style="background: linear-gradient(to bottom, rgba(0,0,0,0.25), rgba(0,0,0,0.55), rgba(0,0,0,0.65));"></div>

        <div class="relative z-10 max-w-7xl mx-auto px-6 lg:px-24 text-white">
            <h1 class="raven-hero-title mb-3" style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(2rem, 5vw, 4rem); font-weight: 700; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; line-height: 1.3; padding-top: 0.15em;">
                RAVEN WEAPON AG
            </h1>

            <h2 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(1.25rem, 3vw, 2.5rem); font-weight: 400; color: white; margin-bottom: 1.5rem; max-width: 42rem;">
                Eine Waffe für jede Mission,<br>genau wie Du sie willst
            </h2>

            <ul style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(1rem, 2vw, 1.75rem); font-weight: 600; color: white; margin-bottom: 2.5rem; list-style: none; padding-left: 2rem;">
                <li style="position: relative; margin-bottom: 0.25rem;">
                    <span style="position: absolute; left: -1.5rem; top: 50%; transform: translateY(-50%); width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%;"></span>
                    Schweizer Familienbetrieb
                </li>
                <li style="position: relative; margin-bottom: 0.25rem;">
                    <span style="position: absolute; left: -1.5rem; top: 50%; transform: translateY(-50%); width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%;"></span>
                    Made in Canada
                </li>
                <li style="position: relative;">
                    <span style="position: absolute; left: -1.5rem; top: 50%; transform: translateY(-50%); width: 0.5rem; height: 0.5rem; background: white; border-radius: 50%;"></span>
                    Höchste Qualität
                </li>
            </ul>

            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
                <a href="/alle-produkte/" class="btn btn-primary" style="display: inline-flex; align-items: center; padding: 0.5rem 1.25rem; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; font-weight: 600; border-radius: 0.5rem; text-decoration: none; border: 1px solid #C59A0F; box-shadow: 0 2px 6px rgba(0,0,0,0.25);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                    <span style="margin-left: 0.5rem;">Zum Shop</span>
                </a>
                <a href="/impressum" style="display: inline-flex; align-items: center; padding: 0.5rem 1rem; background: white; color: #414651; font-weight: 600; border-radius: 0.5rem; text-decoration: none; border: 1px solid #d1d5db; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    Über uns
                    <svg style="width: 1rem; height: 1rem; margin-left: 0.5rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"></path></svg>
                </a>
            </div>
        </div>
    </section>

    {# ========================================== #}
    {# PRODUCTS SECTION - 3 Rifles + 3 Caliber Kits #}
    {# ========================================== #}
    <style>
        @media (min-width: 640px) { .raven-product-grid { grid-template-columns: repeat(2, 1fr) !important; } }
        @media (min-width: 768px) { .raven-product-grid { grid-template-columns: repeat(3, 1fr) !important; } }
        /* Clean product cards - NO borders, just floating on white */
        .raven-product-card {
            transition: all 0.3s ease;
            position: relative;
            background: white !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            overflow: visible !important;
        }
        .raven-product-card:hover .product-img { transform: scale(1.05); }
        .product-img { transition: transform 0.3s ease; }
        /* Vertical gold divider in the CENTER of gap between products */
        .raven-product-card::after {
            content: '' !important;
            position: absolute !important;
            right: -1rem !important;
            top: 0 !important;
            height: 100% !important;
            width: 2px !important;
            background: #D4A847 !important;
            display: block !important;
        }
        @media (min-width: 768px) {
            .raven-product-card:nth-child(3n)::after { display: none !important; }
        }
        @media (min-width: 640px) and (max-width: 767px) {
            .raven-product-card:nth-child(2n)::after { display: none !important; }
        }
        @media (max-width: 639px) {
            .raven-product-card::after { display: none !important; }
        }
    </style>
    <section class="raven-products bg-white" style="padding: 3rem 0 4rem;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">
            <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 2.5rem;">
                <h2 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(2rem, 4vw, 4rem); font-weight: 400; color: #111827; line-height: 1.1;">
                    Beliebte Produkte
                </h2>
                <a href="/alle-produkte/" class="btn btn-primary" style="display: inline-flex; align-items: center; padding: 0.5rem 1.25rem; background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%); color: #1f2937; font-weight: 600; border-radius: 0.5rem; text-decoration: none; border: 1px solid #C59A0F; box-shadow: 0 2px 6px rgba(0,0,0,0.25);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                    <span style="margin-left: 0.5rem;">Zum gesamten Sortiment</span>
                </a>
            </div>

            {# Product Grid - Dynamic from Database #}
            <div class="raven-product-grid" style="display: grid; grid-template-columns: repeat(1, 1fr); gap: 2rem;">
                {% if page.extensions.homepageProducts is defined and page.extensions.homepageProducts|length > 0 %}
                    {% for product in page.extensions.homepageProducts %}
                        <article class="raven-product-card" style="background: white; cursor: pointer;">
                            <a href="{{ seoUrl('frontend.detail.page', { productId: product.id }) }}" style="text-decoration: none; color: inherit; display: block;">
                                <div style="height: 18rem; background: white; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    {% if product.cover.media %}
                                        {% sw_thumbnails 'homepage-product-thumb' with { media: product.cover.media, sizes: { 'default': '400px' }, attributes: { 'class': 'product-img', 'alt': product.translated.name, 'style': 'max-width: 100%; max-height: 100%; object-fit: contain; padding: 0.75rem;' } } %}
                                    {% else %}
                                        <div style="color: #d1d5db;">{% sw_icon 'placeholder' style { 'size': 'lg' } %}</div>
                                    {% endif %}
                                </div>
                            </a>
                            <div style="padding: 0.75rem 0 1rem;">
                                {# Show manufacturer name with SEO URL link #}
                                {% if product.manufacturer and product.manufacturer.translated.name %}
                                    {% set mfrName = product.manufacturer.translated.name %}
                                    {% set mfrSlug = mfrName|lower|replace({' ': '-', '.': '', ',': '', 'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}) %}
                                    <a href="/{{ mfrSlug }}" style="font-size: 12px; line-height: 16px; color: #6B7280; margin: 0 0 0.5rem 0; text-decoration: none; display: block;">{{ mfrName }}</a>
                                {% endif %}
                                <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="color: #E53935; font-weight: 600; font-size: 16px; line-height: 1.2;">
                                            {% if product.calculatedPrice %}CHF {{ product.calculatedPrice.unitPrice|number_format(0, '.', "'") }}{% endif %}
                                        </div>
                                        {# Star Ratings - Use ratingAverage which is available in listings #}
                                        {% if product.ratingAverage and product.ratingAverage > 0 %}
                                            {% set rating = product.ratingAverage|round %}
                                            <div style="display: flex; align-items: center; gap: 6px; margin-top: 4px;">
                                                <div style="display: flex; gap: 2px;">
                                                    {% for i in 1..5 %}
                                                        {% if rating >= i %}
                                                            <svg style="width: 14px; height: 14px; color: #D4A847;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                                        {% else %}
                                                            <svg style="width: 14px; height: 14px; color: #D1D5DB;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <span style="font-size: 0.75rem; color: #6b7280;">({{ product.ratingAverage|number_format(1) }})</span>
                                            </div>
                                        {% endif %}
                                        <div style="color: #374151; font-size: 1rem; margin-top: 0.25rem;">
                                            <span style="font-weight: 700;">{{ product.manufacturer.translated.name|default('') }}</span> {{ product.translated.name }}
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 0.25rem; margin-top: -0.5rem;">
                                        <span style="width: 20px; height: 20px; border-radius: 50%; background: {% if product.availableStock > 0 or product.isCloseout == false %}linear-gradient(135deg, #22c55e 0%, #16a34a 100%){% else %}linear-gradient(135deg, #ef4444 0%, #dc2626 100%){% endif %}; display: inline-flex; align-items: center; justify-content: center;" title="{% if product.availableStock > 0 or product.isCloseout == false %}Verfügbar{% else %}Nicht verfügbar{% endif %}">
                                            <svg viewBox="0 0 24 24" fill="none" style="width: 12px; height: 12px;">{% if product.availableStock > 0 or product.isCloseout == false %}<path d="M5 13l4 4L19 7" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>{% else %}<path d="M6 18L18 6M6 6l12 12" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>{% endif %}</svg>
                                        </span>
                                        <form action="{{ path('frontend.checkout.line-item.add') }}" method="post" data-add-to-cart="true" class="add-to-cart-form">
                                            <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas">
                                            <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                                            <input type="hidden" name="lineItems[{{ product.id }}][quantity]" value="1">
                                            <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                                            <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}">
                                            <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1">
                                            <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1">
                                            <button type="submit" style="width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; border-radius: 0.375rem; background: transparent; border: none; color: #374151; cursor: pointer;" title="In den Warenkorb">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" style="width: 24px; height: 24px;"><path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/></svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </article>
                    {% endfor %}
                {% else %}
                    <p style="color: #6b7280; grid-column: 1 / -1; text-align: center;">Produkte werden geladen...</p>
                {% endif %}
            </div>
        </div>
    </section>

    {# ========================================== #}
    {# CATEGORIES SECTION - FULLY DYNAMIC #}
    {# ========================================== #}
    {% if page.extensions.homepageCategories is defined and page.extensions.homepageCategories|length > 0 %}
    <section class="raven-categories bg-white" style="padding: 3rem 0;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">
            <h2 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(2rem, 4vw, 3.5rem); font-weight: 400; color: #111827; line-height: 1.1; margin-bottom: 2rem;">
                Kategorien
            </h2>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;" class="md:!grid-cols-4">
                {% for category in page.extensions.homepageCategories %}
                    {# Skip "Alle Produkte" and "Munition" categories #}
                    {% if category.translated.name not in ['Alle Produkte', 'Munition'] %}
                    <a href="{{ seoUrl('frontend.navigation.page', { navigationId: category.id }) }}"
                       style="display: block; padding: 1.5rem 1rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 0.75rem; background: white; text-decoration: none; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);"
                       onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                       onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';">
                        {# Category Image or Icon #}
                        {% if category.media %}
                            <div style="width: 3.5rem; height: 3.5rem; margin: 0 auto 1rem; border-radius: 50%; overflow: hidden; background: #f3f4f6;">
                                <img src="{{ category.media.url }}" alt="{{ category.translated.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        {% else %}
                            <span style="display: inline-flex; width: 3.5rem; height: 3.5rem; align-items: center; justify-content: center; background: #f3f4f6; border-radius: 50%; margin-bottom: 1rem; color: #374151;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 1.5rem; height: 1.5rem;">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                </svg>
                            </span>
                        {% endif %}
                        <div style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">{{ category.translated.name }}</div>
                        {% if category.translated.description %}
                            <div style="font-size: 0.875rem; color: #6b7280; line-height: 1.4;">{{ category.translated.description|striptags|slice(0, 50) }}{% if category.translated.description|length > 50 %}...{% endif %}</div>
                        {% endif %}
                    </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    {# ========================================== #}
    {# BRANDS SECTION - HARDCODED PARTNER LOGOS #}
    {# ========================================== #}
    <style>
        @media (min-width: 768px) {
            .raven-brands-grid { grid-template-columns: repeat(4, 1fr) !important; }
        }
    </style>
    <section class="raven-brands bg-white" style="padding: 3rem 0;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">
            <h2 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(2rem, 4vw, 3.5rem); font-weight: 400; color: #111827; line-height: 1.1; margin-bottom: 2rem;">
                Unsere Marken
            </h2>

            <div class="raven-brands-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                {# Brand 1: Lockhart Tactical #}
                <a href="{{ path('frontend.manufacturer.page', {manufacturerSlug: 'lockhart-tactical'}) }}"
                   style="border: 1px solid #e5e7eb; border-radius: 0.75rem; height: 10rem; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-decoration: none;"
                   onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                   onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';"
                   title="Lockhart Tactical">
                    <img src="{{ asset('bundles/raventheme/assets/brand-lockhart.png') }}" alt="Lockhart Tactical" style="max-height: 80%; max-width: 80%; object-fit: contain;">
                </a>

                {# Brand 2: Magpul #}
                <a href="{{ path('frontend.manufacturer.page', {manufacturerSlug: 'magpul'}) }}"
                   style="border: 1px solid #e5e7eb; border-radius: 0.75rem; height: 10rem; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-decoration: none;"
                   onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                   onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';"
                   title="Magpul">
                    <img src="{{ asset('bundles/raventheme/assets/brand-magpul.png') }}" alt="Magpul" style="max-height: 80%; max-width: 80%; object-fit: contain;">
                </a>

                {# Brand 3: Snigel #}
                <a href="{{ path('frontend.manufacturer.page', {manufacturerSlug: 'snigel'}) }}"
                   style="border: 1px solid #e5e7eb; border-radius: 0.75rem; height: 10rem; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-decoration: none;"
                   onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                   onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';"
                   title="Snigel">
                    <img src="{{ asset('bundles/raventheme/assets/brand-snigel.png') }}" alt="Snigel" style="max-height: 80%; max-width: 80%; object-fit: contain;">
                </a>

                {# Brand 4: Zerotech #}
                <a href="{{ path('frontend.manufacturer.page', {manufacturerSlug: 'zerotech'}) }}"
                   style="border: 1px solid #e5e7eb; border-radius: 0.75rem; height: 10rem; display: flex; align-items: center; justify-content: center; background: white; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-decoration: none;"
                   onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';"
                   onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)';"
                   title="Zerotech">
                    <img src="{{ asset('bundles/raventheme/assets/brand-zerotech.png') }}" alt="Zerotech" style="max-height: 80%; max-width: 80%; object-fit: contain;">
                </a>
            </div>
        </div>
    </section>

    {# ========================================== #}
    {# VIDEO SECTION - Uses Cloudflare Stream #}
    {# This video URL can be changed in Shopware Admin > Settings > Basic Information > Custom fields #}
    {# ========================================== #}
    <style>
        @media (min-width: 768px) {
            .raven-video-grid { grid-template-columns: 1fr 1fr !important; }
        }
    </style>
    <section class="raven-video bg-white" style="padding: 3rem 0 4rem;">
        <div class="max-w-7xl mx-auto px-6 lg:px-24">
            <div class="raven-video-grid" style="display: grid; grid-template-columns: 1fr; gap: 2.5rem; align-items: center;">
                {# Video Embed - Cloudflare Stream #}
                <div style="border-radius: 0.75rem; overflow: hidden; position: relative; padding-top: 56.25%; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                    <iframe
                        src="https://customer-zz0gro70wkcharf0.cloudflarestream.com/14b22c52b620a8e2d65ba9eb5b481bdb/iframe?poster=https%3A%2F%2Fcustomer-zz0gro70wkcharf0.cloudflarestream.com%2F14b22c52b620a8e2d65ba9eb5b481bdb%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600"
                        loading="lazy"
                        style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;"
                        allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
                        allowfullscreen="true"
                    ></iframe>
                </div>

                {# Video Description #}
                <div>
                    <h2 style="font-family: 'Chakra Petch', sans-serif; font-size: clamp(1.75rem, 3vw, 2.5rem); font-weight: 400; color: #111827; margin-bottom: 1rem;">
                        Schweizer Präzision
                    </h2>
                    <p style="color: #4B5563; line-height: 1.7; margin-bottom: 1.25rem; font-size: 1rem;">
                        Raven Weapon AG verbindet Schweizer Qualitätsstandards mit kanadischer Handwerkskunst. Unsere Präzisionswaffen werden mit höchster Sorgfalt gefertigt.
                    </p>
                    <ul style="color: #374151; list-style-type: none; padding-left: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.75rem;">
                            <span style="color: #D4A847; font-weight: 600;">•</span>
                            <span>Höchste Fertigungsqualität</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.75rem;">
                            <span style="color: #D4A847; font-weight: 600;">•</span>
                            <span>Persönliche Beratung</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.75rem;">
                            <span style="color: #D4A847; font-weight: 600;">•</span>
                            <span>Schnelle Lieferung in der Schweiz</span>
                        </li>
                        <li style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <span style="color: #D4A847; font-weight: 600;">•</span>
                            <span>Familienbetrieb mit Tradition</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

</main>

{# Raven Cart AJAX Handler - Intercepts cart operations to stay in sidebar #}
<script>
(function() {
    'use strict';

    // Update cart item colors and images from localStorage
    function updateCartColors() {
        document.querySelectorAll('.raven-cart-item').forEach(function(item) {
            var productId = item.getAttribute('data-product-id');
            if (productId) {
                var colorData = localStorage.getItem('raven_color_' + productId);
                var colorSpan = item.querySelector('.raven-item-color');

                if (colorData) {
                    try {
                        var data = JSON.parse(colorData);
                        // Update color text
                        if (colorSpan && data.color) {
                            colorSpan.textContent = data.color;
                        }
                        // Update image if we have a stored image URL
                        if (data.image) {
                            var img = item.querySelector('.raven-item-image img, .raven-cart-item-img');
                            if (img) {
                                img.src = data.image;
                            }
                        }
                    } catch(e) {}
                } else {
                    // Only default to "Graphite Black" for Raven Weapons (product number starts with RW- or LT-)
                    // Snigel products (SN-) should not have a default color
                    if (colorSpan && !colorSpan.textContent.trim()) {
                        var productNum = item.querySelector('[data-product-number]');
                        var pn = productNum ? productNum.getAttribute('data-product-number') : '';
                        if (pn && (pn.startsWith('RW-') || pn.startsWith('LT-'))) {
                            colorSpan.textContent = 'Graphite Black';
                        }
                        // For Snigel (SN-) and other products, leave color empty
                    }
                }
            }
        });
    }

    // Direct offcanvas cart opener - shows immediately with loading state
    function openOffcanvasCart(skipFetch) {
        // Create backdrop first (show immediately)
        var backdrop = document.getElementById('raven-offcanvas-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.id = 'raven-offcanvas-backdrop';
            backdrop.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1040;opacity:0;transition:opacity 0.15s;';
            backdrop.onclick = closeOffcanvasCart;
            document.body.appendChild(backdrop);
        }
        backdrop.offsetHeight;
        backdrop.style.opacity = '1';

        // Create or get offcanvas (show immediately with loading)
        var offcanvas = document.getElementById('raven-offcanvas-cart');
        if (!offcanvas) {
            offcanvas = document.createElement('div');
            offcanvas.id = 'raven-offcanvas-cart';
            offcanvas.className = 'offcanvas offcanvas-end';
            var isMobile = window.innerWidth <= 480;
            offcanvas.style.cssText = 'position:fixed;top:0;right:0;bottom:0;width:' + (isMobile ? '100%' : '420px') + ';max-width:100vw;z-index:1050;background:#fff;transform:translateX(100%);transition:transform 0.3s ease;box-shadow:-4px 0 15px rgba(0,0,0,0.1);';
            document.body.appendChild(offcanvas);
        }

        // Always show loading state initially
        offcanvas.innerHTML = '<div style="display:flex;flex-direction:column;height:100%;"><div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;"><h2 style="font-size:18px;font-weight:600;margin:0;">Warenkorb</h2><button class="raven-cart-close" style="background:none;border:none;cursor:pointer;padding:8px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div style="flex:1;display:flex;align-items:center;justify-content:center;"><div style="text-align:center;"><div style="width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#f59e0b;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p style="color:#6b7280;font-size:14px;">Lädt...</p></div></div></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';

        // Force reflow and slide in immediately
        offcanvas.offsetHeight;
        offcanvas.style.transform = 'translateX(0)';
        offcanvas.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Attach close handler to loading state
        var closeBtn = offcanvas.querySelector('.raven-cart-close');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.preventDefault();
                closeOffcanvasCart();
            };
        }

        // Fetch actual content (unless skipFetch is true)
        if (!skipFetch) {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
                // Attach close handlers to loaded content
                offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(function(btn) {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        closeOffcanvasCart();
                    };
                });
                // Update cart colors from localStorage
                setTimeout(updateCartColors, 50);
                setTimeout(updateCartColors, 150);
                setTimeout(updateCartColors, 300);
            });
        }
    }

    // Update offcanvas content (for use after add-to-cart)
    function updateOffcanvasContent() {
        var offcanvas = document.getElementById('raven-offcanvas-cart');
        if (!offcanvas || !offcanvas.classList.contains('show')) return;

        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) { return response.text(); })
        .then(function(html) {
            offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
            offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(function(btn) {
                btn.onclick = function(e) {
                    e.preventDefault();
                    closeOffcanvasCart();
                };
            });
            // Update cart colors from localStorage
            setTimeout(updateCartColors, 50);
            setTimeout(updateCartColors, 150);
            setTimeout(updateCartColors, 300);
        });
    }

    function closeOffcanvasCart() {
        var offcanvas = document.getElementById('raven-offcanvas-cart');
        var backdrop = document.getElementById('raven-offcanvas-backdrop');
        if (offcanvas) {
            offcanvas.style.transform = 'translateX(100%)';
            offcanvas.classList.remove('show');
        }
        if (backdrop) {
            backdrop.style.opacity = '0';
            setTimeout(function() { backdrop.remove(); }, 150);
        }
        document.body.style.overflow = '';
    }

    function refreshOffcanvasCart() {
        var offcanvas = document.getElementById('raven-offcanvas-cart');
        if (offcanvas && offcanvas.classList.contains('show')) {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                offcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
                // Re-attach close handlers
                offcanvas.querySelectorAll('[data-offcanvas-close], .js-offcanvas-close, .raven-cart-close').forEach(function(btn) {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        closeOffcanvasCart();
                    };
                });
                // Update cart colors from localStorage
                setTimeout(updateCartColors, 50);
                setTimeout(updateCartColors, 150);
                setTimeout(updateCartColors, 300);
            });
        }
    }

    function submitCartFormAjax(form) {
        var formData = new FormData(form);
        var action = form.getAttribute('action');
        fetch(action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function() { refreshOffcanvasCart(); })
        .catch(function() { refreshOffcanvasCart(); });
    }

    // Intercept ALL form submissions using capture phase
    document.addEventListener('submit', function(e) {
        var form = e.target;
        var action = form.getAttribute('action');
        if (!action) return;

        if (action.indexOf('checkout/line-item/delete') !== -1 ||
            action.indexOf('checkout/line-item/change-quantity') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            submitCartFormAjax(form);
            return false;
        }

        if (action.indexOf('checkout/line-item/add') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var formData = new FormData(form);

            // Save default color to localStorage for homepage add-to-cart (Raven Weapons only)
            // Snigel products should not get a default color
            var productIdInput = form.querySelector('input[name*="[id]"]');
            var productNumInput = form.querySelector('input[name*="productNumber"], [data-product-number]');
            if (productIdInput) {
                var productId = productIdInput.value;
                var productNum = productNumInput ? (productNumInput.value || productNumInput.getAttribute('data-product-number')) : '';
                // Only set default for Raven Weapons (RW- or LT-), not Snigel (SN-)
                if (!localStorage.getItem('raven_color_' + productId) && productNum && (productNum.startsWith('RW-') || productNum.startsWith('LT-'))) {
                    localStorage.setItem('raven_color_' + productId, JSON.stringify({color: 'Graphite Black', image: ''}));
                }
            }

            // Open sidebar IMMEDIATELY with loading state
            openOffcanvasCart(true);

            // Then add to cart and update content
            fetch(action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function() {
                updateOffcanvasContent();
            });
            return false;
        }
    }, true);

    // Save default color on add-to-cart button click (Raven Weapons only, before Shopware handles it)
    document.addEventListener('click', function(e) {
        var addToCartBtn = e.target.closest('form[data-add-to-cart] button[type="submit"], form.add-to-cart-form button[type="submit"]');
        if (addToCartBtn) {
            var form = addToCartBtn.closest('form');
            if (form) {
                var productIdInput = form.querySelector('input[name*="[id]"]');
                var productNumInput = form.querySelector('input[name*="productNumber"], [data-product-number]');
                if (productIdInput) {
                    var productId = productIdInput.value;
                    var productNum = productNumInput ? (productNumInput.value || productNumInput.getAttribute('data-product-number')) : '';
                    // Only set default for Raven Weapons (RW- or LT-), not Snigel (SN-)
                    if (!localStorage.getItem('raven_color_' + productId) && productNum && (productNum.startsWith('RW-') || productNum.startsWith('LT-'))) {
                        localStorage.setItem('raven_color_' + productId, JSON.stringify({color: 'Graphite Black', image: ''}));
                        console.log('Saved default color Graphite Black for Raven product:', productId);
                    }
                }
            }
        }
    }, true); // Use capture phase to run BEFORE Shopware's handlers

    // Handle quantity and delete button clicks
    document.addEventListener('click', function(e) {
        var minusBtn = e.target.closest('.js-btn-minus');
        if (minusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = minusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                if (current > 1) {
                    input.value = current - 1;
                    submitCartFormAjax(form);
                }
            }
            return;
        }

        var plusBtn = e.target.closest('.js-btn-plus');
        if (plusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = plusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                input.value = current + 1;
                submitCartFormAjax(form);
            }
            return;
        }

        var removeBtn = e.target.closest('.raven-item-remove');
        if (removeBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = removeBtn.closest('form');
            if (form) submitCartFormAjax(form);
            return;
        }

        // Intercept cart button clicks to use our custom offcanvas
        var cartBtn = e.target.closest('[data-offcanvas-cart]');
        if (cartBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            openOffcanvasCart();
            return;
        }
    }, true);

    // Auto-dismiss Shopware alert messages after 3 seconds
    function autoDismissAlerts() {
        var alerts = document.querySelectorAll('.alert, [role="alert"]');
        alerts.forEach(function(alert) {
            if (!alert.dataset.ravenDismissed) {
                alert.dataset.ravenDismissed = 'true';
                setTimeout(function() {
                    alert.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(-20px)';
                    setTimeout(function() {
                        alert.style.display = 'none';
                    }, 300);
                }, 3000);
            }
        });
    }

    // Run on page load and after DOM changes
    document.addEventListener('DOMContentLoaded', autoDismissAlerts);

    // Also watch for dynamically added alerts
    var alertObserver = new MutationObserver(function(mutations) {
        autoDismissAlerts();
    });
    alertObserver.observe(document.body, { childList: true, subtree: true });

    // Expose global functions
    window.ravenOpenCart = openOffcanvasCart;
    window.ravenCloseCart = closeOffcanvasCart;
    window.ravenRefreshCart = refreshOffcanvasCart;
    console.log('Raven Cart AJAX handler loaded with custom offcanvas');
})();
</script>

{% else %}
    {# For non-homepage pages, use default Shopware rendering #}
    {{ parent() }}
{% endif %}
{% endblock %}

