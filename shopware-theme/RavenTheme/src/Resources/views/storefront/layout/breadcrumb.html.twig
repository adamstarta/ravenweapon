{% sw_extends '@Storefront/storefront/layout/breadcrumb.html.twig' %}

{# Custom Raven Weapon breadcrumb - matches product detail page style #}
{% block layout_breadcrumb_inner %}
    {% if category %}
        {% set breadcrumbCategories = sw_breadcrumb_full(category, context) %}
        {% set categoryId = category.id %}
    {% elseif categoryId %}
        {% set breadcrumbCategories = sw_breadcrumb_full_by_id(categoryId, context) %}
    {% else %}
        {% return %}
    {% endif %}

    {% if breadcrumbCategories|length > 0 %}
        <style>
            /* Hide category description paragraphs but keep headings visible */
            .cms-section .category-description,
            .cms-block .category-description {
                display: none !important;
            }

            /* Hide description paragraphs after h1 on category pages */
            .cms-listing-col h1 + p,
            .cms-element-text p:not(:first-child) {
                display: none !important;
            }

            /* Style the category heading */
            .cms-element-text h1 {
                font-family: 'Chakra Petch', sans-serif !important;
                font-weight: 700 !important;
                font-size: 2rem !important;
                line-height: 1.2 !important;
                color: #111827 !important;
                margin-bottom: 1.5rem !important;
            }

            /* Simple breadcrumb styling - no background */
            .product-detail-breadcrumb {
                font-size: 0.875rem;
                font-family: 'Inter', -apple-system, sans-serif;
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                margin-bottom: 1rem;
            }
            .product-detail-breadcrumb a {
                color: #666;
                text-decoration: none;
            }
            .product-detail-breadcrumb a:hover {
                color: #333;
            }
            .product-detail-breadcrumb .breadcrumb-separator {
                color: #999;
                margin: 0 0.5rem;
            }
            .product-detail-breadcrumb .breadcrumb-current {
                color: #333;
                font-weight: 500;
            }
        </style>
        {# Build breadcrumb using Shopware's seoUrl function for proper URLs #}
        {# First, collect all category names for building fallback URLs #}
        {% set breadcrumbPath = [] %}
        <nav aria-label="Breadcrumb" class="product-detail-breadcrumb">
            <a href="{{ path('frontend.home.page') }}">Home</a>
            {% for breadcrumbCategory in breadcrumbCategories %}
                {% set catName = breadcrumbCategory.translated.name %}

                {# Skip "Waffen" category from breadcrumb display #}
                {% if catName|lower == 'waffen' %}
                    {% continue %}
                {% endif %}

                {# Add slugified name to path for building full URL #}
                {% set slugifiedName = catName|lower|replace({' & ': '-', 'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss', '&': '-', ' ': '-', ',': '', '.': '', '/': '-'})|replace({'--': '-'})|replace({'--': '-'})|trim('-') %}
                {% set breadcrumbPath = breadcrumbPath|merge([slugifiedName]) %}

                {# Try to get SEO URL from the category's seoUrls association first #}
                {% set categoryUrl = null %}

                {# Check if category has seoUrls loaded and use the canonical one #}
                {% if breadcrumbCategory.seoUrls is defined and breadcrumbCategory.seoUrls|length > 0 %}
                    {% for seoUrlEntity in breadcrumbCategory.seoUrls %}
                        {% if seoUrlEntity.isCanonical %}
                            {% set categoryUrl = '/' ~ seoUrlEntity.seoPathInfo %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {# Fallback to seoUrl function #}
                {% if categoryUrl is null %}
                    {% set categoryUrl = seoUrl('frontend.navigation.page', { navigationId: breadcrumbCategory.id }) %}
                {% endif %}

                {# If still getting technical URL (contains /navigation/), build from full path #}
                {% if '/navigation/' in categoryUrl %}
                    {% set categoryUrl = '/' ~ breadcrumbPath|join('/') ~ '/' %}
                {% endif %}

                <span class="breadcrumb-separator">/</span>
                {% if loop.last %}
                    <span class="breadcrumb-current">{{ catName }}</span>
                {% else %}
                    <a href="{{ categoryUrl }}">{{ catName }}</a>
                {% endif %}
            {% endfor %}
        </nav>

        {# BreadcrumbList Schema.org JSON-LD for Google Rich Snippets #}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Home",
                    "item": "https://ravenweapon.ch"
                }
                {% set position = 2 %}
                {% for breadcrumbCategory in breadcrumbCategories %}
                {% if breadcrumbCategory.translated.name|lower != 'waffen' %}
                ,{
                    "@type": "ListItem",
                    "position": {{ position }},
                    "name": "{{ breadcrumbCategory.translated.name|e('js') }}",
                    "item": "https://ravenweapon.ch{{ seoUrl('frontend.navigation.page', { navigationId: breadcrumbCategory.id }) }}"
                }
                {% set position = position + 1 %}
                {% endif %}
                {% endfor %}
            ]
        }
        </script>
    {% endif %}
{% endblock %}
