{% sw_extends '@Storefront/storefront/layout/header/header.html.twig' %}

{% block layout_header_actions_cart %}
    {# Cart Button - Opens Off-Canvas Cart Sidebar using Shopware's built-in plugin #}
    <div class="header-cart-wrapper" style="display: flex; align-items: center; gap: 6px;">
        <button type="button"
                class="raven-icon-btn header-cart-btn relative inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                data-off-canvas-cart="true"
                data-url="{{ path('frontend.cart.offcanvas') }}"
                aria-label="Warenkorb"
                title="Warenkorb">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor" class="w-5 h-5"><path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/></svg>
        </button>
        {% set cartCount = page.cart.lineItems.count|default(0) %}
        {% if cartCount > 0 %}
            <span class="raven-cart-badge-outside" style="display: inline-flex; align-items: center; justify-content: center; min-width: 24px; height: 24px; padding: 0 8px; background: linear-gradient(to right, #facc15, #f59e0b, #facc15); color: #000; font-size: 12px; font-weight: 700; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                {{ cartCount }}
            </span>
        {% endif %}
    </div>
{% endblock %}

{% block layout_header %}
<style>
    /* Hide manufacturer name ONLY on Waffenzubehör page */
    body.page-waffenzubehoer .raven-manufacturer {
        display: none !important;
    }

    /* Make header full width - override Shopware's container constraints */
    .header-main,
    header.header-main,
    .header-row,
    .header-main > .container,
    .header-main .container {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    /* Remove bottom border/shadow from header-main if any */
    .header-main {
        border-bottom: none !important;
        box-shadow: none !important;
    }

    /* Header Animations & Styles */
    .raven-header {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    }
    .raven-header a, .raven-header button {
        transition: all 0.2s ease;
    }
    .raven-nav-link {
        position: relative;
        transition: color 0.2s ease;
    }
    .raven-nav-link::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(to right, #F2B90D, #D4A847);
        transition: width 0.3s ease;
    }
    .raven-nav-link:hover::after, .raven-nav-link.active::after {
        width: 100%;
    }
    .raven-nav-link:hover {
        color: #111827 !important;
    }

    /* Mega Menu Dropdown Styles */
    .raven-nav-item {
        position: relative;
    }
    .raven-mega-menu {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        min-width: 220px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid #e5e7eb;
        padding: 12px 0;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 1000;
        margin-top: 8px;
    }
    .raven-nav-item:hover .raven-mega-menu {
        opacity: 1;
        visibility: visible;
    }
    .raven-mega-menu a {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        color: #374151;
        font-size: 14px;
        text-decoration: none;
        transition: all 0.15s ease;
    }
    .raven-mega-menu a:hover {
        background: #f9fafb;
        color: #111827;
    }
    .raven-mega-menu .menu-header {
        padding: 8px 20px 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #9ca3af;
        border-bottom: 1px solid #f3f4f6;
        margin-bottom: 8px;
    }

    /* Live Search Autocomplete Styles */
    .raven-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid #e5e7eb;
        margin-top: 8px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .raven-search-dropdown.show {
        display: block;
        animation: fadeInDown 0.15s ease;
    }
    .raven-search-section {
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .raven-search-section:last-child {
        border-bottom: none;
    }
    .raven-search-section-title {
        padding: 8px 16px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #9ca3af;
    }
    .raven-search-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        text-decoration: none;
        transition: background 0.15s ease;
    }
    .raven-search-item:hover {
        background: #f9fafb;
    }
    .raven-search-item-image {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: cover;
        background: #f3f4f6;
    }
    .raven-search-item-info {
        flex: 1;
        min-width: 0;
    }
    .raven-search-item-name {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .raven-search-item-details {
        font-size: 12px;
        color: #6b7280;
    }
    .raven-search-item-price {
        font-size: 14px;
        font-weight: 700;
        color: #d97706;
        white-space: nowrap;
        margin-left: auto;
        padding-left: 12px;
        min-width: 90px;
        text-align: right;
    }
    .raven-search-loading {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 14px;
    }
    .raven-search-no-results {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 14px;
    }
    .raven-search-view-all {
        display: block;
        padding: 12px 16px;
        text-align: center;
        background: #f9fafb;
        color: #d97706;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        border-top: 1px solid #f3f4f6;
    }
    .raven-search-view-all:hover {
        background: #f3f4f6;
        color: #b45309;
    }
    .raven-icon-btn {
        transition: all 0.2s ease;
    }
    .raven-icon-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }
    .raven-icon-btn:hover svg {
        color: #111827;
    }
    .raven-search-input {
        transition: all 0.2s ease;
    }
    .raven-search-input:focus {
        background: rgba(120,120,128,0.12);
        box-shadow: 0 0 0 3px rgba(212, 168, 71, 0.2);
    }
    .raven-logo {
        transition: opacity 0.2s ease;
    }
    .raven-logo:hover {
        opacity: 0.85;
    }
    .raven-cart-badge-outside {
        animation: pulse-badge 2s infinite;
    }
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Fix cart offcanvas - hide default Shopware elements and black spots */
    #raven-offcanvas-cart .offcanvas-close,
    #raven-offcanvas-cart .btn-close,
    #raven-offcanvas-cart > button:first-child,
    #raven-offcanvas-cart > .offcanvas-header,
    .offcanvas-cart .offcanvas-close,
    .offcanvas-cart .btn-close {
        display: none !important;
    }

    /* Ensure offcanvas has no extra elements at top */
    #raven-offcanvas-cart {
        display: flex;
        flex-direction: column;
    }

    #raven-offcanvas-cart > .raven-offcanvas-cart {
        height: 100%;
    }

    /* Hide any stray backdrop buttons */
    #raven-offcanvas-backdrop button,
    .offcanvas-backdrop button {
        display: none !important;
    }
    /* Fix search icon display */
    .raven-search-form button[type="submit"] svg,
    .raven-search-form button[type="submit"] img {
        width: 16px !important;
        height: 16px !important;
        display: block !important;
    }
    /* Hide Shopware's default search suggest button that appears on right */
    .header-search-btn,
    .search-suggest-container .btn {
        display: none !important;
    }

    /* Account dropdown menu styles */
    .raven-account-menu a:hover {
        background: #f9fafb !important;
    }
    .raven-account-menu a[href*="logout"]:hover {
        background: #fef2f2 !important;
    }
    .raven-account-menu.show {
        display: block !important;
        animation: fadeInDown 0.15s ease;
    }
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
(function() {
    'use strict';

    // Update cart badge count in navbar
    function updateCartBadge() {
        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(html) {
            var count = 0;

            // Try to find the count from the raven-cart-count span
            var countMatch = html.match(/class="raven-cart-count"[^>]*>(\d+)</);
            if (countMatch) {
                count = parseInt(countMatch[1]);
            } else {
                // Fallback: count cart items by looking for js-cart-item class
                var itemMatches = html.match(/class="[^"]*js-cart-item[^"]*"/g);
                if (itemMatches) {
                    count = itemMatches.length;
                }
            }

            console.log('Cart badge update: ' + count + ' items');

            // Update existing badges (now outside the button, in wrapper)
            document.querySelectorAll('.header-cart-wrapper').forEach(function(wrapper) {
                var badge = wrapper.querySelector('.raven-cart-badge-outside');
                if (count > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'raven-cart-badge-outside';
                        badge.style.cssText = 'display:inline-flex;align-items:center;justify-content:center;min-width:24px;height:24px;padding:0 8px;background:linear-gradient(to right,#facc15,#f59e0b,#facc15);color:#000;font-size:12px;font-weight:700;border-radius:9999px;box-shadow:0 1px 3px rgba(0,0,0,0.2);';
                        wrapper.appendChild(badge);
                    }
                    badge.textContent = count;
                    badge.style.display = 'inline-flex';
                } else if (badge) {
                    badge.style.display = 'none';
                }
            });
        });
    }

    // Refresh cart content in any open offcanvas
    function refreshOffcanvasCart() {
        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) { return response.text(); })
        .then(function(html) {
            var offcanvas = document.querySelector('.offcanvas.show .offcanvas-body');
            if (offcanvas) {
                offcanvas.innerHTML = html;
            }
            var ravenOffcanvas = document.getElementById('raven-offcanvas-cart');
            if (ravenOffcanvas) {
                ravenOffcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
            }
            // Update badge after refresh
            updateCartBadge();
        });
    }

    // Submit form via AJAX and refresh cart
    function submitCartFormAjax(form) {
        var formData = new FormData(form);
        var action = form.getAttribute('action');
        fetch(action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function() { refreshOffcanvasCart(); })
        .catch(function() { refreshOffcanvasCart(); });
    }

    // Open cart offcanvas
    function openOffcanvasCart() {
        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(h) {
            // Create backdrop first
            var b = document.getElementById('raven-offcanvas-backdrop');
            if (!b) {
                b = document.createElement('div');
                b.id = 'raven-offcanvas-backdrop';
                b.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1040;opacity:0;transition:opacity 0.2s ease;cursor:pointer;';
                b.onclick = closeOffcanvasCart;
                document.body.appendChild(b);
            }
            // Force reflow and show backdrop
            b.offsetHeight;
            b.style.opacity = '1';

            // Create or update offcanvas
            var o = document.getElementById('raven-offcanvas-cart');
            if (!o) {
                o = document.createElement('div');
                o.id = 'raven-offcanvas-cart';
                o.style.cssText = 'position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100vw;height:100%;z-index:1050;background:#fff;transform:translateX(100%);transition:transform 0.3s ease;box-shadow:-4px 0 15px rgba(0,0,0,0.1);overflow:hidden;';
                document.body.appendChild(o);
            }
            o.innerHTML = h;

            // Force reflow and slide in
            o.offsetHeight;
            o.style.transform = 'translateX(0)';
            o.classList.add('show');

            document.body.style.overflow = 'hidden';

            // Attach close handlers
            o.querySelectorAll('[data-offcanvas-close],.js-offcanvas-close,.raven-cart-close').forEach(function(x) {
                x.onclick = function(e) {
                    e.preventDefault();
                    closeOffcanvasCart();
                };
            });
            if (window.PluginManager) window.PluginManager.initializePlugins();
        });
    }

    // Close cart offcanvas
    function closeOffcanvasCart() {
        var o = document.getElementById('raven-offcanvas-cart');
        var b = document.getElementById('raven-offcanvas-backdrop');
        if (o) {
            o.style.transform = 'translateX(100%)';
            o.classList.remove('show');
        }
        if (b) {
            b.style.opacity = '0';
            setTimeout(function() { b.remove(); }, 150);
        }
        document.body.style.overflow = '';
    }

    // Intercept ALL form submissions using capture phase
    document.addEventListener('submit', function(e) {
        var form = e.target;
        var action = form.getAttribute('action');
        if (!action) return;

        if (action.indexOf('checkout/line-item/delete') !== -1 ||
            action.indexOf('checkout/line-item/change-quantity') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            submitCartFormAjax(form);
            return false;
        }

        if (action.indexOf('checkout/line-item/add') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var formData = new FormData(form);
            fetch(action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function() {
                updateCartBadge();
                openOffcanvasCart();
            });
            return false;
        }
    }, true);

    // Handle quantity and delete button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-offcanvas-cart]')) {
            e.preventDefault();
            openOffcanvasCart();
            return;
        }

        var minusBtn = e.target.closest('.js-btn-minus, [data-quantity-minus]');
        if (minusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = minusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                if (current > 1) {
                    input.value = current - 1;
                    submitCartFormAjax(form);
                }
            }
            return;
        }

        var plusBtn = e.target.closest('.js-btn-plus, [data-quantity-plus]');
        if (plusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = plusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                input.value = current + 1;
                submitCartFormAjax(form);
            }
            return;
        }

        var removeBtn = e.target.closest('.raven-item-remove, [data-remove-item]');
        if (removeBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = removeBtn.closest('form');
            if (form) submitCartFormAjax(form);
            return;
        }
    }, true);

    // Expose to global scope
    window.ravenOpenCart = openOffcanvasCart;
    window.ravenCloseCart = closeOffcanvasCart;
    window.ravenRefreshCart = refreshOffcanvasCart;
    window.ravenUpdateBadge = updateCartBadge;

    // Update cart badge on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateCartBadge);
    } else {
        updateCartBadge();
    }

    // Strip manufacturer name from product titles
    function stripManufacturerFromTitles() {
        var manufacturers = ['Lockhart Tactical'];
        document.querySelectorAll('h1, .product-detail-name, .product-name').forEach(function(el) {
            var text = el.textContent || '';
            manufacturers.forEach(function(mfr) {
                if (text.indexOf(mfr) === 0) {
                    el.textContent = text.substring(mfr.length).trim();
                }
            });
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', stripManufacturerFromTitles);
    } else {
        stripManufacturerFromTitles();
    }

    // Add body class for Waffenzubehör page to hide manufacturer names only there
    (function() {
        var path = window.location.pathname.toLowerCase();
        if (path.indexOf('/waffenzubehoer') === 0) {
            document.body.classList.add('page-waffenzubehoer');
        }
    })();

    // Check login state and update dropdown menus
    function checkLoginState() {
        fetch('/account', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) {
            // If we get redirected to login page, user is not logged in
            if (response.url.indexOf('/account/login') !== -1 || response.url.indexOf('/account/register') !== -1) {
                updateAccountMenus(false, null);
            } else {
                return response.text();
            }
        })
        .then(function(html) {
            if (!html) return;
            // Try to extract customer name from the account page HTML
            var nameMatch = html.match(/Willkommen[^<]*<\/p>\s*<h3[^>]*>([^<]+)</i);
            if (nameMatch) {
                updateAccountMenus(true, nameMatch[1].trim());
            } else {
                // Alternative: look for user-name class
                var altMatch = html.match(/class="user-name"[^>]*>([^<]+)</);
                if (altMatch) {
                    updateAccountMenus(true, altMatch[1].trim());
                } else {
                    // Check if we're on account page (not redirected to login)
                    if (html.indexOf('Übersicht') !== -1 || html.indexOf('Mein Profil') !== -1) {
                        updateAccountMenus(true, 'Kunde');
                    } else {
                        updateAccountMenus(false, null);
                    }
                }
            }
        })
        .catch(function() {
            // On error, assume not logged in
            updateAccountMenus(false, null);
        });
    }

    function updateAccountMenus(isLoggedIn, customerName) {
        document.querySelectorAll('.raven-account-menu').forEach(function(menu) {
            var loggedInMenu = menu.querySelector('.raven-logged-in-menu');
            var guestMenu = menu.querySelector('.raven-guest-menu');
            var nameEl = menu.querySelector('.raven-customer-name');

            if (isLoggedIn) {
                if (loggedInMenu) loggedInMenu.style.display = 'block';
                if (guestMenu) guestMenu.style.display = 'none';
                if (nameEl && customerName) nameEl.textContent = customerName;
            } else {
                if (loggedInMenu) loggedInMenu.style.display = 'none';
                if (guestMenu) guestMenu.style.display = 'block';
            }
        });
    }

    // Account dropdown toggle
    function initAccountDropdown() {
        document.querySelectorAll('.raven-account-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var dropdown = btn.closest('.raven-account-dropdown');
                var menu = dropdown ? dropdown.querySelector('.raven-account-menu') : null;
                if (menu) {
                    // Close other open dropdowns
                    document.querySelectorAll('.raven-account-menu.show').forEach(function(m) {
                        if (m !== menu) m.classList.remove('show');
                    });
                    // Toggle this dropdown
                    menu.classList.toggle('show');
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.raven-account-dropdown')) {
                document.querySelectorAll('.raven-account-menu.show').forEach(function(m) {
                    m.classList.remove('show');
                });
            }
        });

        // Check login state on page load
        checkLoginState();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAccountDropdown);
    } else {
        initAccountDropdown();
    }

    console.log('Raven Cart AJAX handler loaded with custom offcanvas');

    // Category-specific search functionality
    // When on a category page, filter products client-side within that category
    function initCategorySearch() {
        var categoryPaths = {
            '/Waffenzubehoer/': 'Waffenzubehör',
            '/Raven-Weapons/': 'Waffen',
            '/Raven-Caliber-Kit/': 'Kalibers'
        };

        // Get current category from URL path
        function getCurrentCategory() {
            var path = window.location.pathname;
            for (var catPath in categoryPaths) {
                if (path.toLowerCase().indexOf(catPath.toLowerCase()) === 0) {
                    return { path: catPath, name: categoryPaths[catPath] };
                }
            }
            return null;
        }

        // Update search placeholders based on current category
        function updateSearchPlaceholders() {
            var category = getCurrentCategory();
            var placeholder = category
                ? 'Suche in ' + category.name + '...'
                : 'Produkte suchen...';

            document.querySelectorAll('.raven-search-input').forEach(function(input) {
                input.setAttribute('placeholder', placeholder);
            });
        }

        // Filter products on category page
        function filterProductsOnPage(searchTerm) {
            var searchLower = searchTerm.toLowerCase();
            // Target the actual product boxes with raven-card or product-box class
            var productItems = document.querySelectorAll('.product-box, .raven-card, .cms-listing-col');
            var visibleCount = 0;
            var totalCount = productItems.length;

            productItems.forEach(function(item) {
                // Get product name from raven-product-name class or link title attribute
                var productNameEl = item.querySelector('.raven-product-name');
                var productText = '';

                if (productNameEl) {
                    productText = productNameEl.textContent.trim();
                } else {
                    // Fallback: try to get from link with title attribute (image link)
                    var imageLink = item.querySelector('a[title]');
                    if (imageLink) {
                        productText = imageLink.getAttribute('title') || '';
                    }
                }

                // Also get product number if available
                var productNumber = item.querySelector('[data-product-number]');
                var numberText = productNumber ? productNumber.getAttribute('data-product-number') : '';

                // Also check URL slug in href
                var productLink = item.querySelector('a[href]');
                var hrefText = productLink ? productLink.getAttribute('href') : '';

                var combinedText = (productText + ' ' + numberText + ' ' + hrefText).toLowerCase();

                if (combinedText.indexOf(searchLower) !== -1) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Show/update filter indicator
            showFilterIndicator(searchTerm, visibleCount, totalCount);

            return visibleCount;
        }

        // Show filter indicator banner
        function showFilterIndicator(searchTerm, visibleCount, totalCount) {
            var existingIndicator = document.getElementById('raven-search-filter-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            var category = getCurrentCategory();
            var indicator = document.createElement('div');
            indicator.id = 'raven-search-filter-indicator';
            indicator.style.cssText = 'background: linear-gradient(to right, #fef3c7, #fde68a); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid #f59e0b;';

            var messageHtml = '';
            var buttonsHtml = '';

            if (visibleCount === 0) {
                // No results on this page - offer global search
                messageHtml = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; color: #d97706;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                    '<span style="color: #92400e; font-size: 14px;">Keine Treffer für "<strong>' + searchTerm + '</strong>" auf dieser Seite gefunden.</span>' +
                    '</div>';
                buttonsHtml = '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
                    '<a href="/search?search=' + encodeURIComponent(searchTerm) + '" id="raven-global-search" style="background: #d97706; border: none; color: #fff; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s;">Im gesamten Shop suchen</a>' +
                    '<button id="raven-clear-filter" style="background: #fff; border: 1px solid #d97706; color: #d97706; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Abbrechen</button>' +
                    '</div>';
            } else {
                // Results found
                messageHtml = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; color: #d97706;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                    '<span style="color: #92400e; font-size: 14px;">Suche in <strong>' + category.name + '</strong>: "<strong>' + searchTerm + '</strong>" - ' + visibleCount + ' von ' + totalCount + ' Produkten</span>' +
                    '</div>';
                buttonsHtml = '<button id="raven-clear-filter" style="background: #fff; border: 1px solid #d97706; color: #d97706; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Filter aufheben</button>';
            }

            indicator.innerHTML = messageHtml + buttonsHtml;

            var mainContent = document.querySelector('main, .content-main, #content-main');
            if (mainContent) {
                mainContent.insertBefore(indicator, mainContent.firstChild);
            } else {
                document.body.insertBefore(indicator, document.body.firstChild);
            }

            // Clear filter button handler
            document.getElementById('raven-clear-filter').addEventListener('click', function() {
                clearFilter();
            });
        }

        // Clear filter and show all products
        function clearFilter() {
            var productItems = document.querySelectorAll('.product-box, .raven-card, .cms-listing-col');
            productItems.forEach(function(item) {
                item.style.display = '';
            });

            var indicator = document.getElementById('raven-search-filter-indicator');
            if (indicator) {
                indicator.remove();
            }

            // Clear search input
            document.querySelectorAll('.raven-search-input').forEach(function(input) {
                input.value = '';
            });

            // Remove search param from URL
            var url = new URL(window.location.href);
            url.searchParams.delete('search');
            window.history.replaceState({}, '', url.pathname);
        }

        // Handle search form submission
        function handleSearchSubmit(e) {
            var form = e.target;
            if (!form.classList.contains('raven-search-form') && !form.closest('.raven-header')) {
                return;
            }

            var searchInput = form.querySelector('input[name="search"]');
            var searchTerm = searchInput ? searchInput.value.trim() : '';

            if (!searchTerm) {
                e.preventDefault();
                return;
            }

            var category = getCurrentCategory();

            if (category) {
                // On a category page - filter products client-side
                e.preventDefault();

                // Update URL without reload
                var url = new URL(window.location.href);
                url.searchParams.set('search', searchTerm);
                window.history.pushState({}, '', url.toString());

                // Filter products
                filterProductsOnPage(searchTerm);
            }
            // If not on a category page, let the form submit normally to global search
        }

        // Check URL for existing search param on page load
        function checkUrlForSearch() {
            var category = getCurrentCategory();
            if (category) {
                var urlParams = new URLSearchParams(window.location.search);
                var searchTerm = urlParams.get('search');
                if (searchTerm) {
                    // Set the search input value
                    document.querySelectorAll('.raven-search-input').forEach(function(input) {
                        input.value = searchTerm;
                    });
                    // Filter products
                    filterProductsOnPage(searchTerm);
                }
            }
        }

        // Attach event listeners to search forms
        document.querySelectorAll('.raven-search-form, .raven-header form[action*="search"]').forEach(function(form) {
            form.addEventListener('submit', handleSearchSubmit);
        });

        // Also handle forms dynamically with event delegation
        document.addEventListener('submit', function(e) {
            var form = e.target;
            if (form.classList.contains('raven-search-form') ||
                (form.closest('.raven-header') && form.querySelector('input[name="search"]'))) {
                handleSearchSubmit(e);
            }
        }, false);

        // Update placeholders on load
        updateSearchPlaceholders();

        // Check for search param in URL
        checkUrlForSearch();

        console.log('Category-specific search initialized');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCategorySearch);
    } else {
        initCategorySearch();
    }

    // Live Search Autocomplete
    function initLiveSearch() {
        var searchInputs = document.querySelectorAll('.raven-search-input');
        var searchTimeout = null;
        var minChars = 2;

        searchInputs.forEach(function(input) {
            var form = input.closest('form');
            var wrapper = form.parentElement;

            // Create dropdown container
            var dropdown = document.createElement('div');
            dropdown.className = 'raven-search-dropdown';
            wrapper.appendChild(dropdown);

            // Handle input typing
            input.addEventListener('input', function() {
                var query = input.value.trim();

                clearTimeout(searchTimeout);

                if (query.length < minChars) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Show loading state
                dropdown.innerHTML = '<div class="raven-search-loading">Suche...</div>';
                dropdown.classList.add('show');

                // Debounce search
                searchTimeout = setTimeout(function() {
                    performSearch(query, dropdown, input);
                }, 300);
            });

            // Hide dropdown on blur (with delay for click)
            input.addEventListener('blur', function() {
                setTimeout(function() {
                    dropdown.classList.remove('show');
                }, 200);
            });

            // Show dropdown on focus if has content
            input.addEventListener('focus', function() {
                if (dropdown.innerHTML && input.value.trim().length >= minChars) {
                    dropdown.classList.add('show');
                }
            });
        });

        function performSearch(query, dropdown, input) {
            // Use Shopware's suggest endpoint - parse HTML for product data including prices
            fetch('/suggest?search=' + encodeURIComponent(query), {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');

                // Find all product items from Shopware's suggest structure
                var products = doc.querySelectorAll('li.search-suggest-product');
                var resultsHtml = '';
                var foundProducts = [];

                products.forEach(function(product) {
                    if (foundProducts.length >= 8) return;

                    // Get link element
                    var link = product.querySelector('a.search-suggest-product-link');
                    if (!link) return;

                    var href = link.getAttribute('href') || '#';
                    if (href === '#' || href === '') return;

                    // Get product name
                    var name = '';
                    var nameEl = product.querySelector('.search-suggest-product-name');
                    if (nameEl) {
                        name = nameEl.textContent.trim();
                    } else {
                        name = link.getAttribute('title') || '';
                    }
                    if (!name) return;

                    // Get price - look for the span inside price div
                    var price = '';
                    var priceEl = product.querySelector('.search-suggest-product-price span, .search-suggest-product-price');
                    if (priceEl) {
                        var priceText = priceEl.textContent.trim();
                        // Parse price like "CHF 2,985.00" and convert to "CHF 2'985"
                        var priceMatch = priceText.match(/CHF\s*([\d,.']+)/i);
                        if (priceMatch) {
                            // Remove thousands separator and parse
                            var priceNum = parseFloat(priceMatch[1].replace(/[,']/g, ''));
                            if (!isNaN(priceNum)) {
                                var roundedPrice = Math.round(priceNum);
                                price = 'CHF ' + roundedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "'");
                            }
                        }
                    }

                    // Get image
                    var img = '';
                    var imgEl = product.querySelector('img.search-suggest-product-image');
                    if (imgEl) {
                        img = imgEl.getAttribute('src') || '';
                    }

                    foundProducts.push({ href: href, name: name, price: price, img: img });
                });

                if (foundProducts.length > 0) {
                    resultsHtml += '<div class="raven-search-section">';
                    resultsHtml += '<div class="raven-search-section-title">Produkte</div>';

                    foundProducts.forEach(function(product) {
                        resultsHtml += '<a href="' + escapeHtml(product.href) + '" class="raven-search-item">';
                        if (product.img) {
                            resultsHtml += '<img src="' + escapeHtml(product.img) + '" class="raven-search-item-image" alt="">';
                        } else {
                            resultsHtml += '<div class="raven-search-item-image" style="display:flex;align-items:center;justify-content:center;color:#d1d5db;background:#f3f4f6;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:20px;height:20px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>';
                        }
                        resultsHtml += '<div class="raven-search-item-info">';
                        resultsHtml += '<div class="raven-search-item-name">' + escapeHtml(product.name) + '</div>';
                        resultsHtml += '</div>';
                        if (product.price) {
                            resultsHtml += '<div class="raven-search-item-price">' + escapeHtml(product.price) + '</div>';
                        }
                        resultsHtml += '</a>';
                    });

                    resultsHtml += '</div>';
                    resultsHtml += '<a href="/search?search=' + encodeURIComponent(query) + '" class="raven-search-view-all">Alle Ergebnisse anzeigen</a>';
                } else {
                    resultsHtml = '<div class="raven-search-no-results">';
                    resultsHtml += 'Keine Produkte gefunden f\u00fcr "<strong>' + escapeHtml(query) + '</strong>"';
                    resultsHtml += '</div>';
                    resultsHtml += '<a href="/search?search=' + encodeURIComponent(query) + '" class="raven-search-view-all">Im gesamten Shop suchen</a>';
                }

                dropdown.innerHTML = resultsHtml;
            })
            .catch(function(error) {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="raven-search-no-results">Suche fehlgeschlagen</div>';
            });
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('Live search autocomplete initialized');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLiveSearch);
    } else {
        initLiveSearch();
    }
})();
</script>

<header class="raven-header" style="width: 100%;">
    {# Mobile Header #}
    <div class="raven-header-mobile md:hidden bg-white relative z-50" style="width: 100%;">
        <div style="width: 100%; padding: 12px 24px;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="{{ path('frontend.home.page') }}" class="raven-logo inline-flex items-center" aria-label="Raven Weapon home">
                        <div style="background-image:url('{{ asset('bundles/raventheme/assets/logo.svg') }}');background-size:100% 455%;background-position:left;background-repeat:no-repeat;height:36px;width:160px;"></div>
                    </a>
                </div>
                <div class="flex items-center gap-3">
                    {# Account Icon Mobile - With Dropdown #}
                    <div class="raven-account-dropdown" style="position: relative;">
                        <button type="button"
                                class="raven-icon-btn raven-account-btn relative inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                                aria-label="Mein Konto">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                            </svg>
                        </button>
                        {# Mobile Dropdown Menu - Server-side rendered #}
                        <div class="raven-account-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; overflow: hidden; z-index: 1000;">
                            {% if context.customer %}
                                {# Logged In Menu #}
                                <div style="padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <p style="font-size: 12px; color: #6b7280; margin: 0;">Angemeldet als</p>
                                    <p style="font-size: 14px; font-weight: 600; color: #111827; margin: 4px 0 0 0;">{{ context.customer.firstName }} {{ context.customer.lastName }}</p>
                                </div>
                                <a href="{{ path('frontend.account.home.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/></svg>
                                    Mein Konto
                                </a>
                                <a href="{{ path('frontend.account.order.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>
                                    Bestellungen
                                </a>
                                <div style="border-top: 1px solid #f3f4f6;">
                                    <a href="{{ path('frontend.account.logout.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #dc2626; font-size: 14px; text-decoration: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                        Abmelden
                                    </a>
                                </div>
                            {% else %}
                                {# Not Logged In Menu #}
                                <a href="{{ path('frontend.account.login.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                    Anmelden
                                </a>
                                <a href="{{ path('frontend.account.register.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                    Registrieren
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {# Cart Button Mobile - Opens Off-Canvas Cart Sidebar #}
                    <div class="header-cart-wrapper" style="display: flex; align-items: center; gap: 4px;">
                        <button type="button"
                                class="raven-icon-btn header-cart-btn relative inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                                data-off-canvas-cart="true"
                                data-url="{{ path('frontend.cart.offcanvas') }}"
                                aria-label="Warenkorb">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="9" cy="21" r="1"/>
                                <circle cx="20" cy="21" r="1"/>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                        </button>
                        {% if page.cart.lineItems.count > 0 %}
                            <span class="raven-cart-badge-outside" style="display: inline-flex; align-items: center; justify-content: center; min-width: 22px; height: 22px; padding: 0 6px; background: linear-gradient(to right, #facc15, #f59e0b, #facc15); color: #000; font-size: 11px; font-weight: 700; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                                {{ page.cart.lineItems.count }}
                            </span>
                        {% endif %}
                    </div>
                    {# Mobile Menu Toggle #}
                    <button type="button"
                            class="raven-icon-btn md:hidden inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                            data-offcanvas-menu-toggle="true"
                            aria-label="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Desktop Header #}
    <div class="raven-header-desktop hidden md:block bg-white" style="width: 100%; border-bottom: 1px solid #e5e7eb;">
        <div style="width: 100%; max-width: 1200px; margin: 0 auto; padding-left: 24px; padding-right: 24px; padding-top: 12px;">
            {# Top Row: Logo, Search (centered), Account, Cart - Compact layout #}
            <div style="display: flex; align-items: center; justify-content: center; height: 40px; gap: 32px;">
                {# Left: Logo #}
                <div style="flex-shrink: 0;">
                    <a href="{{ path('frontend.home.page') }}" class="raven-logo inline-flex items-center" aria-label="Raven Weapon home">
                        <div style="background-image:url('{{ asset('bundles/raventheme/assets/logo.svg') }}');background-size:100% 455%;background-position:left;background-repeat:no-repeat;height:32px;width:140px;"></div>
                    </a>
                </div>

                {# Center: Search Bar - Smaller and elegant #}
                <div style="position: relative; flex: 0 1 400px;">
                    {% block layout_header_search %}
                        <form action="{{ path('frontend.search.page') }}" method="get" class="raven-search-form" style="position: relative;">
                            <input type="search"
                                   name="search"
                                   placeholder="Produkte suchen..."
                                   class="raven-search-input"
                                   style="width: 100%; height: 26px; border-radius: 9999px; background: #f3f4f6; padding-left: 28px; padding-right: 10px; font-size: 11px; color: #1f2937; border: 1px solid transparent; outline: none;"
                                   aria-label="Suche">
                            <button type="submit" style="position: absolute; left: 9px; top: 50%; transform: translateY(-50%); color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0;" aria-label="Suchen">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; display: block;">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                            </button>
                        </form>
                    {% endblock %}
                </div>

                {# Right: Account & Cart #}
                <div style="flex-shrink: 0; display: flex; align-items: center; gap: 6px;">
                    {# Account - With Dropdown Menu #}
                    <div class="raven-account-dropdown" style="position: relative;">
                        <button type="button"
                                class="raven-icon-btn raven-account-btn relative inline-flex items-center justify-center h-8 w-8 rounded-lg border border-gray-200 text-gray-500 bg-white"
                                aria-label="Mein Konto"
                                title="Mein Konto">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                            </svg>
                        </button>
                        {# Dropdown Menu - Server-side rendered based on login state #}
                        <div class="raven-account-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; overflow: hidden; z-index: 1000;">
                            {% if context.customer %}
                                {# Logged In Menu #}
                                <div style="padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <p style="font-size: 12px; color: #6b7280; margin: 0;">Angemeldet als</p>
                                    <p style="font-size: 14px; font-weight: 600; color: #111827; margin: 4px 0 0 0;">{{ context.customer.firstName }} {{ context.customer.lastName }}</p>
                                </div>
                                <a href="{{ path('frontend.account.home.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <circle cx="12" cy="8" r="4"/>
                                        <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                                    </svg>
                                    Mein Konto
                                </a>
                                <a href="{{ path('frontend.account.order.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                        <line x1="3" y1="6" x2="21" y2="6"/>
                                    </svg>
                                    Bestellungen
                                </a>
                                <div style="border-top: 1px solid #f3f4f6;">
                                    <a href="{{ path('frontend.account.logout.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #dc2626; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                            <polyline points="16 17 21 12 16 7"/>
                                            <line x1="21" y1="12" x2="9" y2="12"/>
                                        </svg>
                                        Abmelden
                                    </a>
                                </div>
                            {% else %}
                                {# Not Logged In Menu #}
                                <a href="{{ path('frontend.account.login.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                        <polyline points="10 17 15 12 10 7"/>
                                        <line x1="15" y1="12" x2="3" y2="12"/>
                                    </svg>
                                    Anmelden
                                </a>
                                <a href="{{ path('frontend.account.register.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="8.5" cy="7" r="4"/>
                                        <line x1="20" y1="8" x2="20" y2="14"/>
                                        <line x1="23" y1="11" x2="17" y2="11"/>
                                    </svg>
                                    Registrieren
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    {# Cart Button Desktop - Opens Off-Canvas Cart Sidebar #}
                    <div class="header-cart-wrapper" style="display: flex; align-items: center; gap: 4px;">
                        <button type="button"
                                class="raven-icon-btn header-cart-btn relative inline-flex items-center justify-center h-8 w-8 rounded-lg border border-gray-200 text-gray-500 bg-white"
                                data-off-canvas-cart="true"
                                data-url="{{ path('frontend.cart.offcanvas') }}"
                                aria-label="Warenkorb"
                                title="Warenkorb">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="9" cy="21" r="1"/>
                                <circle cx="20" cy="21" r="1"/>
                                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                        </button>
                        {% set cartCount = page.cart.lineItems.count|default(0) %}
                        {% if cartCount > 0 %}
                            <span class="raven-cart-badge-outside" style="display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; background: linear-gradient(to right, #facc15, #f59e0b, #facc15); color: #000; font-size: 11px; font-weight: 700; border-radius: 9999px; box-shadow: 0 1px 3px rgba(0,0,0,0.2);">
                                {{ cartCount }}
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Navigation Row - Categories with Dropdowns #}
            <div class="pb-3">
                <nav id="raven-main-nav" class="flex items-center justify-center gap-8">
                    {# Alle Produkte - WITH 2-column mega menu #}
                    <div class="raven-nav-item">
                        <a href="/Alle-Produkte/"
                           class="raven-nav-link inline-flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 py-2">
                            Alle Produkte
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.5;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </a>
                        <div class="raven-mega-menu" style="min-width: 680px; padding: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 32px;">
                                {# Column 1 - Waffen #}
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 16px;">Waffen</div>
                                    <a href="/.223-RAVEN/RAVEN-223" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        .223 RAVEN
                                    </a>
                                    <a href="/9mm-RAVEN/RAVEN-9MM" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        9mm RAVEN
                                    </a>
                                    <a href="/.22-LR-RAVEN/RAVEN-22-LR" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        .22 LR RAVEN
                                    </a>
                                    <a href="/300-AAC-RAVEN/RAVEN-300AAC" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        300 AAC RAVEN
                                    </a>
                                    <a href="/7.62x39-RAVEN/RAVEN-762" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        7.62x39 RAVEN
                                    </a>
                                </div>
                                {# Column 2 - Kaliber Kits #}
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 16px;">Kaliber Kits</div>
                                    <a href="/.223-CALIBER-KIT/KIT-223" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        .223 Caliber Kit
                                    </a>
                                    <a href="/9mm-CALIBER-KIT/KIT-9MM" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        9mm Caliber Kit
                                    </a>
                                    <a href="/.22LR-CALIBER-KIT/KIT-22LR" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        .22 LR Caliber Kit
                                    </a>
                                    <a href="/300-AAC-CALIBER-KIT/KIT-300AAC" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        300 AAC Caliber Kit
                                    </a>
                                    <a href="/7.62x39-CALIBER-KIT/KIT-762" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        7.62x39 Caliber Kit
                                    </a>
                                </div>
                                {# Column 3 - Waffenzubehör #}
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 16px;">Waffenzubehör</div>
                                    <a href="/Waffenzubehoer/Griffe/" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        Griffe
                                    </a>
                                    <a href="/Waffenzubehoer/Optik/" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        Optik
                                    </a>
                                    <a href="/Waffenzubehoer/Montagen/" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        Montagen
                                    </a>
                                    <a href="/Waffenzubehoer/Zweibein/" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        Zweibein
                                    </a>
                                    <a href="/Waffenzubehoer/Muendung/" style="display: flex; align-items: center; gap: 10px; padding: 8px 0; color: #6b7280; font-size: 14px; text-decoration: none; transition: color 0.15s;">
                                        <span style="color: #9ca3af; font-size: 14px;">↳</span>
                                        Mündung
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Waffen - WITH dropdown submenu #}
                    <div class="raven-nav-item">
                        <a href="/Raven-Weapons/"
                           class="raven-nav-link inline-flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 py-2">
                            Waffen
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.5;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </a>
                        <div class="raven-mega-menu">
                            <div class="menu-header">Waffen</div>
                            <a href="/.223-RAVEN/RAVEN-223">
                                <span style="color: #9ca3af;">↳</span>
                                .223 RAVEN
                            </a>
                            <a href="/9mm-RAVEN/RAVEN-9MM">
                                <span style="color: #9ca3af;">↳</span>
                                9mm RAVEN
                            </a>
                            <a href="/.22-LR-RAVEN/RAVEN-22-LR">
                                <span style="color: #9ca3af;">↳</span>
                                .22 LR RAVEN
                            </a>
                            <a href="/300-AAC-RAVEN/RAVEN-300AAC">
                                <span style="color: #9ca3af;">↳</span>
                                300 AAC RAVEN
                            </a>
                            <a href="/7.62x39-RAVEN/RAVEN-762">
                                <span style="color: #9ca3af;">↳</span>
                                7.62x39 RAVEN
                            </a>
                        </div>
                    </div>

                    {# Kaliber Kits - WITH dropdown submenu #}
                    <div class="raven-nav-item">
                        <a href="/Raven-Caliber-Kit/"
                           class="raven-nav-link inline-flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 py-2">
                            Kaliber Kits
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.5;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </a>
                        <div class="raven-mega-menu">
                            <div class="menu-header">Kaliber Kits</div>
                            <a href="/.223-CALIBER-KIT/KIT-223">
                                <span style="color: #9ca3af;">↳</span>
                                .223 Caliber Kit
                            </a>
                            <a href="/9mm-CALIBER-KIT/KIT-9MM">
                                <span style="color: #9ca3af;">↳</span>
                                9mm Caliber Kit
                            </a>
                            <a href="/.22LR-CALIBER-KIT/KIT-22LR">
                                <span style="color: #9ca3af;">↳</span>
                                .22 LR Caliber Kit
                            </a>
                            <a href="/300-AAC-CALIBER-KIT/KIT-300AAC">
                                <span style="color: #9ca3af;">↳</span>
                                300 AAC Caliber Kit
                            </a>
                            <a href="/7.62x39-CALIBER-KIT/KIT-762">
                                <span style="color: #9ca3af;">↳</span>
                                7.62x39 Caliber Kit
                            </a>
                        </div>
                    </div>

                    {# Zubehoer - WITH submenu showing categories #}
                    <div class="raven-nav-item">
                        <a href="/Waffenzubehoer/"
                           class="raven-nav-link inline-flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-gray-900 py-2">
                            Waffenzubehör
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px; opacity: 0.5;">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </a>
                        <div class="raven-mega-menu">
                            <div class="menu-header">Waffenzubehör</div>
                            <a href="/Waffenzubehoer/Griffe/">
                                <span style="color: #9ca3af;">↳</span>
                                Griffe
                            </a>
                            <a href="/Waffenzubehoer/Optik/">
                                <span style="color: #9ca3af;">↳</span>
                                Optik
                            </a>
                            <a href="/Waffenzubehoer/Montagen/">
                                <span style="color: #9ca3af;">↳</span>
                                Montagen
                            </a>
                            <a href="/Waffenzubehoer/Zweibein/">
                                <span style="color: #9ca3af;">↳</span>
                                Zweibein
                            </a>
                            <a href="/Waffenzubehoer/Muendung/">
                                <span style="color: #9ca3af;">↳</span>
                                Mündung
                            </a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </div>

    {# Mobile Search Bar - Improved #}
    <div class="md:hidden" style="background: white; border-bottom: 1px solid #f3f4f6; padding: 12px 24px;">
        <div style="position: relative;">
            <form action="{{ path('frontend.search.page') }}" method="get" class="raven-search-form" style="position: relative;">
                <input type="search"
                       name="search"
                       placeholder="Produkte suchen..."
                       class="raven-search-input"
                       style="width: 100%; height: 40px; border-radius: 9999px; background: #f3f4f6; padding-left: 44px; padding-right: 16px; font-size: 15px; color: #1f2937; border: 1px solid transparent; outline: none;"
                       aria-label="Suche">
                <button type="submit" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0;" aria-label="Suchen">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; display: block;">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</header>

<!-- Second cart handler removed - using main handler from above -->
{% endblock %}
