{% sw_extends '@Storefront/storefront/layout/header/header.html.twig' %}

{% block layout_header_actions_cart %}
    {# Cart Button - Opens Off-Canvas Cart Sidebar using Shopware's built-in plugin #}
    <div class="header-cart-wrapper" style="position: relative; display: inline-flex;">
        <button type="button"
                class="raven-icon-btn header-cart-btn"
                data-off-canvas-cart="true"
                data-url="{{ path('frontend.cart.offcanvas') }}"
                aria-label="Warenkorb"
                title="Warenkorb"
                style="display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #6b7280;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        </button>
        {% set cartCount = page.cart.lineItems.count|default(0) %}
        {% if cartCount > 0 %}
            <span class="raven-cart-badge" style="position: absolute; top: -6px; right: -6px; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 5px; background: linear-gradient(135deg, #facc15, #f59e0b); color: #000; font-size: 11px; font-weight: 700; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">{{ cartCount }}</span>
        {% endif %}
    </div>
{% endblock %}

{% block layout_header %}
{# Organization Schema.org JSON-LD for Google Rich Snippets #}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Raven Weapon AG",
    "url": "https://ravenweapon.ch",
    "logo": "https://ravenweapon.ch/bundles/raventheme/assets/raven-logo.png",
    "description": "Schweizer Waffenhändler - Waffen, Munition, Optik & Zubehör online kaufen",
    "address": {
        "@type": "PostalAddress",
        "addressCountry": "CH",
        "addressRegion": "Schweiz"
    },
    "contactPoint": {
        "@type": "ContactPoint",
        "email": "info@ravenweapon.ch",
        "contactType": "customer service"
    }
}
</script>
<style>
    /* Fixed header compensation - add padding to body so content doesn't hide under header */
    body {
        padding-top: 70px; /* Mobile header height */
    }
    @media (min-width: 768px) {
        body {
            padding-top: 140px; /* Desktop header height - now taller with 2-row nav */
        }
    }

    /* Hide dark CMS "coming soon" blocks - clean template is used instead */
    .cms-element-text > div[style*="background:#1a"],
    .cms-element-text > div[style*="background: #1a"],
    .cms-element-text > div[style*="background:#2"],
    .cms-element-text > div[style*="background: #2"] {
        display: none !important;
    }

    /* Hide manufacturer name ONLY on Waffenzubehör page */
    body.page-waffenzubehoer .raven-manufacturer {
        display: none !important;
    }

    /* Make header full width - override Shopware's container constraints */
    .header-main,
    header.header-main,
    .header-row,
    .header-main > .container,
    .header-main .container {
        max-width: 100% !important;
        width: 100% !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    /* Remove bottom border/shadow from header-main if any */
    .header-main {
        border-bottom: none !important;
        box-shadow: none !important;
    }

    /* Header Animations & Styles */
    .raven-header {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
    }
    .raven-header a, .raven-header button {
        transition: all 0.2s ease;
    }
    .raven-nav-link {
        position: relative;
        transition: color 0.2s ease;
        white-space: nowrap;
    }
    .raven-nav-link::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 2px;
        background: linear-gradient(to right, #F2B90D, #D4A847);
        transition: width 0.3s ease;
    }
    .raven-nav-link:hover::after, .raven-nav-link.active::after {
        width: 100%;
    }
    .raven-nav-link:hover {
        color: #111827 !important;
    }
    /* Keep yellow underline active when hovering anywhere in dropdown */
    .raven-nav-item:hover .raven-nav-link::after {
        width: 100%;
    }
    .raven-nav-item:hover .raven-nav-link {
        color: #111827 !important;
    }

    /* ============================================ */
    /* SINGLE ROW NAVIGATION LAYOUT               */
    /* ============================================ */
    .raven-nav-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0;
        width: 100%;
    }
    .raven-nav-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        flex-wrap: nowrap;
    }
    .raven-nav-row-1 {
        gap: 24px;
    }
    .raven-nav-row-1 .raven-nav-link {
        font-size: 16px !important;
    }
    .raven-nav-row-2 {
        display: none;
    }

    /* Active state for current page */
    .raven-nav-link.is-active {
        color: #111827 !important;
        font-weight: 600;
    }
    .raven-nav-link.is-active::after {
        width: 100%;
        background: linear-gradient(to right, #F2B90D, #D4A847);
    }

    /* ============================================ */
    /* THORON-STYLE FULL-WIDTH DROPDOWN            */
    /* ============================================ */
    .raven-nav-item {
        position: static;
    }
    .raven-mega-menu {
        position: fixed;
        top: auto;
        left: 0;
        right: 0;
        width: 100vw;
        background: #fff;
        border-top: 1px solid #e5e7eb;
        box-shadow: 0 10px 40px rgba(0,0,0,0.12);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s ease 0.15s, visibility 0.2s ease 0.15s; /* 0.15s delay when closing */
        z-index: 1000;
    }
    .raven-nav-item:hover .raven-mega-menu,
    .raven-mega-menu:hover {
        opacity: 1;
        visibility: visible;
        transition-delay: 0s; /* No delay when opening */
    }
    .raven-mega-menu-inner {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        min-height: 300px;
    }
    /* Left Column - Subcategories */
    .raven-dropdown-left {
        width: 320px;
        flex-shrink: 0;
        border-right: 1px solid #f3f4f6;
        padding: 16px 0;
        background: #fafafa;
        position: relative;
    }
    /* Invisible bridge to prevent hover loss when moving to right column */
    .raven-dropdown-left::after {
        content: '';
        position: absolute;
        right: -30px;
        top: 0;
        bottom: 0;
        width: 30px;
        background: transparent;
    }
    .raven-dropdown-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 24px;
        color: #374151;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.15s ease;
        cursor: pointer;
    }
    .raven-dropdown-item:hover,
    .raven-dropdown-item.active {
        background: #fff;
        color: #111827;
    }
    .raven-dropdown-item.active {
        border-left: 3px solid #F2B90D;
        padding-left: 21px;
    }
    .raven-dropdown-arrow {
        color: #9ca3af;
        font-size: 16px;
        transition: transform 0.15s ease;
    }
    .raven-dropdown-item:hover .raven-dropdown-arrow,
    .raven-dropdown-item.active .raven-dropdown-arrow {
        color: #F2B90D;
        transform: translateX(3px);
    }
    /* Right Column - Sub-subcategories */
    .raven-dropdown-right {
        flex: 1;
        padding: 24px 32px;
        background: #fff;
    }
    .raven-submenu {
        display: none;
    }
    .raven-submenu.active {
        display: block;
    }
    .raven-submenu-title {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #F2B90D;
    }
    .raven-submenu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 8px 24px;
    }
    .raven-submenu-link {
        display: block;
        padding: 8px 0;
        color: #6b7280;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        text-decoration: none;
        transition: color 0.15s ease;
    }
    .raven-submenu-link:hover {
        color: #F2B90D;
    }
    .raven-submenu-viewall {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-top: 16px;
        padding: 8px 16px;
        background: #111827;
        color: #fff;
        font-family: 'Inter', sans-serif;
        font-size: 13px;
        font-weight: 500;
        text-decoration: none;
        border-radius: 6px;
        transition: background 0.15s ease;
    }
    .raven-submenu-viewall:hover {
        background: #F2B90D;
        color: #111827;
    }
    .raven-submenu-empty {
        color: #9ca3af;
        font-size: 14px;
        font-style: italic;
        padding: 16px 0;
    }
    /* No children - show empty state */
    .raven-dropdown-right-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #9ca3af;
        font-size: 14px;
    }

    /* Category Preview Card (for subcategories without grandchildren) */
    .raven-category-preview {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 32px;
        min-height: 250px;
    }
    .raven-preview-icon {
        margin-bottom: 16px;
        opacity: 0.6;
    }
    .raven-preview-title {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 22px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
    }
    .raven-preview-desc {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #6b7280;
        margin-bottom: 24px;
        max-width: 300px;
    }
    .raven-preview-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #facc15, #f59e0b);
        color: #111827;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }
    .raven-preview-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
    }

    /* ============================================ */
    /* SIMPLE DROPDOWN (for categories w/o grandchildren) */
    /* ============================================ */
    .raven-simple-dropdown {
        position: fixed;
        top: auto;
        left: 50%;
        transform: translateX(-50%);
        width: auto;
        min-width: 280px;
        max-width: 400px;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .raven-simple-dropdown-inner {
        padding: 12px 0;
    }
    .raven-simple-dropdown-item {
        display: block;
        padding: 12px 24px;
        color: #374151;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.15s ease;
    }
    .raven-simple-dropdown-item:hover {
        background: #f9fafb;
        color: #F2B90D;
    }

    /* Live Search Autocomplete Styles */
    .raven-search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid #e5e7eb;
        margin-top: 8px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .raven-search-dropdown.show {
        display: block;
        animation: fadeInDown 0.15s ease;
    }
    .raven-search-section {
        padding: 8px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    .raven-search-section:last-child {
        border-bottom: none;
    }
    .raven-search-section-title {
        padding: 8px 16px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #9ca3af;
    }
    .raven-search-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        text-decoration: none;
        transition: background 0.15s ease;
    }
    .raven-search-item:hover {
        background: #f9fafb;
    }
    .raven-search-item-image {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        object-fit: cover;
        background: #f3f4f6;
    }
    .raven-search-item-info {
        flex: 1;
        min-width: 0;
    }
    .raven-search-item-name {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .raven-search-item-details {
        font-size: 12px;
        color: #6b7280;
    }
    .raven-search-item-price {
        font-size: 14px;
        font-weight: 700;
        color: #d97706;
        white-space: nowrap;
        margin-left: auto;
        padding-left: 12px;
        min-width: 90px;
        text-align: right;
    }
    .raven-search-loading {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 14px;
    }
    .raven-search-no-results {
        padding: 20px;
        text-align: center;
        color: #6b7280;
        font-size: 14px;
    }
    .raven-search-view-all {
        display: block;
        padding: 12px 16px;
        text-align: center;
        background: #f9fafb;
        color: #d97706;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        border-top: 1px solid #f3f4f6;
    }
    .raven-search-view-all:hover {
        background: #f3f4f6;
        color: #b45309;
    }
    .raven-icon-btn {
        transition: all 0.2s ease;
    }
    .raven-icon-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }
    .raven-icon-btn:hover svg {
        color: #111827;
    }
    .raven-search-input {
        transition: all 0.2s ease;
    }
    .raven-search-input:focus {
        background: rgba(120,120,128,0.12);
        box-shadow: 0 0 0 3px rgba(212, 168, 71, 0.2);
    }
    .raven-logo {
        transition: opacity 0.2s ease;
    }
    .raven-logo:hover {
        opacity: 0.85;
    }
    .raven-cart-badge-outside {
        animation: pulse-badge 2s infinite;
    }
    @keyframes pulse-badge {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Fix cart offcanvas - hide default Shopware elements and black spots */
    #raven-offcanvas-cart .offcanvas-close,
    #raven-offcanvas-cart .btn-close,
    #raven-offcanvas-cart > button:first-child,
    #raven-offcanvas-cart > .offcanvas-header,
    .offcanvas-cart .offcanvas-close,
    .offcanvas-cart .btn-close {
        display: none !important;
    }

    /* Ensure offcanvas has no extra elements at top */
    #raven-offcanvas-cart {
        display: flex;
        flex-direction: column;
    }

    #raven-offcanvas-cart > .raven-offcanvas-cart {
        height: 100%;
    }

    /* Hide any stray backdrop buttons */
    #raven-offcanvas-backdrop button,
    .offcanvas-backdrop button {
        display: none !important;
    }
    /* Fix search icon display */
    .raven-search-form button[type="submit"] svg,
    .raven-search-form button[type="submit"] img {
        width: 16px !important;
        height: 16px !important;
        display: block !important;
    }
    /* Hide Shopware's default search suggest button that appears on right */
    .header-search-btn,
    .search-suggest-container .btn {
        display: none !important;
    }

    /* Account dropdown menu styles */
    .raven-account-menu a:hover {
        background: #f9fafb !important;
    }
    .raven-account-menu a[href*="logout"]:hover {
        background: #fef2f2 !important;
    }
    .raven-account-menu.show {
        display: block !important;
        animation: fadeInDown 0.15s ease;
    }
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
(function() {
    'use strict';

    // Update cart badge count in navbar
    function updateCartBadge() {
        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(html) {
            var count = 0;

            // Try to find the count from the raven-cart-count span
            var countMatch = html.match(/class="raven-cart-count"[^>]*>(\d+)</);
            if (countMatch) {
                count = parseInt(countMatch[1]);
            } else {
                // Fallback: count cart items by looking for js-cart-item class
                var itemMatches = html.match(/class="[^"]*js-cart-item[^"]*"/g);
                if (itemMatches) {
                    count = itemMatches.length;
                }
            }

            console.log('Cart badge update: ' + count + ' items');

            // Update existing badges (positioned at top-right of cart button)
            document.querySelectorAll('.header-cart-wrapper').forEach(function(wrapper) {
                // Ensure wrapper has position relative for absolute positioning
                wrapper.style.position = 'relative';
                var badge = wrapper.querySelector('.raven-cart-badge');
                if (count > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'raven-cart-badge';
                        badge.style.cssText = 'position:absolute;top:-6px;right:-6px;display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 5px;background:linear-gradient(135deg,#facc15,#f59e0b);color:#000;font-size:11px;font-weight:700;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,0.15);';
                        wrapper.appendChild(badge);
                    }
                    badge.textContent = count;
                    badge.style.display = 'inline-flex';
                } else if (badge) {
                    badge.style.display = 'none';
                }
            });
        });
    }

    // Update cart item colors and images from localStorage (global function)
    // NOTE: Server now stores variants in line item payload, so this only handles images
    // and fallback for empty color spans. Don't overwrite server-rendered "Variante:" text.
    window.updateCartColors = function() {
        document.querySelectorAll('.raven-cart-item, [data-product-id]').forEach(function(item) {
            var productId = item.getAttribute('data-product-id');
            if (productId) {
                var colorData = localStorage.getItem('raven_color_' + productId);
                var colorSpan = item.querySelector('.raven-item-color');
                var currentText = colorSpan ? colorSpan.textContent.trim() : '';

                // Only update if server didn't render the variant (empty or no "Variante:" prefix)
                // Server-rendered content has "Variante: ColorName" format
                var serverRendered = currentText.indexOf('Variante:') === 0;

                if (colorData) {
                    try {
                        var data = JSON.parse(colorData);
                        // Only update color text if server didn't already render it
                        if (colorSpan && data.color && !serverRendered && !currentText) {
                            colorSpan.textContent = data.color;
                        }
                        // Update image if we have a stored image URL
                        if (data.image) {
                            var img = item.querySelector('.raven-item-image img, .raven-cart-item-img, img');
                            if (img) {
                                img.src = data.image;
                            }
                        }
                    } catch(e) {}
                } else if (!serverRendered && !currentText) {
                    // Only default to "Graphite Black" for Raven Weapons if server didn't render
                    var productNum = item.querySelector('[data-product-number]');
                    var pn = productNum ? productNum.getAttribute('data-product-number') : '';
                    if (colorSpan && pn && (pn.startsWith('RW-') || pn.startsWith('LT-') || pn.startsWith('RAVEN'))) {
                        colorSpan.textContent = 'Graphite Black';
                    }
                    // For Snigel (SN-) and other products, leave color empty
                }
            }
        });
    };
    var updateCartColors = window.updateCartColors;

    // Watch for cart items being added to DOM and update their colors/images
    if (typeof MutationObserver !== 'undefined') {
        var cartObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    // Check if any added nodes contain cart items
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            if (node.classList && (node.classList.contains('raven-cart-item') || node.hasAttribute('data-product-id'))) {
                                setTimeout(updateCartColors, 50);
                            } else if (node.querySelector && node.querySelector('.raven-cart-item, [data-product-id]')) {
                                setTimeout(updateCartColors, 50);
                            }
                        }
                    });
                }
            });
        });
        cartObserver.observe(document.body, { childList: true, subtree: true });
    }

    // Refresh cart content in any open offcanvas
    function refreshOffcanvasCart() {
        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) { return response.text(); })
        .then(function(html) {
            var offcanvas = document.querySelector('.offcanvas.show .offcanvas-body');
            if (offcanvas) {
                offcanvas.innerHTML = html;
            }
            var ravenOffcanvas = document.getElementById('raven-offcanvas-cart');
            if (ravenOffcanvas) {
                ravenOffcanvas.innerHTML = '<div class="offcanvas-body p-0">' + html + '</div>';
            }
            // Update badge after refresh
            updateCartBadge();
            // Update cart colors/images from localStorage
            setTimeout(updateCartColors, 100);
            setTimeout(updateCartColors, 300);
        });
    }

    // Submit form via AJAX and refresh cart
    function submitCartFormAjax(form) {
        var formData = new FormData(form);
        var action = form.getAttribute('action');
        fetch(action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function() { refreshOffcanvasCart(); })
        .catch(function() { refreshOffcanvasCart(); });
    }

    // Delete cart item with instant visual feedback
    function deleteCartItemInstant(form, cartItem) {
        var formData = new FormData(form);
        var action = form.getAttribute('action');

        // Store original styles for potential restore
        var originalHeight = cartItem.offsetHeight + 'px';
        var originalOpacity = '1';

        // Instantly animate out the item
        cartItem.style.transition = 'opacity 0.2s ease, height 0.3s ease, padding 0.3s ease, margin 0.3s ease';
        cartItem.style.opacity = '0';
        cartItem.style.overflow = 'hidden';

        setTimeout(function() {
            cartItem.style.height = '0';
            cartItem.style.padding = '0';
            cartItem.style.margin = '0';
            cartItem.style.borderWidth = '0';
        }, 150);

        // Update cart count badge immediately (decrement by 1)
        var badge = document.querySelector('.raven-cart-badge, .cart-badge, [data-cart-widget] .badge');
        if (badge) {
            var currentCount = parseInt(badge.textContent) || 0;
            if (currentCount > 1) {
                badge.textContent = currentCount - 1;
            } else {
                badge.style.display = 'none';
            }
        }

        // Submit delete request in background
        fetch(action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Delete failed');
            // After successful delete, refresh to get accurate totals
            setTimeout(function() {
                refreshOffcanvasCart();
            }, 300);
        })
        .catch(function(error) {
            console.error('Cart delete error:', error);
            // Restore item on error
            cartItem.style.transition = 'opacity 0.2s ease';
            cartItem.style.opacity = originalOpacity;
            cartItem.style.height = originalHeight;
            cartItem.style.padding = '';
            cartItem.style.margin = '';
            cartItem.style.borderWidth = '';
            cartItem.style.overflow = '';
            // Refresh to get accurate state
            refreshOffcanvasCart();
        });
    }

    // Open cart offcanvas - shows immediately with loading state
    function openOffcanvasCart(skipFetch) {
        // Create backdrop first (show immediately)
        var b = document.getElementById('raven-offcanvas-backdrop');
        if (!b) {
            b = document.createElement('div');
            b.id = 'raven-offcanvas-backdrop';
            b.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1040;opacity:0;transition:opacity 0.2s ease;cursor:pointer;';
            b.onclick = closeOffcanvasCart;
            document.body.appendChild(b);
        }
        // Force reflow and show backdrop
        b.offsetHeight;
        b.style.opacity = '1';

        // Create or get offcanvas (show immediately with loading)
        var o = document.getElementById('raven-offcanvas-cart');
        if (!o) {
            o = document.createElement('div');
            o.id = 'raven-offcanvas-cart';
            o.style.cssText = 'position:fixed;top:0;right:0;bottom:0;width:420px;max-width:100vw;height:100%;z-index:1050;background:#fff;transform:translateX(100%);transition:transform 0.3s ease;box-shadow:-4px 0 15px rgba(0,0,0,0.1);overflow:hidden;';
            document.body.appendChild(o);
        }

        // Always show loading state initially
        o.innerHTML = '<div style="display:flex;flex-direction:column;height:100%;"><div style="padding:20px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center;"><h2 style="font-size:18px;font-weight:600;margin:0;">Warenkorb</h2><button class="raven-cart-close" style="background:none;border:none;cursor:pointer;padding:8px;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div><div style="flex:1;display:flex;align-items:center;justify-content:center;"><div style="text-align:center;"><div style="width:40px;height:40px;border:3px solid #e5e7eb;border-top-color:#f59e0b;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;"></div><p style="color:#6b7280;font-size:14px;">Lädt...</p></div></div></div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';

        // Force reflow and slide in immediately
        o.offsetHeight;
        o.style.transform = 'translateX(0)';
        o.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Attach close handler to loading state close button
        var closeBtn = o.querySelector('.raven-cart-close');
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.preventDefault();
                closeOffcanvasCart();
            };
        }

        // Fetch actual content (unless skipFetch is true)
        if (!skipFetch) {
            fetch('/checkout/offcanvas', {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(r) { return r.text(); })
            .then(function(h) {
                o.innerHTML = h;
                // Attach close handlers to loaded content
                o.querySelectorAll('[data-offcanvas-close],.js-offcanvas-close,.raven-cart-close').forEach(function(x) {
                    x.onclick = function(e) {
                        e.preventDefault();
                        closeOffcanvasCart();
                    };
                });
                if (window.PluginManager) window.PluginManager.initializePlugins();
                // Update cart colors/images from localStorage
                setTimeout(updateCartColors, 100);
                setTimeout(updateCartColors, 300);
            });
        }
    }

    // Update offcanvas content (for use after add-to-cart)
    function updateOffcanvasContent() {
        var o = document.getElementById('raven-offcanvas-cart');
        if (!o || !o.classList.contains('show')) return;

        fetch('/checkout/offcanvas', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(r) { return r.text(); })
        .then(function(h) {
            o.innerHTML = h;
            o.querySelectorAll('[data-offcanvas-close],.js-offcanvas-close,.raven-cart-close').forEach(function(x) {
                x.onclick = function(e) {
                    e.preventDefault();
                    closeOffcanvasCart();
                };
            });
            // Update cart colors/images from localStorage
            setTimeout(updateCartColors, 100);
            setTimeout(updateCartColors, 300);
            if (window.PluginManager) window.PluginManager.initializePlugins();
        });
    }

    // Close cart offcanvas
    function closeOffcanvasCart() {
        var o = document.getElementById('raven-offcanvas-cart');
        var b = document.getElementById('raven-offcanvas-backdrop');
        if (o) {
            o.style.transform = 'translateX(100%)';
            o.classList.remove('show');
        }
        if (b) {
            b.style.opacity = '0';
            setTimeout(function() { b.remove(); }, 150);
        }
        document.body.style.overflow = '';
    }

    // Intercept ALL form submissions using capture phase
    document.addEventListener('submit', function(e) {
        var form = e.target;
        var action = form.getAttribute('action');
        if (!action) return;

        if (action.indexOf('checkout/line-item/delete') !== -1 ||
            action.indexOf('checkout/line-item/change-quantity') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            submitCartFormAjax(form);
            return false;
        }

        if (action.indexOf('checkout/line-item/add') !== -1) {
            e.preventDefault();
            e.stopImmediatePropagation();
            // Open sidebar IMMEDIATELY with loading state
            openOffcanvasCart(true);
            // Then add to cart and update content
            var formData = new FormData(form);
            fetch(action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function() {
                updateCartBadge();
                updateOffcanvasContent();
            });
            return false;
        }
    }, true);

    // Handle quantity and delete button clicks
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-offcanvas-cart]')) {
            e.preventDefault();
            openOffcanvasCart();
            return;
        }

        var minusBtn = e.target.closest('.js-btn-minus, [data-quantity-minus]');
        if (minusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = minusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                if (current > 1) {
                    input.value = current - 1;
                    submitCartFormAjax(form);
                }
            }
            return;
        }

        var plusBtn = e.target.closest('.js-btn-plus, [data-quantity-plus]');
        if (plusBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = plusBtn.closest('form');
            var input = form ? form.querySelector('input[name="quantity"]') : null;
            if (input) {
                var current = parseInt(input.value) || 1;
                input.value = current + 1;
                submitCartFormAjax(form);
            }
            return;
        }

        var removeBtn = e.target.closest('.raven-item-remove, [data-remove-item]');
        if (removeBtn) {
            e.preventDefault();
            e.stopImmediatePropagation();
            var form = removeBtn.closest('form');
            var cartItem = removeBtn.closest('.raven-cart-item, .js-cart-item, [data-line-item-id]');
            if (form && cartItem) {
                deleteCartItemInstant(form, cartItem);
            } else if (form) {
                submitCartFormAjax(form);
            }
            return;
        }
    }, true);

    // Expose to global scope
    window.ravenOpenCart = openOffcanvasCart;
    window.ravenCloseCart = closeOffcanvasCart;
    window.ravenRefreshCart = refreshOffcanvasCart;
    window.ravenUpdateBadge = updateCartBadge;

    // Update cart badge on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateCartBadge);
    } else {
        updateCartBadge();
    }

    // Strip manufacturer name from product titles
    function stripManufacturerFromTitles() {
        var manufacturers = ['Lockhart Tactical'];
        document.querySelectorAll('h1, .product-detail-name, .product-name').forEach(function(el) {
            var text = el.textContent || '';
            manufacturers.forEach(function(mfr) {
                if (text.indexOf(mfr) === 0) {
                    el.textContent = text.substring(mfr.length).trim();
                }
            });
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', stripManufacturerFromTitles);
    } else {
        stripManufacturerFromTitles();
    }

    // Add body class for Waffenzubehör page to hide manufacturer names only there
    (function() {
        var path = window.location.pathname.toLowerCase();
        if (path.indexOf('/waffenzubehoer') === 0) {
            document.body.classList.add('page-waffenzubehoer');
        }
    })();

    // Check login state and update dropdown menus
    function checkLoginState() {
        fetch('/account', {
            method: 'GET',
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) {
            // If we get redirected to login page, user is not logged in
            if (response.url.indexOf('/account/login') !== -1 || response.url.indexOf('/account/register') !== -1) {
                updateAccountMenus(false, null);
            } else {
                return response.text();
            }
        })
        .then(function(html) {
            if (!html) return;
            // Try to extract customer name from the account page HTML
            var nameMatch = html.match(/Willkommen[^<]*<\/p>\s*<h3[^>]*>([^<]+)</i);
            if (nameMatch) {
                updateAccountMenus(true, nameMatch[1].trim());
            } else {
                // Alternative: look for user-name class
                var altMatch = html.match(/class="user-name"[^>]*>([^<]+)</);
                if (altMatch) {
                    updateAccountMenus(true, altMatch[1].trim());
                } else {
                    // Check if we're on account page (not redirected to login)
                    if (html.indexOf('Übersicht') !== -1 || html.indexOf('Mein Profil') !== -1) {
                        updateAccountMenus(true, 'Kunde');
                    } else {
                        updateAccountMenus(false, null);
                    }
                }
            }
        })
        .catch(function() {
            // On error, assume not logged in
            updateAccountMenus(false, null);
        });
    }

    function updateAccountMenus(isLoggedIn, customerName) {
        document.querySelectorAll('.raven-account-menu').forEach(function(menu) {
            var loggedInMenu = menu.querySelector('.raven-logged-in-menu');
            var guestMenu = menu.querySelector('.raven-guest-menu');
            var nameEl = menu.querySelector('.raven-customer-name');

            if (isLoggedIn) {
                if (loggedInMenu) loggedInMenu.style.display = 'block';
                if (guestMenu) guestMenu.style.display = 'none';
                if (nameEl && customerName) nameEl.textContent = customerName;
            } else {
                if (loggedInMenu) loggedInMenu.style.display = 'none';
                if (guestMenu) guestMenu.style.display = 'block';
            }
        });
    }

    // Account dropdown toggle
    function initAccountDropdown() {
        document.querySelectorAll('.raven-account-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var dropdown = btn.closest('.raven-account-dropdown');
                var menu = dropdown ? dropdown.querySelector('.raven-account-menu') : null;
                if (menu) {
                    // Close other open dropdowns
                    document.querySelectorAll('.raven-account-menu.show').forEach(function(m) {
                        if (m !== menu) m.classList.remove('show');
                    });
                    // Toggle this dropdown
                    menu.classList.toggle('show');
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.raven-account-dropdown')) {
                document.querySelectorAll('.raven-account-menu.show').forEach(function(m) {
                    m.classList.remove('show');
                });
            }
        });

        // Check login state on page load
        checkLoginState();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAccountDropdown);
    } else {
        initAccountDropdown();
    }

    // Category-specific search functionality
    // When on a category page, filter products client-side within that category
    function initCategorySearch() {
        var categoryPaths = {
            '/Waffenzubehoer/': 'Waffenzubehör',
            '/Raven-Weapons/': 'Waffen',
            '/Raven-Caliber-Kit/': 'Kalibers'
        };

        // Get current category from URL path
        function getCurrentCategory() {
            var path = window.location.pathname;
            for (var catPath in categoryPaths) {
                if (path.toLowerCase().indexOf(catPath.toLowerCase()) === 0) {
                    return { path: catPath, name: categoryPaths[catPath] };
                }
            }
            return null;
        }

        // Update search placeholders based on current category
        function updateSearchPlaceholders() {
            var category = getCurrentCategory();
            var placeholder = category
                ? 'Suche in ' + category.name + '...'
                : 'Produkte suchen...';

            document.querySelectorAll('.raven-search-input').forEach(function(input) {
                input.setAttribute('placeholder', placeholder);
            });
        }

        // Filter products on category page
        function filterProductsOnPage(searchTerm) {
            var searchLower = searchTerm.toLowerCase();
            // Target the actual product boxes with raven-card or product-box class
            var productItems = document.querySelectorAll('.product-box, .raven-card, .cms-listing-col');
            var visibleCount = 0;
            var totalCount = productItems.length;

            productItems.forEach(function(item) {
                // Get product name from raven-product-name class or link title attribute
                var productNameEl = item.querySelector('.raven-product-name');
                var productText = '';

                if (productNameEl) {
                    productText = productNameEl.textContent.trim();
                } else {
                    // Fallback: try to get from link with title attribute (image link)
                    var imageLink = item.querySelector('a[title]');
                    if (imageLink) {
                        productText = imageLink.getAttribute('title') || '';
                    }
                }

                // Also get product number if available
                var productNumber = item.querySelector('[data-product-number]');
                var numberText = productNumber ? productNumber.getAttribute('data-product-number') : '';

                // Also check URL slug in href
                var productLink = item.querySelector('a[href]');
                var hrefText = productLink ? productLink.getAttribute('href') : '';

                var combinedText = (productText + ' ' + numberText + ' ' + hrefText).toLowerCase();

                if (combinedText.indexOf(searchLower) !== -1) {
                    item.style.display = '';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Show/update filter indicator
            showFilterIndicator(searchTerm, visibleCount, totalCount);

            return visibleCount;
        }

        // Show filter indicator banner
        function showFilterIndicator(searchTerm, visibleCount, totalCount) {
            var existingIndicator = document.getElementById('raven-search-filter-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            var category = getCurrentCategory();
            var indicator = document.createElement('div');
            indicator.id = 'raven-search-filter-indicator';
            indicator.style.cssText = 'background: linear-gradient(to right, #fef3c7, #fde68a); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid #f59e0b;';

            var messageHtml = '';
            var buttonsHtml = '';

            if (visibleCount === 0) {
                // No results on this page - offer global search
                messageHtml = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; color: #d97706;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                    '<span style="color: #92400e; font-size: 14px;">Keine Treffer für "<strong>' + searchTerm + '</strong>" auf dieser Seite gefunden.</span>' +
                    '</div>';
                buttonsHtml = '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
                    '<a href="/search?search=' + encodeURIComponent(searchTerm) + '" id="raven-global-search" style="background: #d97706; border: none; color: #fff; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: none; transition: all 0.2s;">Im gesamten Shop suchen</a>' +
                    '<button id="raven-clear-filter" style="background: #fff; border: 1px solid #d97706; color: #d97706; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Abbrechen</button>' +
                    '</div>';
            } else {
                // Results found
                messageHtml = '<div style="display: flex; align-items: center; gap: 8px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; color: #d97706;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
                    '<span style="color: #92400e; font-size: 14px;">Suche in <strong>' + category.name + '</strong>: "<strong>' + searchTerm + '</strong>" - ' + visibleCount + ' von ' + totalCount + ' Produkten</span>' +
                    '</div>';
                buttonsHtml = '<button id="raven-clear-filter" style="background: #fff; border: 1px solid #d97706; color: #d97706; padding: 6px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Filter aufheben</button>';
            }

            indicator.innerHTML = messageHtml + buttonsHtml;

            var mainContent = document.querySelector('main, .content-main, #content-main');
            if (mainContent) {
                mainContent.insertBefore(indicator, mainContent.firstChild);
            } else {
                document.body.insertBefore(indicator, document.body.firstChild);
            }

            // Clear filter button handler
            document.getElementById('raven-clear-filter').addEventListener('click', function() {
                clearFilter();
            });
        }

        // Clear filter and show all products
        function clearFilter() {
            var productItems = document.querySelectorAll('.product-box, .raven-card, .cms-listing-col');
            productItems.forEach(function(item) {
                item.style.display = '';
            });

            var indicator = document.getElementById('raven-search-filter-indicator');
            if (indicator) {
                indicator.remove();
            }

            // Clear search input
            document.querySelectorAll('.raven-search-input').forEach(function(input) {
                input.value = '';
            });

            // Remove search param from URL
            var url = new URL(window.location.href);
            url.searchParams.delete('search');
            window.history.replaceState({}, '', url.pathname);
        }

        // Handle search form submission
        function handleSearchSubmit(e) {
            var form = e.target;
            if (!form.classList.contains('raven-search-form') && !form.closest('.raven-header')) {
                return;
            }

            var searchInput = form.querySelector('input[name="search"]');
            var searchTerm = searchInput ? searchInput.value.trim() : '';

            if (!searchTerm) {
                e.preventDefault();
                return;
            }

            var category = getCurrentCategory();

            if (category) {
                // On a category page - filter products client-side
                e.preventDefault();

                // Update URL without reload
                var url = new URL(window.location.href);
                url.searchParams.set('search', searchTerm);
                window.history.pushState({}, '', url.toString());

                // Filter products
                filterProductsOnPage(searchTerm);
            }
            // If not on a category page, let the form submit normally to global search
        }

        // Check URL for existing search param on page load
        function checkUrlForSearch() {
            var category = getCurrentCategory();
            if (category) {
                var urlParams = new URLSearchParams(window.location.search);
                var searchTerm = urlParams.get('search');
                if (searchTerm) {
                    // Set the search input value
                    document.querySelectorAll('.raven-search-input').forEach(function(input) {
                        input.value = searchTerm;
                    });
                    // Filter products
                    filterProductsOnPage(searchTerm);
                }
            }
        }

        // Attach event listeners to search forms
        document.querySelectorAll('.raven-search-form, .raven-header form[action*="search"]').forEach(function(form) {
            form.addEventListener('submit', handleSearchSubmit);
        });

        // Also handle forms dynamically with event delegation
        document.addEventListener('submit', function(e) {
            var form = e.target;
            if (form.classList.contains('raven-search-form') ||
                (form.closest('.raven-header') && form.querySelector('input[name="search"]'))) {
                handleSearchSubmit(e);
            }
        }, false);

        // Update placeholders on load
        updateSearchPlaceholders();

        // Check for search param in URL
        checkUrlForSearch();

        console.log('Category-specific search initialized');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCategorySearch);
    } else {
        initCategorySearch();
    }

    // Live Search Autocomplete
    function initLiveSearch() {
        var searchInputs = document.querySelectorAll('.raven-search-input');
        var searchTimeout = null;
        var minChars = 2;

        searchInputs.forEach(function(input) {
            var form = input.closest('form');
            var wrapper = form.parentElement;

            // Create dropdown container
            var dropdown = document.createElement('div');
            dropdown.className = 'raven-search-dropdown';
            wrapper.appendChild(dropdown);

            // Handle input typing
            input.addEventListener('input', function() {
                var query = input.value.trim();

                clearTimeout(searchTimeout);

                if (query.length < minChars) {
                    dropdown.classList.remove('show');
                    return;
                }

                // Show loading state
                dropdown.innerHTML = '<div class="raven-search-loading">Suche...</div>';
                dropdown.classList.add('show');

                // Debounce search
                searchTimeout = setTimeout(function() {
                    performSearch(query, dropdown, input);
                }, 300);
            });

            // Hide dropdown on blur (with delay for click)
            input.addEventListener('blur', function() {
                setTimeout(function() {
                    dropdown.classList.remove('show');
                }, 200);
            });

            // Show dropdown on focus if has content
            input.addEventListener('focus', function() {
                if (dropdown.innerHTML && input.value.trim().length >= minChars) {
                    dropdown.classList.add('show');
                }
            });
        });

        function performSearch(query, dropdown, input) {
            // Use Shopware's suggest endpoint - parse HTML for product data including prices
            fetch('/suggest?search=' + encodeURIComponent(query), {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(function(response) { return response.text(); })
            .then(function(html) {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');

                // Find all product items from Shopware's suggest structure
                var products = doc.querySelectorAll('li.search-suggest-product');
                var resultsHtml = '';
                var foundProducts = [];

                products.forEach(function(product) {
                    if (foundProducts.length >= 8) return;

                    // Get link element
                    var link = product.querySelector('a.search-suggest-product-link');
                    if (!link) return;

                    var href = link.getAttribute('href') || '#';
                    if (href === '#' || href === '') return;

                    // Get product name
                    var name = '';
                    var nameEl = product.querySelector('.search-suggest-product-name');
                    if (nameEl) {
                        name = nameEl.textContent.trim();
                    } else {
                        name = link.getAttribute('title') || '';
                    }
                    if (!name) return;

                    // Get price - look for the span inside price div
                    var price = '';
                    var priceEl = product.querySelector('.search-suggest-product-price span, .search-suggest-product-price');
                    if (priceEl) {
                        var priceText = priceEl.textContent.trim();
                        // Parse price like "CHF 2,985.00" and format as "CHF 2'985.00"
                        var priceMatch = priceText.match(/CHF\s*([\d,.']+)/i);
                        if (priceMatch) {
                            // Remove thousands separator and parse
                            var priceNum = parseFloat(priceMatch[1].replace(/[,']/g, ''));
                            if (!isNaN(priceNum)) {
                                // Format with 2 decimal places in Swiss format
                                var formattedPrice = priceNum.toFixed(2);
                                var parts = formattedPrice.split('.');
                                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, "'");
                                price = 'CHF ' + parts.join('.');
                            }
                        }
                    }

                    // Get image
                    var img = '';
                    var imgEl = product.querySelector('img.search-suggest-product-image');
                    if (imgEl) {
                        img = imgEl.getAttribute('src') || '';
                    }

                    foundProducts.push({ href: href, name: name, price: price, img: img });
                });

                if (foundProducts.length > 0) {
                    resultsHtml += '<div class="raven-search-section">';
                    resultsHtml += '<div class="raven-search-section-title">Produkte</div>';

                    foundProducts.forEach(function(product) {
                        resultsHtml += '<a href="' + escapeHtml(product.href) + '" class="raven-search-item">';
                        if (product.img) {
                            resultsHtml += '<img src="' + escapeHtml(product.img) + '" class="raven-search-item-image" alt="">';
                        } else {
                            resultsHtml += '<div class="raven-search-item-image" style="display:flex;align-items:center;justify-content:center;color:#d1d5db;background:#f3f4f6;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:20px;height:20px;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>';
                        }
                        resultsHtml += '<div class="raven-search-item-info">';
                        resultsHtml += '<div class="raven-search-item-name">' + escapeHtml(product.name) + '</div>';
                        resultsHtml += '</div>';
                        if (product.price) {
                            resultsHtml += '<div class="raven-search-item-price">' + escapeHtml(product.price) + '</div>';
                        }
                        resultsHtml += '</a>';
                    });

                    resultsHtml += '</div>';
                    resultsHtml += '<a href="/search?search=' + encodeURIComponent(query) + '" class="raven-search-view-all">Alle Ergebnisse anzeigen</a>';
                } else {
                    resultsHtml = '<div class="raven-search-no-results">';
                    resultsHtml += 'Keine Produkte gefunden f\u00fcr "<strong>' + escapeHtml(query) + '</strong>"';
                    resultsHtml += '</div>';
                    resultsHtml += '<a href="/search?search=' + encodeURIComponent(query) + '" class="raven-search-view-all">Im gesamten Shop suchen</a>';
                }

                dropdown.innerHTML = resultsHtml;
            })
            .catch(function(error) {
                console.error('Search error:', error);
                dropdown.innerHTML = '<div class="raven-search-no-results">Suche fehlgeschlagen</div>';
            });
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        console.log('Live search autocomplete initialized');
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLiveSearch);
    } else {
        initLiveSearch();
    }

    // ============================================================
    // SNIGEL COLOR SWATCH - Save selected color to localStorage
    // This works for ALL Snigel products dynamically
    // ============================================================
    function initSnigelColorSave() {
        // Only run on product detail pages
        var colorSwatches = document.querySelectorAll('.color-tag');
        if (colorSwatches.length === 0) return;

        // Get product ID from the add-to-cart form
        function getProductId() {
            var form = document.querySelector('form[data-add-to-cart]');
            if (form) {
                var idInput = form.querySelector('input[name*="[id]"]');
                if (idInput) return idInput.value;
            }
            return null;
        }

        var productId = getProductId();
        if (!productId) {
            console.log('Snigel Color Save: No product ID found');
            return;
        }

        console.log('Snigel Color Save: Initializing for product', productId);

        // Attach click handlers to all color swatches
        colorSwatches.forEach(function(swatch) {
            swatch.addEventListener('click', function() {
                var colorName = this.getAttribute('data-color-name');
                var imageUrl = this.getAttribute('data-image-url') || '';

                if (colorName) {
                    var colorData = {
                        color: colorName,
                        image: imageUrl
                    };
                    localStorage.setItem('raven_color_' + productId, JSON.stringify(colorData));
                    console.log('Snigel Color Save: Saved', colorName, 'for product', productId);
                }
            });
        });

        // Also save the initial/default color on page load
        var activeColor = document.querySelector('.color-tag.active, .color-tag.selected');
        if (activeColor) {
            var colorName = activeColor.getAttribute('data-color-name');
            var imageUrl = activeColor.getAttribute('data-image-url') || '';
            if (colorName) {
                localStorage.setItem('raven_color_' + productId, JSON.stringify({
                    color: colorName,
                    image: imageUrl
                }));
                console.log('Snigel Color Save: Saved initial color', colorName);
            }
        } else if (colorSwatches.length > 0) {
            // Save the first color as default if no active one
            var firstSwatch = colorSwatches[0];
            var colorName = firstSwatch.getAttribute('data-color-name');
            var imageUrl = firstSwatch.getAttribute('data-image-url') || '';
            if (colorName) {
                localStorage.setItem('raven_color_' + productId, JSON.stringify({
                    color: colorName,
                    image: imageUrl
                }));
                console.log('Snigel Color Save: Saved first color as default', colorName);
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSnigelColorSave);
    } else {
        initSnigelColorSave();
    }
})();

// ============================================
// THORON-STYLE DROPDOWN HOVER BEHAVIOR
// ============================================
(function() {
    function initDropdownHover() {
        // Get all dropdown items in left column
        var dropdownItems = document.querySelectorAll('.raven-dropdown-item');

        dropdownItems.forEach(function(item) {
            item.addEventListener('mouseenter', function() {
                // Get the parent dropdown
                var dropdown = this.closest('.raven-mega-menu');
                if (!dropdown) return;

                // Get target submenu ID
                var targetId = this.getAttribute('data-submenu-target');
                if (!targetId) return;

                // Remove active class from all items in this dropdown
                dropdown.querySelectorAll('.raven-dropdown-item').forEach(function(el) {
                    el.classList.remove('active');
                });

                // Add active class to hovered item
                this.classList.add('active');

                // Hide all submenus in this dropdown
                dropdown.querySelectorAll('.raven-submenu').forEach(function(submenu) {
                    submenu.classList.remove('active');
                });

                // Show the target submenu
                var targetSubmenu = dropdown.querySelector('[data-submenu-id="' + targetId + '"]');
                if (targetSubmenu) {
                    targetSubmenu.classList.add('active');
                }
            });
        });

        // Position dropdown below header on hover
        var navItems = document.querySelectorAll('.raven-nav-item');
        navItems.forEach(function(navItem) {
            var megaMenu = navItem.querySelector('.raven-mega-menu');
            if (megaMenu) {
                navItem.addEventListener('mouseenter', function() {
                    // Get header height to position dropdown
                    var header = document.querySelector('.raven-header');
                    if (header) {
                        var headerRect = header.getBoundingClientRect();
                        megaMenu.style.top = headerRect.bottom + 'px';
                    }
                });
            }
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDropdownHover);
    } else {
        initDropdownHover();
    }

})();
</script>

<header class="raven-header" style="width: 100%; position: fixed; top: 0; left: 0; right: 0; z-index: 100; background: #fff;">
    {# Mobile Header #}
    <div class="raven-header-mobile md:hidden bg-white relative z-50" style="width: 100%;">
        <div style="width: 100%; padding: 12px 24px;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <a href="{{ path('frontend.home.page') }}" class="raven-logo inline-flex items-center" aria-label="Raven Weapon home">
                        <div style="background-image:url('{{ asset('bundles/raventheme/assets/logo.svg') }}');background-size:100% 455%;background-position:left;background-repeat:no-repeat;height:36px;width:160px;"></div>
                    </a>
                </div>
                <div class="flex items-center gap-3">
                    {# Account Icon Mobile - With Dropdown #}
                    <div class="raven-account-dropdown" style="position: relative;">
                        <button type="button"
                                class="raven-icon-btn raven-account-btn relative inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                                aria-label="Mein Konto">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                            </svg>
                        </button>
                        {# Mobile Dropdown Menu - Server-side rendered #}
                        <div class="raven-account-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; overflow: hidden; z-index: 1000;">
                            {% if context.customer %}
                                {# Logged In Menu #}
                                <div style="padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <p style="font-size: 12px; color: #6b7280; margin: 0;">Angemeldet als</p>
                                    <p style="font-size: 14px; font-weight: 600; color: #111827; margin: 4px 0 0 0;">{{ context.customer.firstName }} {{ context.customer.lastName }}</p>
                                </div>
                                <a href="{{ path('frontend.account.home.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><circle cx="12" cy="8" r="4"/><path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/></svg>
                                    Mein Konto
                                </a>
                                <a href="{{ path('frontend.account.order.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/></svg>
                                    Bestellungen
                                </a>
                                <div style="border-top: 1px solid #f3f4f6;">
                                    <a href="{{ path('frontend.account.logout.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #dc2626; font-size: 14px; text-decoration: none;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                        Abmelden
                                    </a>
                                </div>
                            {% else %}
                                {# Not Logged In Menu #}
                                <a href="{{ path('frontend.account.login.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                                    Anmelden
                                </a>
                                <a href="{{ path('frontend.account.register.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 18px; height: 18px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                    Registrieren
                                </a>
                            {% endif %}
                        </div>
                    </div>
                    {# Cart Button Mobile - Opens Off-Canvas Cart Sidebar #}
                    <div class="header-cart-wrapper" style="position: relative; display: inline-flex;">
                        <button type="button"
                                class="raven-icon-btn header-cart-btn"
                                data-off-canvas-cart="true"
                                data-url="{{ path('frontend.cart.offcanvas') }}"
                                aria-label="Warenkorb"
                                style="display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 10px; border: 1px solid #e5e7eb; background: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                        </button>
                        {% if page.cart.lineItems.count > 0 %}
                            <span class="raven-cart-badge" style="position: absolute; top: -6px; right: -6px; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 5px; background: linear-gradient(135deg, #facc15, #f59e0b); color: #000; font-size: 11px; font-weight: 700; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">{{ page.cart.lineItems.count }}</span>
                        {% endif %}
                    </div>
                    {# Mobile Menu Toggle #}
                    <button type="button"
                            class="raven-icon-btn md:hidden inline-flex items-center justify-center h-10 w-10 rounded-lg border border-gray-200 text-gray-500 bg-white"
                            data-offcanvas-menu-toggle="true"
                            aria-label="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <line x1="3" y1="6" x2="21" y2="6"/>
                            <line x1="3" y1="12" x2="21" y2="12"/>
                            <line x1="3" y1="18" x2="21" y2="18"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Desktop Header #}
    <div class="raven-header-desktop hidden md:block bg-white" style="width: 100%; border-bottom: 1px solid #e5e7eb;">
        <div style="width: 100%; max-width: 1200px; margin: 0 auto; padding-left: 24px; padding-right: 24px; padding-top: 12px;">
            {# Top Row: Logo, Search (centered), Account, Cart - Compact layout #}
            <div style="display: flex; align-items: center; justify-content: center; height: 40px; gap: 32px;">
                {# Left: Logo #}
                <div style="flex-shrink: 0;">
                    <a href="{{ path('frontend.home.page') }}" class="raven-logo inline-flex items-center" aria-label="Raven Weapon home">
                        <div style="background-image:url('{{ asset('bundles/raventheme/assets/logo.svg') }}');background-size:100% 455%;background-position:left;background-repeat:no-repeat;height:32px;width:140px;"></div>
                    </a>
                </div>

                {# Center: Search Bar - Smaller and elegant #}
                <div style="position: relative; flex: 0 1 400px;">
                    {% block layout_header_search %}
                        <form action="{{ path('frontend.search.page') }}" method="get" class="raven-search-form" style="position: relative;">
                            <input type="search"
                                   name="search"
                                   placeholder="Produkte suchen..."
                                   class="raven-search-input"
                                   style="width: 100%; height: 26px; border-radius: 9999px; background: #f3f4f6; padding-left: 28px; padding-right: 10px; font-size: 11px; color: #1f2937; border: 1px solid transparent; outline: none;"
                                   aria-label="Suche">
                            <button type="submit" style="position: absolute; left: 9px; top: 50%; transform: translateY(-50%); color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0;" aria-label="Suchen">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 12px; height: 12px; display: block;">
                                    <circle cx="11" cy="11" r="8"/>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                                </svg>
                            </button>
                        </form>
                    {% endblock %}
                </div>

                {# Right: Account & Cart #}
                <div style="flex-shrink: 0; display: flex; align-items: center; gap: 6px;">
                    {# Account - With Dropdown Menu #}
                    <div class="raven-account-dropdown" style="position: relative;">
                        <button type="button"
                                class="raven-icon-btn raven-account-btn"
                                aria-label="Mein Konto"
                                title="Mein Konto"
                                style="display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 10px; border: 1px solid #e5e7eb; background: white; color: #6b7280;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                            </svg>
                        </button>
                        {# Dropdown Menu - Server-side rendered based on login state #}
                        <div class="raven-account-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 180px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; overflow: hidden; z-index: 1000;">
                            {% if context.customer %}
                                {# Logged In Menu #}
                                <div style="padding: 12px 16px; border-bottom: 1px solid #f3f4f6;">
                                    <p style="font-size: 12px; color: #6b7280; margin: 0;">Angemeldet als</p>
                                    <p style="font-size: 14px; font-weight: 600; color: #111827; margin: 4px 0 0 0;">{{ context.customer.firstName }} {{ context.customer.lastName }}</p>
                                </div>
                                <a href="{{ path('frontend.account.home.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <circle cx="12" cy="8" r="4"/>
                                        <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"/>
                                    </svg>
                                    Mein Konto
                                </a>
                                <a href="{{ path('frontend.account.order.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/>
                                        <line x1="3" y1="6" x2="21" y2="6"/>
                                    </svg>
                                    Bestellungen
                                </a>
                                <div style="border-top: 1px solid #f3f4f6;">
                                    <a href="{{ path('frontend.account.logout.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #dc2626; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                            <polyline points="16 17 21 12 16 7"/>
                                            <line x1="21" y1="12" x2="9" y2="12"/>
                                        </svg>
                                        Abmelden
                                    </a>
                                </div>
                            {% else %}
                                {# Not Logged In Menu #}
                                <a href="{{ path('frontend.account.login.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                        <polyline points="10 17 15 12 10 7"/>
                                        <line x1="15" y1="12" x2="3" y2="12"/>
                                    </svg>
                                    Anmelden
                                </a>
                                <a href="{{ path('frontend.account.register.page') }}" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; color: #374151; font-size: 14px; text-decoration: none; transition: background 0.15s;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 18px; height: 18px;">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="8.5" cy="7" r="4"/>
                                        <line x1="20" y1="8" x2="20" y2="14"/>
                                        <line x1="23" y1="11" x2="17" y2="11"/>
                                    </svg>
                                    Registrieren
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    {# Cart Button Desktop - Opens Off-Canvas Cart Sidebar #}
                    <div class="header-cart-wrapper" style="position: relative; display: inline-flex;">
                        <button type="button"
                                class="raven-icon-btn header-cart-btn"
                                data-off-canvas-cart="true"
                                data-url="{{ path('frontend.cart.offcanvas') }}"
                                aria-label="Warenkorb"
                                title="Warenkorb"
                                style="display: inline-flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 10px; border: 1px solid #e5e7eb; background: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
                        </button>
                        {% set cartCount = page.cart.lineItems.count|default(0) %}
                        {% if cartCount > 0 %}
                            <span class="raven-cart-badge" style="position: absolute; top: -6px; right: -6px; display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 5px; background: linear-gradient(135deg, #facc15, #f59e0b); color: #000; font-size: 11px; font-weight: 700; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">{{ cartCount }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Navigation Rows - Dynamic Categories from Shopware - 2 ROW LAYOUT #}
            {# SEO URL mapping for main categories - all lowercase for consistency #}
            {% set mainCategorySeoUrls = {
                '019aee0f487c79a1a8814377c46e0c10': '/alle-produkte/',
                'a61f19c9cb4b11f0b4074aca3d279c31': '/waffen/',
                'a61f1ec3cb4b11f0b4074aca3d279c31': '/raven-caliber-kit/',
                '019adeff65f97225927586968691dc02': '/zielhilfen-optik-zubehoer/',
                '2f40311624aea6de289c770f0bfd0ff9': '/munition/',
                '604131c6ae1646c98623da4fe61a739b': '/zubehoer/',
                '019b0857613474e6a799cfa07d143c76': '/ausruestung/',
                'e0da99a4d0062c3a6b619ccc6fb57df4': '/dienstleistungen/'
            } %}
            {# All categories in single row #}
            {% set row1Categories = ['Alle Produkte', 'Waffen', 'Munition', 'Zubehör', 'Ausrüstung', 'Raven Caliber Kit', 'Zielhilfen, Optik & Zubehör', 'Dienstleistungen'] %}
            {% set row2Categories = [] %}
            {# Get current path for active state #}
            {% set currentPath = app.request.pathInfo %}
            <div class="pb-3" style="margin-top: 16px;">
                <nav id="raven-main-nav" class="raven-nav-wrapper" aria-label="Hauptnavigation">
                    {% if header.navigation.tree is defined and header.navigation.tree|length > 0 %}
                        {# ROW 1: Main Categories #}
                        <div class="raven-nav-row raven-nav-row-1">
                            {% for treeItem in header.navigation.tree %}
                                {% set category = treeItem.category %}
                                {% if category.translated.name in row1Categories %}
                                    {% set hasChildren = treeItem.children|length > 0 %}
                                    {% set categoryUrl = mainCategorySeoUrls[category.id] ?? seoUrl('frontend.navigation.page', { navigationId: category.id }) %}
                                    {% set isActive = currentPath starts with categoryUrl or (categoryUrl != '/' and currentPath == categoryUrl) %}
                                    {% set isRightAlignedCategory = category.translated.name in ['Ausrüstung', 'Zubehör', 'Dienstleistungen'] %}
                                    {% set isLeftAlignedCategory = category.translated.name in ['Waffen', 'Alle Produkte'] %}
                                    {% set displayName = category.translated.name %}
                                    {% if displayName == 'Zielhilfen, Optik & Zubehör' %}
                                        {% set displayName = 'Optik & Zubehör' %}
                                    {% endif %}
                                    <div class="raven-nav-item{% if isRightAlignedCategory %} dropdown-align-right{% elseif isLeftAlignedCategory %} dropdown-align-left{% endif %}">
                                        <a href="{{ categoryUrl }}"
                                           class="raven-nav-link inline-flex items-center gap-1.5 font-medium text-gray-600 hover:text-gray-900 py-2{% if isActive %} is-active{% endif %}" style="font-size: 16px;"
                                           {% if isActive %}aria-current="page"{% endif %}>
                                            {{ displayName }}
                                            {% if hasChildren %}
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; opacity: 0.5;">
                                                <polyline points="6 9 12 15 18 9"/>
                                            </svg>
                                            {% endif %}
                                        </a>
                                        {% if hasChildren %}
                                        {% include '@RavenTheme/storefront/layout/header/nav-dropdown.html.twig' with {treeItem: treeItem, category: category} %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {# ROW 2: Specialty Items #}
                        <div class="raven-nav-row raven-nav-row-2">
                            {% for treeItem in header.navigation.tree %}
                                {% set category = treeItem.category %}
                                {% if category.translated.name in row2Categories %}
                                    {% set hasChildren = treeItem.children|length > 0 %}
                                    {% set categoryUrl = mainCategorySeoUrls[category.id] ?? seoUrl('frontend.navigation.page', { navigationId: category.id }) %}
                                    {% set isActive = currentPath starts with categoryUrl or (categoryUrl != '/' and currentPath == categoryUrl) %}
                                    <div class="raven-nav-item">
                                        <a href="{{ categoryUrl }}"
                                           class="raven-nav-link inline-flex items-center gap-1.5 font-medium text-gray-600 hover:text-gray-900 py-2{% if isActive %} is-active{% endif %}" style="font-size: 16px;"
                                           {% if isActive %}aria-current="page"{% endif %}>
                                            {{ category.translated.name }}
                                            {% if hasChildren %}
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; opacity: 0.5;">
                                                <polyline points="6 9 12 15 18 9"/>
                                            </svg>
                                            {% endif %}
                                        </a>
                                        {% if hasChildren %}
                                        {% include '@RavenTheme/storefront/layout/header/nav-dropdown.html.twig' with {treeItem: treeItem, category: category} %}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% else %}
                        {# Fallback: Dynamic Navigation - loads from database via navCategories #}
                        {% set categories = page.extensions.navCategories|default(page.header.extensions.navCategories|default([])) %}
                        <div class="raven-nav-row raven-nav-row-1">
                            {% for mainCat in categories %}
                                {% if mainCat.translated.name in row1Categories %}
                                    {% set hasChildren = mainCat.children is defined and mainCat.children|length > 0 %}
                                    {% set categoryUrl = mainCategorySeoUrls[mainCat.id] ?? seoUrl('frontend.navigation.page', { navigationId: mainCat.id }) %}
                                    {% set isActive = currentPath starts with categoryUrl %}
                                    {% set displayName = mainCat.translated.name %}
                                    {% if displayName == 'Zielhilfen, Optik & Zubehör' %}
                                        {% set displayName = 'Optik & Zubehör' %}
                                    {% endif %}
                                    <div class="raven-nav-item">
                                        <a href="{{ categoryUrl }}"
                                           class="raven-nav-link inline-flex items-center gap-1.5 font-medium text-gray-600 hover:text-gray-900 py-2{% if isActive %} is-active{% endif %}" style="font-size: 16px;">
                                            {{ displayName }}
                                            {% if hasChildren %}
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; opacity: 0.5;"><polyline points="6 9 12 15 18 9"/></svg>
                                            {% endif %}
                                        </a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <div class="raven-nav-row raven-nav-row-2">
                            {% for mainCat in categories %}
                                {% if mainCat.translated.name in row2Categories %}
                                    {% set hasChildren = mainCat.children is defined and mainCat.children|length > 0 %}
                                    {% set categoryUrl = mainCategorySeoUrls[mainCat.id] ?? seoUrl('frontend.navigation.page', { navigationId: mainCat.id }) %}
                                    {% set isActive = currentPath starts with categoryUrl %}
                                    <div class="raven-nav-item">
                                        <a href="{{ categoryUrl }}"
                                           class="raven-nav-link inline-flex items-center gap-1.5 font-medium text-gray-600 hover:text-gray-900 py-2{% if isActive %} is-active{% endif %}" style="font-size: 16px;">
                                            {{ mainCat.translated.name }}
                                            {% if hasChildren %}
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; opacity: 0.5;"><polyline points="6 9 12 15 18 9"/></svg>
                                            {% endif %}
                                        </a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>

    {# Mobile Search Bar - Improved #}
    <div class="md:hidden" style="background: white; border-bottom: 1px solid #f3f4f6; padding: 12px 24px;">
        <div style="position: relative;">
            <form action="{{ path('frontend.search.page') }}" method="get" class="raven-search-form" style="position: relative;">
                <input type="search"
                       name="search"
                       placeholder="Produkte suchen..."
                       class="raven-search-input"
                       style="width: 100%; height: 40px; border-radius: 9999px; background: #f3f4f6; padding-left: 44px; padding-right: 16px; font-size: 15px; color: #1f2937; border: 1px solid transparent; outline: none;"
                       aria-label="Suche">
                <button type="submit" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0;" aria-label="Suchen">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; display: block;">
                        <circle cx="11" cy="11" r="8"/>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</header>

{# ============================================================ #}
{# MOBILE NAVIGATION MENU - Full Screen with Accordion Submenus #}
{# ============================================================ #}
<div id="raven-mobile-menu" class="raven-mobile-menu" aria-hidden="true">
    {# Backdrop #}
    <div class="raven-mobile-menu-backdrop" data-mobile-menu-close></div>

    {# Menu Panel #}
    <div class="raven-mobile-menu-panel">
        {# Menu Header #}
        <div class="raven-mobile-menu-header">
            <span class="raven-mobile-menu-title">Menu</span>
            <button type="button" class="raven-mobile-menu-close" data-mobile-menu-close aria-label="Menu schliessen">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        {# Menu Content (Scrollable) #}
        <div class="raven-mobile-menu-content">
            {# Navigation Items #}
            <nav class="raven-mobile-menu-nav">
                {# Home Link #}
                <a href="{{ path('frontend.home.page') }}" class="raven-mobile-menu-item">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    <span>Startseite</span>
                </a>

                {# Dynamic Categories with Accordion #}
                {% if header.navigation.tree is defined and header.navigation.tree|length > 0 %}
                    {% for treeItem in header.navigation.tree %}
                        {% set category = treeItem.category %}
                        {% set hasChildren = treeItem.children|length > 0 %}
                        {% set categoryUrl = seoUrl('frontend.navigation.page', { navigationId: category.id }) %}

                        {% if hasChildren %}
                            {# Category with Accordion #}
                            <div class="raven-mobile-menu-accordion">
                                <button type="button" class="raven-mobile-menu-item raven-mobile-accordion-toggle" aria-expanded="false">
                                    <span>{{ category.translated.name }}</span>
                                    <svg class="raven-accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="6 9 12 15 18 9"></polyline>
                                    </svg>
                                </button>
                                <div class="raven-mobile-accordion-content">
                                    {# View All Link #}
                                    <a href="{{ categoryUrl }}" class="raven-mobile-submenu-item raven-mobile-submenu-viewall">
                                        <span>Alle {{ category.translated.name }}</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="9 18 15 12 9 6"></polyline>
                                        </svg>
                                    </a>
                                    {# Subcategories #}
                                    {% for childItem in treeItem.children %}
                                        {% set childCat = childItem.category %}
                                        {% set hasGrandChildren = childItem.children|length > 0 %}

                                        {% if hasGrandChildren %}
                                            {# Nested Accordion for Level 3 #}
                                            <div class="raven-mobile-menu-accordion raven-mobile-accordion-nested">
                                                <button type="button" class="raven-mobile-submenu-item raven-mobile-accordion-toggle" aria-expanded="false">
                                                    <span>{{ childCat.translated.name }}</span>
                                                    <svg class="raven-accordion-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </button>
                                                <div class="raven-mobile-accordion-content">
                                                    <a href="{{ seoUrl('frontend.navigation.page', { navigationId: childCat.id }) }}" class="raven-mobile-subsubmenu-item raven-mobile-submenu-viewall">
                                                        Alle {{ childCat.translated.name }}
                                                    </a>
                                                    {% for grandChildItem in childItem.children %}
                                                        {% set grandChildCat = grandChildItem.category %}
                                                        <a href="{{ seoUrl('frontend.navigation.page', { navigationId: grandChildCat.id }) }}" class="raven-mobile-subsubmenu-item">
                                                            {{ grandChildCat.translated.name }}
                                                        </a>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% else %}
                                            <a href="{{ seoUrl('frontend.navigation.page', { navigationId: childCat.id }) }}" class="raven-mobile-submenu-item">
                                                {{ childCat.translated.name }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            {# Simple Category Link #}
                            <a href="{{ categoryUrl }}" class="raven-mobile-menu-item">
                                <span>{{ category.translated.name }}</span>
                            </a>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </nav>

            {# Footer Section #}
            <div class="raven-mobile-menu-footer">
                {# Account Links #}
                <div class="raven-mobile-menu-footer-section">
                    <div class="raven-mobile-menu-footer-title">Konto</div>
                    {% if context.customer %}
                        <a href="{{ path('frontend.account.home.page') }}" class="raven-mobile-menu-footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="8" r="4"></circle>
                                <path d="M4 21v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1"></path>
                            </svg>
                            <span>Mein Konto</span>
                        </a>
                        <a href="{{ path('frontend.account.order.page') }}" class="raven-mobile-menu-footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                            </svg>
                            <span>Bestellungen</span>
                        </a>
                        <a href="{{ path('frontend.account.logout.page') }}" class="raven-mobile-menu-footer-link raven-mobile-menu-logout">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            <span>Abmelden</span>
                        </a>
                    {% else %}
                        <a href="{{ path('frontend.account.login.page') }}" class="raven-mobile-menu-footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                                <polyline points="10 17 15 12 10 7"></polyline>
                                <line x1="15" y1="12" x2="3" y2="12"></line>
                            </svg>
                            <span>Anmelden</span>
                        </a>
                        <a href="{{ path('frontend.account.register.page') }}" class="raven-mobile-menu-footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            <span>Registrieren</span>
                        </a>
                    {% endif %}
                </div>

                {# Contact Info #}
                <div class="raven-mobile-menu-footer-section">
                    <div class="raven-mobile-menu-footer-title">Kontakt</div>
                    <a href="tel:+41793561986" class="raven-mobile-menu-footer-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        <span>+41 79 356 19 86</span>
                    </a>
                    <a href="mailto:info@ravenweapon.ch" class="raven-mobile-menu-footer-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        <span>info@ravenweapon.ch</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{# Mobile Menu JavaScript #}
<script>
(function() {
    'use strict';

    var menu = document.getElementById('raven-mobile-menu');
    var body = document.body;
    var scrollPosition = 0;

    // Open menu
    function openMobileMenu() {
        scrollPosition = window.pageYOffset;
        menu.classList.add('is-open');
        menu.setAttribute('aria-hidden', 'false');
        body.classList.add('raven-menu-open');
        body.style.top = -scrollPosition + 'px';
    }

    // Close menu
    function closeMobileMenu() {
        menu.classList.remove('is-open');
        menu.setAttribute('aria-hidden', 'true');
        body.classList.remove('raven-menu-open');
        body.style.top = '';
        window.scrollTo(0, scrollPosition);
    }

    // Toggle accordion
    function toggleAccordion(button) {
        var accordion = button.closest('.raven-mobile-menu-accordion');
        var content = accordion.querySelector('.raven-mobile-accordion-content');
        var isExpanded = button.getAttribute('aria-expanded') === 'true';

        // Close other accordions at same level
        var parent = accordion.parentElement;
        var siblings = parent.querySelectorAll(':scope > .raven-mobile-menu-accordion');
        siblings.forEach(function(sibling) {
            if (sibling !== accordion) {
                var siblingBtn = sibling.querySelector('.raven-mobile-accordion-toggle');
                var siblingContent = sibling.querySelector('.raven-mobile-accordion-content');
                if (siblingBtn && siblingContent) {
                    siblingBtn.setAttribute('aria-expanded', 'false');
                    siblingContent.style.maxHeight = null;
                }
            }
        });

        // Toggle current accordion
        if (isExpanded) {
            button.setAttribute('aria-expanded', 'false');
            content.style.maxHeight = null;
        } else {
            button.setAttribute('aria-expanded', 'true');
            content.style.maxHeight = content.scrollHeight + 'px';

            // Update max-height when nested accordions expand
            content.querySelectorAll('.raven-mobile-accordion-content').forEach(function(nested) {
                nested.addEventListener('transitionend', function() {
                    if (button.getAttribute('aria-expanded') === 'true') {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                });
            });
        }
    }

    // Event delegation for menu toggle
    document.addEventListener('click', function(e) {
        // Open menu button
        if (e.target.closest('[data-offcanvas-menu-toggle]')) {
            e.preventDefault();
            openMobileMenu();
            return;
        }

        // Close menu button/backdrop
        if (e.target.closest('[data-mobile-menu-close]')) {
            e.preventDefault();
            closeMobileMenu();
            return;
        }

        // Accordion toggle
        var accordionToggle = e.target.closest('.raven-mobile-accordion-toggle');
        if (accordionToggle) {
            e.preventDefault();
            toggleAccordion(accordionToggle);
            return;
        }
    }, false);

    // Touch events for better mobile response
    document.addEventListener('touchstart', function(e) {
        if (e.target.closest('[data-offcanvas-menu-toggle]')) {
            e.target.closest('[data-offcanvas-menu-toggle]').classList.add('is-pressed');
        }
    }, { passive: true });

    document.addEventListener('touchend', function(e) {
        document.querySelectorAll('.is-pressed').forEach(function(el) {
            el.classList.remove('is-pressed');
        });
    }, { passive: true });

    // Close menu on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menu.classList.contains('is-open')) {
            closeMobileMenu();
        }
    });

    // Close menu when clicking a navigation link
    menu.querySelectorAll('a:not(.raven-mobile-submenu-viewall)').forEach(function(link) {
        link.addEventListener('click', function() {
            // Small delay for visual feedback
            setTimeout(closeMobileMenu, 150);
        });
    });

    // Expose globally
    window.ravenOpenMobileMenu = openMobileMenu;
    window.ravenCloseMobileMenu = closeMobileMenu;

    console.log('Raven Mobile Menu initialized');
})();
</script>

{# JS breadcrumb removed - using Shopware's Twig breadcrumb styled in navigation/index.html.twig #}
{% endblock %}
