{% sw_extends '@Storefront/storefront/element/cms-element-buy-box.html.twig' %}

{% block element_buy_box %}
<div class="cms-element-buy-box raven-product-detail">
    {% set product = element.data.product %}

    {% if product %}
    {# Get all product media sorted by position #}
    {% set allMedia = product.media|sort((a, b) => a.position <=> b.position) %}

    {# Skip the first media (main product image) and get color variant images #}
    {% set colorMediaList = [] %}
    {% set isFirstItem = true %}
    {% for mediaItem in allMedia %}
        {% if isFirstItem %}
            {% set isFirstItem = false %}
        {% elseif colorMediaList|length < 5 %}
            {% set colorMediaList = colorMediaList|merge([mediaItem]) %}
        {% endif %}
    {% endfor %}
    {% set firstColorMedia = colorMediaList|first %}

    {# Main image: use first color media or fall back to cover #}
    {% set mainImageUrl = null %}
    {% if firstColorMedia and firstColorMedia.media %}
        {% set mainImageUrl = firstColorMedia.media.url %}
    {% elseif product.cover and product.cover.media %}
        {% set mainImageUrl = product.cover.media.url %}
    {% endif %}

    {# Get manufacturer and product name #}
    {% set manufacturerName = product.manufacturer.translated.name|default('') %}
    {% set productName = product.translated.name %}
    {% set fullTitle = manufacturerName ? manufacturerName ~ ' ' ~ productName : productName %}

    {# Format price Swiss style with CHF #}
    {% set priceValue = product.calculatedPrice.unitPrice %}
    {% set priceCents = ((priceValue * 100) % 100)|round %}
    {% set formattedPrice = priceCents == 0 ? priceValue|number_format(0, '.', ',') ~ '.–' : priceValue|number_format(2, '.', ',') %}

    <div class="raven-buy-box-wrapper">
        {# LEFT: Main Product Image #}
        <div class="raven-main-image-container">
            <div class="raven-main-image">
                {% if mainImageUrl %}
                <img id="raven-main-product-image"
                     src="{{ mainImageUrl }}"
                     alt="{{ product.translated.name }}"
                     class="raven-product-img">
                {% else %}
                {# Fallback placeholder #}
                <div class="raven-no-image">Kein Bild verfügbar</div>
                {% endif %}
            </div>
        </div>

        {# RIGHT: Product Info #}
        <div class="raven-buy-box">
            {# Category Label #}
            <p class="raven-category">Waffe</p>

            {# Product Title #}
            <h1 class="raven-title">{{ fullTitle }}</h1>

            {# Price - Swiss Format with CHF prefix in RED #}
            <div class="raven-price">CHF {{ formattedPrice }}</div>

            {# Color Variants #}
            {% if colorMediaList|length > 0 %}
            <div class="raven-color-section">
                <p class="raven-color-label">
                    Farbe: <span id="selected-color-name" class="raven-color-value">Graphite Black</span>
                </p>
                <div class="raven-color-swatches">
                    {% set colorNames = ['Graphite Black', 'Flat Dark Earth', 'Northern Lights', 'Olive Drab Green', 'Sniper Grey'] %}
                    {% for media in colorMediaList %}
                    {% set colorIndex = loop.index0 %}
                    {% set colorName = colorNames[colorIndex]|default('Standard') %}
                    {% if media.media %}
                    <button class="raven-image-swatch {% if loop.first %}selected{% endif %}"
                            data-color-name="{{ colorName }}"
                            data-image-url="{{ media.media.url }}"
                            title="{{ colorName }}"
                            onclick="
                                document.getElementById('raven-main-product-image').src='{{ media.media.url }}';
                                document.getElementById('selected-color-name').textContent='{{ colorName }}';
                                document.querySelectorAll('.raven-image-swatch').forEach(el => el.classList.remove('selected'));
                                this.classList.add('selected');">
                        <img src="{{ media.media.url }}" alt="{{ colorName }}">
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Quantity and Add to Cart Form #}
            <form action="{{ path('frontend.checkout.line-item.add') }}"
                  method="post"
                  class="raven-buy-form buy-widget"
                  data-add-to-cart="true">
                <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas">
                <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}">
                <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1">
                <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1">

                {# Quantity Selector #}
                <div class="raven-quantity-row">
                    <button type="button" class="raven-qty-btn" onclick="let q = document.getElementById('raven-qty'); if(q.value > 1) q.value = parseInt(q.value) - 1;">−</button>
                    <input type="number" id="raven-qty" name="lineItems[{{ product.id }}][quantity]" value="1" min="1" max="{{ product.availableStock ?: 99 }}" class="raven-qty-input" readonly>
                    <button type="button" class="raven-qty-btn" onclick="let q = document.getElementById('raven-qty'); if(q.value < {{ product.availableStock ?: 99 }}) q.value = parseInt(q.value) + 1;">+</button>
                </div>

                {# Add to Cart Button #}
                <button type="submit" class="raven-add-to-cart-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
                        <path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/>
                    </svg>
                    In den Warenkorb
                </button>
            </form>

            {# Description Section #}
            {% if product.translated.description %}
            <div class="raven-description-section">
                <h2 class="raven-description-title">Beschreibung</h2>
                <div class="raven-description-text">
                    {{ product.translated.description|striptags }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
    /* Hide the default Shopware image gallery, product detail header, and other elements */
    .cms-element-image-gallery,
    .product-detail-tabs,
    .product-detail-description-container,
    .cms-element-product-name,
    .product-detail-name,
    .product-detail-headline {
        display: none !important;
    }

    /* Hide duplicate product name/title at top of page */
    .cms-section .cms-element-text h1,
    .product-detail-content > .cms-block:first-child {
        display: none !important;
    }

    /* No image fallback */
    .raven-no-image {
        color: #9CA3AF;
        font-size: 14px;
        text-align: center;
        padding: 4rem 2rem;
    }

    /* Make buy-box and parent containers full width */
    .cms-element-buy-box.raven-product-detail {
        grid-column: 1 / -1 !important;
        width: 100% !important;
    }

    /* Override Shopware's gallery+buybox layout to make buy-box full width */
    .cms-block-gallery-buybox {
        overflow: visible !important;
    }

    .cms-block-gallery-buybox .cms-block-container-row {
        display: block !important;
    }

    .cms-block-gallery-buybox .col-lg-7,
    .cms-block-gallery-buybox .product-detail-media {
        display: none !important;
    }

    .cms-block-gallery-buybox .col-lg-5,
    .cms-block-gallery-buybox .product-detail-buy {
        width: 100% !important;
        max-width: 100% !important;
        flex: 0 0 100% !important;
        padding: 0 !important;
    }

    /* Force parent CMS blocks to be full width */
    .cms-block-product-heading,
    .cms-section .col-12,
    .product-detail-content .cms-section,
    .product-detail-content .cms-block {
        max-width: 100% !important;
        width: 100% !important;
    }

    .product-detail-content .container,
    .cms-section-default.boxed {
        max-width: 1400px !important;
        width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }

    /* Main wrapper - two column grid */
    .raven-buy-box-wrapper {
        display: grid !important;
        grid-template-columns: minmax(400px, 1fr) minmax(350px, 1fr) !important;
        gap: 3rem !important;
        max-width: 1200px !important;
        margin: 0 auto !important;
        width: 100% !important;
    }

    /* Left: Product Image */
    .raven-main-image-container {
        min-height: 400px !important;
        min-width: 400px !important;
        width: 100% !important;
    }

    .raven-main-image {
        background: white !important;
        border-radius: 12px !important;
        padding: 2rem !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 400px !important;
        width: 100% !important;
    }

    .raven-product-img {
        width: 100% !important;
        height: auto !important;
        max-height: 450px !important;
        max-width: 100% !important;
        object-fit: contain !important;
    }

    /* Right: Product Info */
    .raven-buy-box {
        padding-top: 1rem;
    }

    /* Category label */
    .raven-category {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 0.5rem;
    }

    /* Product title */
    .raven-title {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 2rem;
        line-height: 1.2;
        color: #111827;
        margin-bottom: 1rem;
    }

    /* Price - RED with CHF */
    .raven-price {
        font-family: 'Inter', sans-serif;
        color: #E53935;
        font-weight: 600;
        font-size: 24px;
        line-height: 1.2;
        font-variant-numeric: tabular-nums;
        margin-bottom: 1.5rem;
    }

    /* Color section */
    .raven-color-section {
        margin-bottom: 1.5rem;
    }

    .raven-color-label {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.75rem;
    }

    .raven-color-value {
        font-weight: 700;
    }

    /* Color swatches - horizontal row, all 5 in one line */
    .raven-color-swatches {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 10px;
    }

    /* Individual image swatch - smaller to fit 5 in a row */
    .raven-image-swatch {
        width: 70px;
        height: 70px;
        flex-shrink: 0;
        border-radius: 8px;
        border: 2px solid #E5E7EB;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden;
        background: white;
        padding: 4px;
    }

    .raven-image-swatch img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .raven-image-swatch:hover {
        transform: scale(1.05);
        border-color: #E9D68A;
    }

    .raven-image-swatch.selected {
        border-color: #F2C200 !important;
        border-width: 3px !important;
        box-shadow: 0 0 0 2px rgba(242, 194, 0, 0.2);
    }

    /* Quantity row */
    .raven-quantity-row {
        display: flex;
        align-items: center;
        gap: 0;
        margin-bottom: 1rem;
    }

    .raven-qty-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        background: white;
        font-weight: 600;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .raven-qty-btn:first-child {
        border-radius: 6px 0 0 6px;
    }

    .raven-qty-btn:last-child {
        border-radius: 0 6px 6px 0;
    }

    .raven-qty-btn:hover {
        background: #F3F4F6;
        border-color: #9CA3AF;
    }

    .raven-qty-input {
        width: 60px;
        height: 40px;
        border: 1px solid #D1D5DB;
        border-left: none;
        border-right: none;
        text-align: center;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
    }

    /* Add to cart button */
    .raven-add-to-cart-btn {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%);
        border: 1px solid #C59A0F;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        color: #111827;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .raven-add-to-cart-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(180deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.25) 35%, rgba(255,255,255,0.00) 60%);
        pointer-events: none;
    }

    .raven-add-to-cart-btn:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .raven-add-to-cart-btn svg {
        width: 20px;
        height: 20px;
        position: relative;
        z-index: 1;
    }

    /* Description section */
    .raven-description-section {
        border-top: 1px solid #E5E7EB;
        padding-top: 1.5rem;
    }

    .raven-description-title {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1.25rem;
        color: #111827;
        margin-bottom: 0.75rem;
    }

    .raven-description-text {
        font-family: 'Inter', sans-serif;
        color: #374151;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    /* Hide default Shopware elements */
    .raven-buy-box .product-detail-price-container,
    .raven-buy-box .product-detail-tax-container,
    .raven-buy-box .product-detail-ordernumber-container,
    .cms-element-buy-box .product-detail-ordernumber-container {
        display: none !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .raven-buy-box-wrapper {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .raven-title {
            font-size: 1.5rem;
        }

        .raven-image-swatch {
            width: 60px;
            height: 60px;
        }
    }
</style>
{% endblock %}
