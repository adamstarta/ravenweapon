{% sw_extends '@Storefront/storefront/element/cms-element-buy-box.html.twig' %}

{% block element_buy_box %}
<div class="cms-element-buy-box raven-product-detail">
    {% set product = element.data.product %}

    {% if product %}
    {# Get all product media sorted by position #}
    {% set allMedia = product.media|sort((a, b) => a.position <=> b.position) %}

    {# Skip the first media (main product image) and get color variant images #}
    {% set colorMediaList = [] %}
    {% set isFirstItem = true %}
    {% for mediaItem in allMedia %}
        {% if isFirstItem %}
            {% set isFirstItem = false %}
        {% elseif colorMediaList|length < 5 %}
            {% set colorMediaList = colorMediaList|merge([mediaItem]) %}
        {% endif %}
    {% endfor %}
    {% set firstColorMedia = colorMediaList|first %}

    {# Main image: use first color media or fall back to cover #}
    {% set mainImageUrl = null %}
    {% if firstColorMedia and firstColorMedia.media %}
        {% set mainImageUrl = firstColorMedia.media.url %}
    {% elseif product.cover and product.cover.media %}
        {% set mainImageUrl = product.cover.media.url %}
    {% endif %}

    {# Get manufacturer and product name #}
    {% set manufacturerName = product.manufacturer.translated.name|default('') %}
    {% set productName = product.translated.name %}
    {% set fullTitle = manufacturerName ? manufacturerName ~ ' ' ~ productName : productName %}

    {# Format price Swiss style with CHF #}
    {% set priceValue = product.calculatedPrice.unitPrice %}
    {% set priceCents = ((priceValue * 100) % 100)|round %}
    {% set formattedPrice = priceCents == 0 ? priceValue|number_format(0, '.', "'") : priceValue|number_format(2, '.', "'") %}

    <div class="raven-buy-box-wrapper">
        {# LEFT: Main Product Image with Zoom #}
        <div class="raven-main-image-container">
            <div class="raven-main-image" id="raven-zoom-container">
                {% if mainImageUrl %}
                <img id="raven-main-product-image"
                     src="{{ mainImageUrl }}"
                     alt="{{ product.translated.name }}"
                     class="raven-product-img">
                {# Zoom Lens (hidden by default) #}
                <div id="raven-zoom-lens" class="raven-zoom-lens"></div>
                {# Zoomed Result Box #}
                <div id="raven-zoom-result" class="raven-zoom-result">
                    <img id="raven-zoom-result-img" src="{{ mainImageUrl }}" alt="Zoomed">
                </div>
                {% else %}
                {# Fallback placeholder #}
                <div class="raven-no-image">Kein Bild verfügbar</div>
                {% endif %}
            </div>
        </div>

        {# RIGHT: Product Info #}
        <div class="raven-buy-box">
            {# Manufacturer Name Label - Clickable with SEO URL #}
            {% if manufacturerName %}
                {% set manufacturerSlug = manufacturerName|lower|replace({' ': '-', '.': '', ',': '', 'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'}) %}
                <a href="/{{ manufacturerSlug }}" class="raven-category" style="text-decoration: none;">{{ manufacturerName }}</a>
            {% else %}
                <p class="raven-category">Produkt</p>
            {% endif %}

            {# Product Title #}
            <h1 class="raven-title">{{ fullTitle }}</h1>

            {# Price - Swiss Format with CHF prefix in RED #}
            <div class="raven-price">CHF {{ formattedPrice }}</div>

            {# Color Variants #}
            {% if colorMediaList|length > 0 %}
            <div class="raven-color-section">
                <p class="raven-color-label">
                    Farbe: <span id="selected-color-name" class="raven-color-value">Graphite Black</span>
                </p>
                <div class="raven-color-swatches">
                    {% set colorNames = ['Graphite Black', 'Flat Dark Earth', 'Northern Lights', 'Olive Drab Green', 'Sniper Grey'] %}
                    {% for media in colorMediaList %}
                    {% set colorIndex = loop.index0 %}
                    {% set colorName = colorNames[colorIndex]|default('Standard') %}
                    {% if media.media %}
                    <button class="raven-image-swatch {% if loop.first %}selected{% endif %}"
                            data-color-name="{{ colorName }}"
                            data-image-url="{{ media.media.url }}"
                            title="{{ colorName }}"
                            onclick="
                                document.getElementById('raven-main-product-image').src='{{ media.media.url }}';
                                document.getElementById('selected-color-name').textContent='{{ colorName }}';
                                document.querySelectorAll('.raven-image-swatch').forEach(el => el.classList.remove('selected'));
                                this.classList.add('selected');">
                        <img src="{{ media.media.url }}" alt="{{ colorName }}">
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Quantity and Add to Cart Form #}
            <form action="{{ path('frontend.checkout.line-item.add') }}"
                  method="post"
                  class="raven-buy-form buy-widget"
                  data-add-to-cart="true">
                <input type="hidden" name="redirectTo" value="frontend.cart.offcanvas">
                <input type="hidden" name="lineItems[{{ product.id }}][id]" value="{{ product.id }}">
                <input type="hidden" name="lineItems[{{ product.id }}][type]" value="product">
                <input type="hidden" name="lineItems[{{ product.id }}][referencedId]" value="{{ product.id }}">
                <input type="hidden" name="lineItems[{{ product.id }}][stackable]" value="1">
                <input type="hidden" name="lineItems[{{ product.id }}][removable]" value="1">

                {# Quantity Selector #}
                <div class="raven-quantity-row">
                    <button type="button" class="raven-qty-btn" onclick="let q = document.getElementById('raven-qty'); if(q.value > 1) q.value = parseInt(q.value) - 1;">−</button>
                    <input type="number" id="raven-qty" name="lineItems[{{ product.id }}][quantity]" value="1" min="1" max="{{ product.availableStock ?: 99 }}" class="raven-qty-input" readonly>
                    <button type="button" class="raven-qty-btn" onclick="let q = document.getElementById('raven-qty'); if(q.value < {{ product.availableStock ?: 99 }}) q.value = parseInt(q.value) + 1;">+</button>
                </div>

                {# Add to Cart Button #}
                <button type="submit" class="raven-add-to-cart-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" fill="currentColor">
                        <path d="M0 72C0 58.7 10.7 48 24 48L69.3 48C96.4 48 119.6 67.4 124.4 94L124.8 96L524.7 96C549.8 96 568.7 118.9 564 143.6L537.6 280.6C529.6 322 493.4 352 451.2 352L171.4 352L176.5 380.3C178.6 391.7 188.5 400 200.1 400L456 400C469.3 400 480 410.7 480 424C480 437.3 469.3 448 456 448L200.1 448C165.3 448 135.5 423.1 129.3 388.9L77.2 102.6C76.5 98.8 73.2 96 69.3 96L24 96C10.7 96 0 85.3 0 72zM162.6 304L451.2 304C470.4 304 486.9 290.4 490.5 271.6L514.9 144L133.5 144L162.6 304zM208 480C234.5 480 256 501.5 256 528C256 554.5 234.5 576 208 576C181.5 576 160 554.5 160 528C160 501.5 181.5 480 208 480zM432 480C458.5 480 480 501.5 480 528C480 554.5 458.5 576 432 576C405.5 576 384 554.5 384 528C384 501.5 405.5 480 432 480z"/>
                    </svg>
                    In den Warenkorb
                </button>
            </form>

            {# Description Section with See More #}
            {% if product.translated.description %}
            <div class="raven-description-section">
                <h2 class="raven-description-title">Beschreibung</h2>
                <div class="raven-description-wrapper" id="raven-desc-wrapper">
                    <div class="raven-description-text" id="raven-desc-content">
                        {{ product.translated.description|striptags }}
                    </div>
                    <div class="raven-description-fade" id="raven-desc-fade"></div>
                </div>
                <button type="button" class="raven-see-more-btn" id="raven-see-more-btn" style="display: none;">
                    <span id="raven-see-more-text">Mehr anzeigen</span>
                    <svg id="raven-see-more-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    {# ========== REVIEWS SECTION - Below main product grid ========== #}
    {% set reviews = product.productReviews|default([]) %}
    {% set reviewCount = reviews|length %}
    {% set totalPoints = 0 %}
    {% set star5 = 0 %}{% set star4 = 0 %}{% set star3 = 0 %}{% set star2 = 0 %}{% set star1 = 0 %}
    {% for review in reviews %}
        {% set totalPoints = totalPoints + review.points %}
        {% if review.points == 5 %}{% set star5 = star5 + 1 %}
        {% elseif review.points == 4 %}{% set star4 = star4 + 1 %}
        {% elseif review.points == 3 %}{% set star3 = star3 + 1 %}
        {% elseif review.points == 2 %}{% set star2 = star2 + 1 %}
        {% elseif review.points == 1 %}{% set star1 = star1 + 1 %}{% endif %}
    {% endfor %}
    {% set avgRating = reviewCount > 0 ? (totalPoints / reviewCount)|round(1) : 0 %}
    {% set fullStars = avgRating|round(0) %}

    <div class="raven-reviews-section" style="margin-top: 2rem;">
        <div class="raven-reviews-header">
            <h3 class="raven-reviews-title">Kundenbewertungen</h3>
            <button type="button" class="raven-write-review-btn" onclick="window.location.href='{{ path('frontend.account.login.page') }}';">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Bewertung schreiben
            </button>
        </div>

        {% if reviewCount > 0 %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
                <div class="raven-rating-summary">
                    <div class="raven-stars">
                        {% for i in 1..5 %}
                            <svg class="raven-star {% if i <= fullStars %}filled{% endif %}" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        {% endfor %}
                    </div>
                    <span class="raven-rating-value">{{ avgRating }}</span>
                    <span class="raven-review-count">({{ reviewCount }} Bewertung{% if reviewCount != 1 %}en{% endif %})</span>
                </div>
                <div class="raven-rating-breakdown">
                    <div class="raven-bar-row"><span class="raven-bar-label">5 Sterne</span><div class="raven-bar-bg"><div class="raven-bar-fill" style="width: {{ reviewCount > 0 ? (star5 / reviewCount * 100) : 0 }}%;"></div></div><span class="raven-bar-count">{{ star5 }}</span></div>
                    <div class="raven-bar-row"><span class="raven-bar-label">4 Sterne</span><div class="raven-bar-bg"><div class="raven-bar-fill" style="width: {{ reviewCount > 0 ? (star4 / reviewCount * 100) : 0 }}%;"></div></div><span class="raven-bar-count">{{ star4 }}</span></div>
                    <div class="raven-bar-row"><span class="raven-bar-label">3 Sterne</span><div class="raven-bar-bg"><div class="raven-bar-fill" style="width: {{ reviewCount > 0 ? (star3 / reviewCount * 100) : 0 }}%;"></div></div><span class="raven-bar-count">{{ star3 }}</span></div>
                    <div class="raven-bar-row"><span class="raven-bar-label">2 Sterne</span><div class="raven-bar-bg"><div class="raven-bar-fill" style="width: {{ reviewCount > 0 ? (star2 / reviewCount * 100) : 0 }}%;"></div></div><span class="raven-bar-count">{{ star2 }}</span></div>
                    <div class="raven-bar-row"><span class="raven-bar-label">1 Stern</span><div class="raven-bar-bg"><div class="raven-bar-fill" style="width: {{ reviewCount > 0 ? (star1 / reviewCount * 100) : 0 }}%;"></div></div><span class="raven-bar-count">{{ star1 }}</span></div>
                </div>
            </div>
            <div class="raven-reviews-list">
                {% for review in reviews|slice(0, 5) %}
                <div class="raven-review-item">
                    <div class="raven-review-header">
                        <div class="raven-review-stars">
                            {% for i in 1..5 %}<svg class="raven-star {% if i <= review.points %}filled{% endif %} small" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>{% endfor %}
                        </div>
                        <span class="raven-review-author">{{ review.externalUser|default(review.customer ? review.customer.firstName|first ~ '.' ~ review.customer.lastName|first ~ '.' : 'Kunde') }}</span>
                    </div>
                    {% if review.title %}<p class="raven-review-title"><strong>{{ review.title }}</strong></p>{% endif %}
                    <p class="raven-review-text">{{ review.content }}</p>
                    <span class="raven-review-date">{{ review.createdAt|date('d.m.Y') }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="raven-no-reviews">
            <div class="raven-no-reviews-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
            </div>
            <p class="raven-no-reviews-text">Noch keine Bewertungen</p>
            <p class="raven-no-reviews-subtext">Sei der Erste, der dieses Produkt bewertet!</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<style>
    /* Hide the default Shopware image gallery, product detail header, and other elements */
    .cms-element-image-gallery,
    .product-detail-tabs,
    .product-detail-description-container,
    .cms-element-product-name,
    .product-detail-name,
    .product-detail-headline {
        display: none !important;
    }

    /* Hide duplicate product name/title at top of page */
    .cms-section .cms-element-text h1,
    .product-detail-content > .cms-block:first-child {
        display: none !important;
    }

    /* No image fallback */
    .raven-no-image {
        color: #9CA3AF;
        font-size: 14px;
        text-align: center;
        padding: 4rem 2rem;
    }

    /* Make buy-box and parent containers full width */
    .cms-element-buy-box.raven-product-detail {
        grid-column: 1 / -1 !important;
        width: 100% !important;
    }

    /* Override Shopware's gallery+buybox layout to make buy-box full width */
    .cms-block-gallery-buybox {
        overflow: visible !important;
    }

    .cms-block-gallery-buybox .cms-block-container-row {
        display: block !important;
    }

    .cms-block-gallery-buybox .col-lg-7,
    .cms-block-gallery-buybox .product-detail-media {
        display: none !important;
    }

    .cms-block-gallery-buybox .col-lg-5,
    .cms-block-gallery-buybox .product-detail-buy {
        width: 100% !important;
        max-width: 100% !important;
        flex: 0 0 100% !important;
        padding: 0 !important;
    }

    /* Force parent CMS blocks to be full width */
    .cms-block-product-heading,
    .cms-section .col-12,
    .product-detail-content .cms-section,
    .product-detail-content .cms-block {
        max-width: 100% !important;
        width: 100% !important;
    }

    .product-detail-content .container,
    .cms-section-default.boxed {
        max-width: 1400px !important;
        width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
    }

    /* Main wrapper - two column grid */
    .raven-buy-box-wrapper {
        display: grid !important;
        grid-template-columns: minmax(400px, 1fr) minmax(350px, 1fr) !important;
        gap: 3rem !important;
        max-width: 1200px !important;
        margin: 0 auto !important;
        width: 100% !important;
    }

    /* Left: Product Image */
    .raven-main-image-container {
        min-height: 400px !important;
        min-width: 400px !important;
        width: 100% !important;
    }

    .raven-main-image {
        background: white !important;
        border-radius: 12px !important;
        padding: 2rem !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 400px !important;
        width: 100% !important;
    }

    .raven-product-img {
        width: 100% !important;
        height: auto !important;
        max-height: 450px !important;
        max-width: 100% !important;
        object-fit: contain !important;
    }

    /* Right: Product Info */
    .raven-buy-box {
        padding-top: 1rem;
    }

    /* Category label */
    .raven-category {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #6B7280;
        margin-bottom: 0.5rem;
    }

    /* Product title */
    .raven-title {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 2rem;
        line-height: 1.2;
        color: #111827;
        margin-bottom: 1rem;
    }

    /* Price - RED with CHF */
    .raven-price {
        font-family: 'Inter', sans-serif;
        color: #E53935;
        font-weight: 600;
        font-size: 24px;
        line-height: 1.2;
        font-variant-numeric: tabular-nums;
        margin-bottom: 1.5rem;
    }

    /* Color section */
    .raven-color-section {
        margin-bottom: 1.5rem;
    }

    .raven-color-label {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.75rem;
    }

    .raven-color-value {
        font-weight: 700;
    }

    /* Color swatches - horizontal row, all 5 in one line */
    .raven-color-swatches {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 10px;
    }

    /* Individual image swatch - smaller to fit 5 in a row */
    .raven-image-swatch {
        width: 70px;
        height: 70px;
        flex-shrink: 0;
        border-radius: 8px;
        border: 2px solid #E5E7EB;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden;
        background: white;
        padding: 4px;
    }

    .raven-image-swatch img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .raven-image-swatch:hover {
        transform: scale(1.05);
        border-color: #E9D68A;
    }

    .raven-image-swatch.selected {
        border-color: #F2C200 !important;
        border-width: 3px !important;
        box-shadow: 0 0 0 2px rgba(242, 194, 0, 0.2);
    }

    /* Quantity row */
    .raven-quantity-row {
        display: flex;
        align-items: center;
        gap: 0;
        margin-bottom: 1rem;
    }

    .raven-qty-btn {
        width: 40px;
        height: 40px;
        border: 1px solid #D1D5DB;
        border-radius: 6px;
        background: white;
        font-weight: 600;
        font-size: 1.25rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .raven-qty-btn:first-child {
        border-radius: 6px 0 0 6px;
    }

    .raven-qty-btn:last-child {
        border-radius: 0 6px 6px 0;
    }

    .raven-qty-btn:hover {
        background: #F3F4F6;
        border-color: #9CA3AF;
    }

    .raven-qty-input {
        width: 60px;
        height: 40px;
        border: 1px solid #D1D5DB;
        border-left: none;
        border-right: none;
        text-align: center;
        font-weight: 600;
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        line-height: 40px;
        padding: 0;
        -moz-appearance: textfield;
        -webkit-appearance: none;
        appearance: none;
    }
    .raven-qty-input::-webkit-outer-spin-button,
    .raven-qty-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Add to cart button */
    .raven-add-to-cart-btn {
        width: 100%;
        padding: 1rem 2rem;
        background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%);
        border: 1px solid #C59A0F;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        color: #111827;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .raven-add-to-cart-btn::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(180deg, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.25) 35%, rgba(255,255,255,0.00) 60%);
        pointer-events: none;
    }

    .raven-add-to-cart-btn:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .raven-add-to-cart-btn svg {
        width: 20px;
        height: 20px;
        position: relative;
        z-index: 1;
    }

    /* Description section */
    .raven-description-section {
        border-top: 1px solid #E5E7EB;
        padding-top: 1.5rem;
    }

    .raven-description-title {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1.25rem;
        color: #111827;
        margin-bottom: 0.75rem;
    }

    .raven-description-text {
        font-family: 'Inter', sans-serif;
        color: #374151;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    /* ========== SEE MORE STYLES ========== */
    .raven-description-wrapper {
        position: relative;
        max-height: 120px;
        overflow: hidden;
        transition: max-height 0.4s ease;
    }

    .raven-description-wrapper.expanded {
        max-height: 2000px;
    }

    .raven-description-fade {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .raven-description-wrapper.expanded .raven-description-fade {
        opacity: 0;
    }

    .raven-see-more-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid #D4A847;
        border-radius: 6px;
        color: #D4A847;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .raven-see-more-btn:hover {
        background: #D4A847;
        color: #1f2937;
    }

    .raven-see-more-btn svg {
        transition: transform 0.3s ease;
    }

    .raven-see-more-btn.expanded svg {
        transform: rotate(180deg);
    }

    /* ========== IMAGE ZOOM STYLES ========== */
    #raven-zoom-container {
        position: relative;
        cursor: crosshair;
    }

    .raven-zoom-lens {
        position: absolute;
        width: 120px;
        height: 120px;
        border: 3px solid #D4A847;
        border-radius: 50%;
        background: rgba(212, 168, 71, 0.15);
        pointer-events: none;
        display: none;
        z-index: 10;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .raven-zoom-result {
        position: absolute;
        top: 0;
        left: calc(100% + 20px);
        width: 350px;
        height: 350px;
        border: 2px solid #E5E7EB;
        border-radius: 12px;
        background: white;
        overflow: hidden;
        display: none;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .raven-zoom-result img {
        position: absolute;
        width: auto;
        height: auto;
        max-width: none;
    }

    @media (max-width: 1200px) {
        .raven-zoom-result {
            display: none !important;
        }
    }

    /* ========== RATINGS & REVIEWS STYLES ========== */
    .raven-reviews-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .raven-reviews-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .raven-reviews-title {
        font-family: 'Chakra Petch', sans-serif;
        font-weight: 700;
        font-size: 1.125rem;
        color: #111827;
        margin: 0;
    }

    .raven-write-review-btn {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.75rem;
        background: transparent;
        border: none;
        color: #D4A847;
        font-family: 'Inter', sans-serif;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s;
    }

    .raven-write-review-btn:hover {
        color: #B8942D;
    }

    .raven-rating-summary {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .raven-stars {
        display: flex;
        gap: 2px;
    }

    .raven-star {
        width: 20px;
        height: 20px;
        fill: #E5E7EB;
    }

    .raven-star.filled {
        fill: #F59E0B;
    }

    .raven-star.half {
        fill: url(#raven-half-star-grad);
    }

    .raven-star.small {
        width: 14px;
        height: 14px;
    }

    .raven-rating-value {
        font-family: 'Inter', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .raven-review-count {
        font-family: 'Inter', sans-serif;
        font-size: 0.8125rem;
        color: #6B7280;
    }

    .raven-rating-breakdown {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
        margin-bottom: 1rem;
    }

    .raven-bar-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #6B7280;
    }

    .raven-bar-label {
        width: 55px;
        flex-shrink: 0;
        font-family: 'Inter', sans-serif;
    }

    .raven-bar-bg {
        flex: 1;
        height: 6px;
        background: #E5E7EB;
        border-radius: 3px;
        overflow: hidden;
    }

    .raven-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #F59E0B, #D4A847);
        border-radius: 3px;
    }

    .raven-bar-count {
        width: 20px;
        text-align: right;
        flex-shrink: 0;
        font-family: 'Inter', sans-serif;
    }

    .raven-reviews-list {
        border-top: 1px solid #E5E7EB;
        padding-top: 1rem;
    }

    .raven-review-item {
        padding: 0.75rem 0;
    }

    .raven-review-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }

    .raven-review-stars {
        display: flex;
        gap: 1px;
    }

    .raven-review-author {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
    }

    .raven-review-verified {
        font-family: 'Inter', sans-serif;
        font-size: 0.6875rem;
        color: #16A34A;
        background: #DCFCE7;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
    }

    .raven-review-text {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: #4B5563;
        line-height: 1.5;
        margin: 0;
    }

    .raven-review-date {
        font-family: 'Inter', sans-serif;
        font-size: 0.75rem;
        color: #9CA3AF;
        display: block;
        margin-top: 0.375rem;
    }

    .raven-review-title {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: #111827;
        margin: 0 0 0.25rem 0;
    }

    /* No Reviews State */
    .raven-no-reviews {
        text-align: center;
        padding: 2rem 1rem;
    }

    .raven-no-reviews-icon {
        color: #D1D5DB;
        margin-bottom: 1rem;
    }

    .raven-no-reviews-text {
        font-family: 'Inter', sans-serif;
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin: 0 0 0.25rem 0;
    }

    .raven-no-reviews-subtext {
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: #9CA3AF;
        margin: 0;
    }

    /* Show All Reviews Link */
    .raven-show-all-reviews {
        display: inline-block;
        margin-top: 1rem;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: #D4A847;
        text-decoration: none;
        font-weight: 500;
    }

    .raven-show-all-reviews:hover {
        color: #B8942D;
        text-decoration: underline;
    }

    /* Hide default Shopware elements */
    .raven-buy-box .product-detail-price-container,
    .raven-buy-box .product-detail-tax-container,
    .raven-buy-box .product-detail-ordernumber-container,
    .cms-element-buy-box .product-detail-ordernumber-container {
        display: none !important;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .raven-buy-box-wrapper {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .raven-title {
            font-size: 1.5rem;
        }

        .raven-image-swatch {
            width: 60px;
            height: 60px;
        }

        .raven-reviews-section {
            margin-top: 1rem;
        }
    }

    /* ========== REVIEW MODAL STYLES ========== */
    .raven-review-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .raven-review-modal-content {
        background: white;
        border-radius: 16px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-20px) scale(0.95); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .raven-review-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid #E5E7EB;
    }

    .raven-review-modal-header h3 {
        font-family: 'Chakra Petch', sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
    }

    .raven-review-modal-close {
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        color: #6B7280;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .raven-review-modal-close:hover {
        background: #F3F4F6;
        color: #111827;
    }

    .raven-review-form {
        padding: 1.5rem;
    }

    .raven-form-group {
        margin-bottom: 1.25rem;
    }

    .raven-form-group label {
        display: block;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .raven-form-group label .required {
        color: #EF4444;
    }

    .raven-form-group input[type="text"],
    .raven-form-group input[type="email"],
    .raven-form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        font-family: 'Inter', sans-serif;
        font-size: 0.9375rem;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        transition: all 0.2s;
        background: white;
    }

    .raven-form-group input:focus,
    .raven-form-group textarea:focus {
        outline: none;
        border-color: #D4A847;
        box-shadow: 0 0 0 3px rgba(212, 168, 71, 0.15);
    }

    .raven-form-group textarea {
        resize: vertical;
        min-height: 100px;
    }

    .raven-char-count {
        display: block;
        text-align: right;
        font-size: 0.75rem;
        color: #9CA3AF;
        margin-top: 0.25rem;
    }

    .raven-form-hint {
        display: block;
        font-size: 0.75rem;
        color: #9CA3AF;
        margin-top: 0.25rem;
    }

    /* Star Rating Input */
    .raven-star-rating-input {
        display: flex;
        gap: 0.25rem;
    }

    .raven-star-btn {
        background: none;
        border: none;
        padding: 0.25rem;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .raven-star-btn:hover {
        transform: scale(1.2);
    }

    .raven-star-btn svg {
        width: 32px;
        height: 32px;
        fill: #E5E7EB;
        transition: fill 0.2s;
    }

    .raven-star-btn.active svg,
    .raven-star-btn:hover svg {
        fill: #F59E0B;
    }

    /* Form Actions */
    .raven-form-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #E5E7EB;
    }

    .raven-btn-cancel {
        padding: 0.75rem 1.25rem;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6B7280;
        background: white;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .raven-btn-cancel:hover {
        background: #F3F4F6;
        border-color: #9CA3AF;
    }

    .raven-btn-submit {
        padding: 0.75rem 1.5rem;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        font-weight: 600;
        color: #111827;
        background: linear-gradient(to top, #F2B90D 12%, #F6CE55 88%);
        border: 1px solid #C59A0F;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .raven-btn-submit:hover {
        box-shadow: 0 4px 12px rgba(212, 168, 71, 0.4);
    }

    .raven-btn-submit:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .raven-btn-submit .btn-loading .spinner {
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Review Message */
    .raven-review-message {
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .raven-review-message.success {
        background: #DCFCE7;
        color: #166534;
        border: 1px solid #BBF7D0;
    }

    .raven-review-message.error {
        background: #FEE2E2;
        color: #991B1B;
        border: 1px solid #FECACA;
    }

    @media (max-width: 480px) {
        .raven-review-modal-content {
            max-height: 100vh;
            border-radius: 0;
        }

        .raven-form-actions {
            flex-direction: column;
        }

        .raven-btn-cancel,
        .raven-btn-submit {
            width: 100%;
            justify-content: center;
        }
    }
</style>

{# SVG Gradient Definition for Half Stars #}
<svg style="width:0;height:0;position:absolute;" aria-hidden="true" focusable="false">
    <defs>
        <linearGradient id="raven-half-star-grad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="50%" style="stop-color:#F59E0B;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#E5E7EB;stop-opacity:1" />
        </linearGradient>
    </defs>
</svg>

<script>
    // ========== IMAGE ZOOM FUNCTIONALITY ==========
    (function() {
        function initImageZoom() {
            const container = document.getElementById('raven-zoom-container');
            const mainImage = document.getElementById('raven-main-product-image');
            const lens = document.getElementById('raven-zoom-lens');
            const result = document.getElementById('raven-zoom-result');
            const resultImg = document.getElementById('raven-zoom-result-img');

            if (!container || !mainImage || !lens || !result || !resultImg) return;

            const zoomLevel = 2.5;
            let isActive = false;

            function moveLens(e) {
                if (!isActive) return;
                e.preventDefault();

                const rect = mainImage.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;

                const lensHalfW = lens.offsetWidth / 2;
                const lensHalfH = lens.offsetHeight / 2;

                x = Math.max(lensHalfW, Math.min(x, rect.width - lensHalfW));
                y = Math.max(lensHalfH, Math.min(y, rect.height - lensHalfH));

                lens.style.left = (x - lensHalfW + (rect.left - containerRect.left)) + 'px';
                lens.style.top = (y - lensHalfH + (rect.top - containerRect.top)) + 'px';

                const bgX = -(x * zoomLevel - result.offsetWidth / 2);
                const bgY = -(y * zoomLevel - result.offsetHeight / 2);

                resultImg.style.width = (rect.width * zoomLevel) + 'px';
                resultImg.style.height = (rect.height * zoomLevel) + 'px';
                resultImg.style.left = bgX + 'px';
                resultImg.style.top = bgY + 'px';
            }

            function showZoom() {
                if (window.innerWidth < 1200) return;
                isActive = true;
                lens.style.display = 'block';
                result.style.display = 'block';
            }

            function hideZoom() {
                isActive = false;
                lens.style.display = 'none';
                result.style.display = 'none';
            }

            container.addEventListener('mouseenter', showZoom);
            container.addEventListener('mouseleave', hideZoom);
            container.addEventListener('mousemove', moveLens);

            // Update zoom image when color variant changes
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'src') {
                        resultImg.src = mainImage.src;
                    }
                });
            });
            observer.observe(mainImage, { attributes: true });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initImageZoom);
        } else {
            initImageZoom();
        }
    })();

    // ========== SEE MORE FUNCTIONALITY ==========
    (function() {
        function initSeeMore() {
            const wrapper = document.getElementById('raven-desc-wrapper');
            const content = document.getElementById('raven-desc-content');
            const fade = document.getElementById('raven-desc-fade');
            const btn = document.getElementById('raven-see-more-btn');
            const btnText = document.getElementById('raven-see-more-text');

            if (!wrapper || !content || !btn) return;

            const maxHeight = 120;
            const contentHeight = content.scrollHeight;

            if (contentHeight > maxHeight + 20) {
                btn.style.display = 'inline-flex';

                btn.addEventListener('click', function() {
                    const isExpanded = wrapper.classList.contains('expanded');

                    if (isExpanded) {
                        wrapper.classList.remove('expanded');
                        btn.classList.remove('expanded');
                        btnText.textContent = 'Mehr anzeigen';
                        wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    } else {
                        wrapper.classList.add('expanded');
                        btn.classList.add('expanded');
                        btnText.textContent = 'Weniger anzeigen';
                    }
                });
            } else {
                btn.style.display = 'none';
                if (fade) fade.style.display = 'none';
                wrapper.style.maxHeight = 'none';
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSeeMore);
        } else {
            initSeeMore();
        }
    })();

    // ========== REVIEW FORM FUNCTIONALITY ==========
    // Star rating selection
    let selectedRating = 0;

    function setReviewRating(rating) {
        selectedRating = rating;
        document.getElementById('raven-review-points').value = rating;

        // Update star buttons visual state
        const starBtns = document.querySelectorAll('.raven-star-btn');
        starBtns.forEach((btn, index) => {
            if (index < rating) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    (function() {
        function initReviewForm() {
            const modal = document.getElementById('raven-review-modal');
            const form = document.getElementById('raven-review-form');
            const textarea = document.getElementById('raven-review-content');
            const charCount = document.getElementById('raven-char-current');
            const messageBox = document.getElementById('raven-review-message');
            const submitBtn = document.getElementById('raven-submit-review');

            if (!modal || !form) return;

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            });

            // Character count for textarea
            if (textarea && charCount) {
                textarea.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Validate rating
                if (!selectedRating) {
                    showMessage('Bitte wählen Sie eine Bewertung (1-5 Sterne)', 'error');
                    return;
                }

                // Get form data
                const productId = form.querySelector('[name="productId"]').value;
                const title = form.querySelector('[name="title"]').value.trim();
                const content = form.querySelector('[name="content"]').value.trim();
                const name = form.querySelector('[name="name"]').value.trim();
                const email = form.querySelector('[name="email"]').value.trim();

                // Validate
                if (!title || !content || !name || !email) {
                    showMessage('Bitte füllen Sie alle Pflichtfelder aus', 'error');
                    return;
                }

                if (content.length < 20) {
                    showMessage('Ihre Bewertung muss mindestens 20 Zeichen lang sein', 'error');
                    return;
                }

                // Show loading state
                setLoading(true);

                try {
                    // Submit to Shopware Store API
                    const response = await fetch('/store-api/product/' + productId + '/review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'sw-access-key': document.querySelector('meta[name="sw-access-key"]')?.content || ''
                        },
                        body: JSON.stringify({
                            title: title,
                            content: content,
                            points: selectedRating,
                            name: name,
                            email: email
                        })
                    });

                    if (response.ok || response.status === 204) {
                        showMessage('Vielen Dank für Ihre Bewertung! Sie wird nach Prüfung veröffentlicht.', 'success');
                        form.reset();
                        selectedRating = 0;
                        document.querySelectorAll('.raven-star-btn').forEach(btn => btn.classList.remove('active'));
                        if (charCount) charCount.textContent = '0';

                        // Close modal after 2 seconds
                        setTimeout(() => {
                            modal.style.display = 'none';
                            messageBox.style.display = 'none';
                        }, 2500);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.errors?.[0]?.detail || 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.';
                        showMessage(errorMsg, 'error');
                    }
                } catch (error) {
                    console.error('Review submission error:', error);
                    showMessage('Verbindungsfehler. Bitte überprüfen Sie Ihre Internetverbindung.', 'error');
                } finally {
                    setLoading(false);
                }
            });

            function showMessage(text, type) {
                messageBox.textContent = text;
                messageBox.className = 'raven-review-message ' + type;
                messageBox.style.display = 'block';
            }

            function setLoading(loading) {
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoading = submitBtn.querySelector('.btn-loading');

                if (loading) {
                    submitBtn.disabled = true;
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'flex';
                } else {
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                }
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initReviewForm);
        } else {
            initReviewForm();
        }
    })();
</script>
{% endblock %}
